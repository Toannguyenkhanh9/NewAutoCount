<div class="ac-page">
  <!-- ================== LIST ================== -->
  <ng-container *ngIf="!showForm">
    <div class="ac-card">
      <!-- ============ HEADER ============ -->
      <div class="ac-page-header">
        <div>
          <div class="ac-page-title">Debit Note Entry</div>
          <div class="ac-page-subtitle">
            Record and manage debit notes and their payment history.
          </div>
        </div>

        <div class="ac-page-toolbar" role="toolbar">
          <input
            class="ac-form-control ac-page-search"
            type="text"
            [(ngModel)]="q"
            placeholder="Search DN no / company name."
          />

          <button type="button" class="ac-btn ac-btn-primary" (click)="newInvoice()">
            <span class="ico plus"></span>
            New
          </button>
          <button type="button" class="ac-btn" [disabled]="!selected" (click)="editInvoice()">
            <span class="ico edit"></span>
            Edit
          </button>

          <button
            type="button"
            class="ac-btn ac-btn-danger"
            [disabled]="!selected"
            (click)="openDeleteInvoiceConfirm()"
          >
            <span class="ico trash"></span>
            Delete
          </button>
        </div>
      </div>

      <!-- ============ LIST + HISTORY ============ -->
      <div class="list-shell">
        <!-- Main grid -->
        <div class="ac-card ac-card-no-padding main-grid">
          <div class="ac-tablewrap">
            <table class="ac-table">
              <thead>
                <tr>
                  <th class="ac-text-left" (click)="setSort('docDate')">DN No</th>
                  <th class="ac-text-left" (click)="setSort('docNo')">Date</th>
                  <th class="ac-text-left" (click)="setSort('debtor')">Company Name</th>
                  <th class="ac-text-left">Description</th>
                  <th class="ac-text-right">Total</th>
                  <th class="ac-text-right">Outstanding</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="let inv of paged"
                  (click)="toggleSelect(inv)"
                  [class.selected]="selected === inv"
                  [class.overdue]="isOverdue(inv)"
                >
                  <td>{{ inv.docNo }}</td>
                  <td>{{ inv.docDate }}</td>
                  <td>{{ inv.debtor }} â€” {{ inv.debtorName }}</td>
                  <td class="cut">{{ inv.description || "-" }}</td>
                  <td class="ac-text-right">{{ inv.grandTotal | number : "1.2-2" }}</td>
                  <td class="ac-text-right">{{ inv.outstanding | number : "1.2-2" }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      <!-- ============ PAGER ============ -->
      <div class="account-type-footer">
        <div class="account-type-rec">Total Records: {{ filtered.length }}</div>

        <div class="account-type-pager">
          <button class="ac-btn ac-btn-ghost account-type-pg-btn" [disabled]="page === 1" (click)="goFirst()">
            &laquo;
          </button>
          <button class="ac-btn ac-btn-ghost account-type-pg-btn" [disabled]="page === 1" (click)="goPrev()">
            &lsaquo;
          </button>

          <span class="account-type-pg-label">Page {{ page }} / {{ totalPages }}</span>

          <button class="ac-btn ac-btn-ghost account-type-pg-btn" [disabled]="page === totalPages" (click)="goNext()">
            &rsaquo;
          </button>
          <button class="ac-btn ac-btn-ghost account-type-pg-btn" [disabled]="page === totalPages" (click)="goLast()">
            &raquo;
          </button>
        </div>
      </div>
        <!-- Payment history -->
        <div class="ac-card ac-card-no-padding payment-panel"  *ngIf="selected">
          <div class="pp-head">
            <div class="pp-title">
              Payment History
              <ng-container *ngIf="selected">&nbsp;â€”&nbsp;<b>{{ selected.docNo }}</b></ng-container>
            </div>
          </div>

          <div class="pp-body">
            <div class="ac-tablewrap">
              <table class="ac-table ac-table-sm">
                <colgroup>
                  <col style="width: 12%" />
                  <col style="width: 20%" />
                  <col style="width: 42%" />
                  <col style="width: 13%" />
                  <col style="width: 13%" />
                </colgroup>
                <thead>
                  <tr>
                    <th class="ac-text-left" style="width: 90px">Type</th>
                    <th class="ac-text-left" style="width: 120px">No.</th>
                    <th class="ac-text-left">Description</th>
                    <th class="ac-text-left" style="width: 120px">Date</th>
                    <th class="ac-text-right" style="width: 140px">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let p of paymentHistory">
                    <td>{{ p.type }}</td>
                    <td>{{ p.no }}</td>
                    <td class="cut">{{ p.description || "-" }}</td>
                    <td>{{ p.date }}</td>
                    <td class="ac-text-right">{{ p.amount | number : "1.2-2" }}</td>
                  </tr>
                  <tr *ngIf="!paymentHistory.length">
                    <td colspan="5" class="ac-text-center ac-text-muted">â€” No payment â€”</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>


    </div>
  </ng-container>

  <!-- ================== FULL PAGE FORM ================== -->
  <ng-container *ngIf="showForm">
    <div class="inv-form">
      <div class="inv-header">
        <div>
          <h2 class="inv-title">
            {{
              formMode === 'new'
                ? 'New Debit Note'
                : formMode === 'edit'
                ? 'Edit Debit Note'
                : 'View Debit Note'
            }}
            <ng-container *ngIf="formMode !== 'new' && invForm?.value?.docNo">
              &nbsp;â€”&nbsp;{{ invForm.value.docNo }}
            </ng-container>
          </h2>
          <p class="inv-subtitle">Record and manage debit notes.</p>
        </div>
      </div>

      <form [formGroup]="invForm" class="inv-body">
        <div class="inv-body-inner">
          <!-- HEADER GRID -->
          <div class="inv-header-grid">
            <!-- Debtor -->
            <label class="inv-field inv-field-contact">
              <span class="inv-label">Contact</span>

              <div class="inv-contact-input ac-input-prefix-group">
                <span class="ac-input-prefix-icon">
                  <lucide-icon name="user" [size]="15" color="#111827"></lucide-icon>
                </span>

                <select class="ac-form-control" formControlName="debtor" (change)="onDebtorChanged()" [disabled]="formMode === 'view'">
                  <option value="">Select debtor...</option>
                  <option *ngFor="let d of debtors" [ngValue]="d.debtorAccount">
                    {{ d.debtorAccount }} â€” {{ d.companyName }}
                  </option>
                </select>

                <button
                  type="button"
                  class="inv-contact-search"
                  (click)="openDebtorDropdown()"
                  title="Search debtors"
                  aria-label="Search debtors"
                  [disabled]="formMode === 'view'"
                >
                  <lucide-icon name="search" [size]="13" color="#111827"></lucide-icon>
                </button>
              </div>

              <div class="inv-error" *ngIf="isInvalid('debtor')">Please select a debtor.</div>
            </label>

            <!-- DN No -->
            <label class="inv-field">
              <span class="inv-label">Debit Note No</span>
              <div class="ac-input-prefix-group">
                <span class="ac-input-prefix-icon">
                  <lucide-icon name="hash" [size]="13" color="#111827"></lucide-icon>
                </span>
                <input
                  class="ac-form-control"
                  formControlName="docNo"
                  [readonly]="invForm.value.autoNumbering || formMode !== 'new'"
                  placeholder="&lt;&lt;new&gt;&gt;"
                  [class.invalid]="isInvalid('docNo')"
                />
              </div>
              <div class="inv-error" *ngIf="isInvalid('docNo')">
                <ng-container *ngIf="invForm.get('docNo')?.errors?.['pattern']">
                  Only letters, numbers, '-', '_' and '/' are allowed.
                </ng-container>
                <ng-container *ngIf="invForm.get('docNo')?.errors?.['duplicate']">
                  This debit note number already exists.
                </ng-container>
                <ng-container *ngIf="invForm.get('docNo')?.errors?.['required']">
                  Debit note number is required.
                </ng-container>
              </div>
            </label>
                        <!-- Is Debit Journal -->
            <label class="inv-field">
              <span class="inv-label">&nbsp;</span>
              <div class="inv-checkline">
                <input type="checkbox" formControlName="isDebitJournal" [disabled]="formMode === 'view'" />
                <span>Is Debit Journal</span>
              </div>
            </label>

            <!-- Issue date -->
            <label class="inv-field">
              <span class="inv-label">Date</span>
              <div class="ac-input-prefix-group">
                <span class="ac-input-prefix-icon">
                  <lucide-icon name="calendar" [size]="15" color="#111827"></lucide-icon>
                </span>
                <input
                  type="date"
                  class="ac-form-control"
                  formControlName="docDate"
                  (change)="recalcDue()"
                  [readonly]="formMode === 'view'"
                />
              </div>
            </label>

            <!-- Due date -->
            <label class="inv-field inv-field-due">
              <span class="inv-label">Due Date</span>
              <div class="ac-input-prefix-group">
                <div class="inv-due-input">
                  <span class="ac-input-prefix-icon"><lucide-icon name="calendar" [size]="15"
                      color="#111827"></lucide-icon></span>
                  <!-- Bá»Ž readonly cá»‘ Ä‘á»‹nh, chá»‰ readonly khi view -->
                  <input style="padding-left: 32px;" type="date" class="ac-form-control" formControlName="dueDate"
                    [readonly]="formMode === 'view'" />

                  <!-- nÃºt má»Ÿ menu ngÃ y nhanh -->
                  <button type="button" class="inv-due-shortcut-btn" (click)="toggleDueShortcuts($event)"
                    aria-label="Quick due date">
                    â‹¯
                  </button>
                </div>
              </div>
              <!-- menu cÃ¡c lá»±a chá»n ngÃ y nhanh -->
              <div class="inv-due-shortcuts" *ngIf="showDueShortcuts" (click)="$event.stopPropagation()">
                <button type="button" (click)="applyDueShortcut('IN_7')">In 7 days</button>
                <button type="button" (click)="applyDueShortcut('IN_14')">In 14 days</button>
                <button type="button" (click)="applyDueShortcut('FIRST_NEXT')">
                  1st of next month
                </button>
                <button type="button" (click)="applyDueShortcut('TWENTIETH_NEXT')">
                  20th of next month
                </button>
                <button type="button" (click)="applyDueShortcut('END_NEXT')">
                  End of next month
                </button>

                <button type="button" class="reset" (click)="applyDueShortcut('RESET')">
                  Reset to default due date
                </button>
              </div>
            </label>

            <!-- Journal type -->
            <label class="inv-field">
              <span class="inv-label">Journal Type</span>
              <div class="inv-contact-input ac-input-prefix-group">
                <span class="ac-input-prefix-icon">
                  <lucide-icon name="hash" [size]="13" color="#111827"></lucide-icon>
                </span>

                <select class="ac-form-control" formControlName="journalType" [disabled]="formMode === 'view'">
                  <option *ngFor="let j of journalTypes" [ngValue]="j.typeCode">
                    {{ j.typeCode }}
                  </option>
                </select>
              </div>
            </label>

            <!-- DN Type -->
            <label class="inv-field">
              <span class="inv-label">DN Type</span>
              <div class="inv-contact-input ac-input-prefix-group">
                <span class="ac-input-prefix-icon">
                  <lucide-icon name="hash" [size]="13" color="#111827"></lucide-icon>
                </span>

                <select class="ac-form-control" formControlName="dnType" [disabled]="formMode === 'view'">
                  <option *ngFor="let x of dnTypes" [ngValue]="x">{{ x }}</option>
                </select>
              </div>
            </label>

            </div>
            <!-- Reference -->
            <label class="inv-field wide">
              <span class="inv-label">Description</span>
              <div class="ac-input-prefix-group">
                <span class="ac-input-prefix-icon">
                  <lucide-icon name="hash" [size]="13" color="#111827"></lucide-icon>
                </span>
                <input class="ac-form-control" formControlName="ref2" [readonly]="formMode === 'view'" />
              </div>
            </label>


          <br />

          <!-- TO BOX -->
          <div class="inv-to-box">
            <div class="to-title">To:</div>
            <textarea class="to-text" rows="3" readonly [value]="debtorToText"></textarea>
          </div>

          <br />

          <!-- LINES -->
          <div class="inv-lines">
            <div class="inv-lines-tablewrap">
              <table class="ac-table-addnew inv-lines-table">
                <thead>
                  <tr>
                    <th style="width: 240px">Credit A/C</th>
                    <th>Description</th>
                    <th class="ac-text-right" style="width: 220px">Amount</th>
                    <th style="width: 44px"></th>
                  </tr>
                </thead>

                <tbody *ngIf="invForm">
                  <tr
                    *ngFor="
                      let fg of acLineGroups;
                      let i = index;
                      trackBy: trackByIndex
                    "
                    [formGroup]="fg"
                  >
                    <td>
                        <input
                          class="ac-form-control"
                          formControlName="accNo"
                          [attr.list]="'accnos-' + i"
                          (focus)="prepAccNoSuggestions(i)"
                          (input)="prepAccNoSuggestions(i)"
                          [readonly]="formMode === 'view'"
                        />

                      <datalist [id]="'accnos-' + i">
                        <option *ngFor="let s of accNoSugs[i]" [value]="s"></option>
                      </datalist>
                    </td>

                    <td>
                        <input
                          class="ac-form-control"
                          formControlName="lineDesc"
                          [readonly]="formMode === 'view'"
                        />
                    </td>

                    <td class="ac-text-right">
                        <input
                          class="ac-form-control ac-text-right"
                          appAmount
                          formControlName="amount"
                          [allowNegative]="false"
                          (input)="recalcTotals()"
                          [readonly]="formMode === 'view'"
                        />
                    </td>

                    <td class="ac-text-center inv-line-remove">
                      <button
                        type="button"
                        class="ac-btn ac-btn-icon-danger"
                        (click)="removeAcLine(i)"
                        [disabled]="formMode === 'view'"
                        title="Remove"
                      >
                        ðŸ—‘
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="inv-lines-bottom">
              <div class="inv-addrow-wrapper" *ngIf="formMode !== 'view'">
                <div class="inv-addrow-split" [class.open]="showAddRowMenu">
                  <!-- nÃºt chÃ­nh: thÃªm 1 dÃ²ng -->
                  <button type="button" class="ac-btn ac-btn-primary inv-addrow-main" (click)="addRows(1)">
                    Add row
                  </button>

                  <!-- nÃºt caret má»Ÿ menu -->
                  <button type="button" class="ac-btn ac-btn-primary inv-addrow-caret" (click)="toggleAddRowMenu()">
                    â–¾
                  </button>

                  <!-- menu chá»n sá»‘ dÃ²ng -->
                  <div class="inv-addrow-menu" *ngIf="showAddRowMenu">
                    <button type="button" class="inv-addrow-menu-item" (click)="addRows(5); closeAddRowMenu()">
                      Add 5 rows
                    </button>
                    <button type="button" class="inv-addrow-menu-item" (click)="addRows(10); closeAddRowMenu()">
                      Add 10 rows
                    </button>
                    <button type="button" class="inv-addrow-menu-item" (click)="addRows(20); closeAddRowMenu()">
                      Add 20 rows
                    </button>
                  </div>
                </div>
              </div>

              <div class="inv-totals">
                <div class="row">
                  <div class="label">Total</div>
                  <div class="value">
                    {{ invForm.value.grandTotal | number : "1.2-2" }}
                  </div>
                </div>
                <div class="ac-amount-summary-divider-main"></div>
                <div class="row total">
                  <div class="label">Net Total</div>
                  <div class="value">
                    {{ invForm.value.grandTotal | number : "1.2-2" }}
                  </div>
                </div>
                <div class="row total">
                  <div class="label">Outstanding</div>
                  <div class="value">
                    {{ invForm.value.outstanding | number : "1.2-2" }}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- FOOTER STICKY -->
        <div class="inv-footer">
          <label class="chk">
            <input type="checkbox" formControlName="continueNew" />
            <span>After save, proceed with new debit note entry</span>
          </label>

          <button type="button" class="ac-btn ac-btn-ghost" (click)="closeForm()">
            Cancel
          </button>

          <button
            *ngIf="formMode !== 'view'"
            type="button"
            class="ac-btn ac-btn-primary"
            (click)="saveInvoice()"
            [disabled]="invForm.invalid"
          >
            {{ formMode === "new" ? "Create" : "Save" }}
          </button>
        </div>
      </form>
    </div>
  </ng-container>

  <!-- ================== MODALS (GIá»® NGUYÃŠN) ================== -->
  <!-- Find dialog -->
  <div class="dialog" *ngIf="showFind">
    <div class="dialog-panel">
      <div class="dialog-title">
        Find Invoice
        <button class="x" (click)="showFind = false">âœ•</button>
      </div>
      <div class="dialog-body">
        <form [formGroup]="findForm" class="grid3">
          <label>From <input type="date" formControlName="from" /></label>
          <label>To <input type="date" formControlName="to" /></label>
          <label
            >Debtor
            <select formControlName="debtor">
              <option value="">Any</option>
              <option *ngFor="let d of debtors" [value]="d.debtorAccount">
                {{ d.debtorAccount }} â€” {{ d.companyName }}
              </option>
            </select>
          </label>
          <label
            >Status
            <select formControlName="status">
              <option value="all">All</option>
              <option>OPEN</option>
              <option>POSTED</option>
              <option>VOID</option>
            </select>
          </label>
          <label
            >Min Amount <input type="number" step="0.01" formControlName="min"
          /></label>
          <label
            >Max Amount <input type="number" step="0.01" formControlName="max"
          /></label>
        </form>

        <div class="dialog-foot">
          <button class="btn btn-primary" (click)="runFind()">Search</button>
        </div>

        <table *ngIf="findResults.length">
          <thead>
            <tr>
              <th>Date</th>
              <th>Doc No</th>
              <th>Debtor</th>
              <th class="r">Total</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of findResults">
              <td>{{ r.docDate }}</td>
              <td>{{ r.docNo }}</td>
              <td>{{ r.debtor }} â€” {{ r.debtorName }}</td>
              <td class="r">{{ r.grandTotal | number : "1.2-2" }}</td>
              <td>
                <button class="btn btn-primary" (click)="pickFromFind(r)">
                  Select
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Print Listing -->
  <div class="dialog" *ngIf="showPrint">
    <div class="dialog-panel">
      <div class="dialog-title">
        A/R Invoice Listing
        <button class="x" (click)="showPrint = false">âœ•</button>
      </div>
      <div class="dialog-body">
        <form [formGroup]="printForm" class="grid4">
          <label>From <input type="date" formControlName="from" /></label>
          <label>To <input type="date" formControlName="to" /></label>
          <label
            >Debtor
            <select formControlName="debtor">
              <option value="">Any</option>
              <option *ngFor="let d of debtors" [value]="d.debtorAccount">
                {{ d.debtorAccount }} â€” {{ d.companyName }}
              </option>
            </select>
          </label>
          <label
            >Status
            <select formControlName="status">
              <option value="all">All</option>
              <option>OPEN</option>
              <option>POSTED</option>
              <option>VOID</option>
            </select>
          </label>
          <label
            >Sort by
            <select formControlName="sort">
              <option value="docDate">Date</option>
              <option value="docNo">Doc No</option>
              <option value="debtor">Debtor</option>
              <option value="grandTotal">Amount</option>
            </select>
          </label>
        </form>

        <div class="dialog-actions">
          <button class="btn primary" (click)="showPreview = true">
            Preview
          </button>
        </div>

        <div class="preview" *ngIf="showPreview">
          <h3>A/R Invoice Listing (Preview)</h3>
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Doc No</th>
                <th>Debtor</th>
                <th class="r">Sub Total</th>
                <th class="r">Tax</th>
                <th class="r">Total</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let x of buildListing()">
                <td>{{ x.docDate }}</td>
                <td>{{ x.docNo }}</td>
                <td>{{ x.debtor }} â€” {{ x.debtorName }}</td>
                <td class="r">{{ x.subTotal | number : "1.2-2" }}</td>
                <td class="r">{{ x.taxTotal | number : "1.2-2" }}</td>
                <td class="r">{{ x.grandTotal | number : "1.2-2" }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Debtor picker -->
  <div class="dialog" *ngIf="showDebtorPicker">
    <div class="dialog-panel ac-card-no-padding ac-dialog-panel-lg">
      <div class="ac-dialog-header">
        <span>Select Debtor</span>
        <button class="ac-dialog-close" type="button" (click)="showDebtorPicker = false">
          Ã—
        </button>
      </div>
      <div class="ac-dialog-body">
        <div class="ac-page-toolbar" style="padding: 0 0 8px 0; gap: 8px; display: flex">
          <input class="ac-form-control ac-page-search" [(ngModel)]="debtorQuery" (ngModelChange)="filterDebtors()"
            placeholder="Search Debtor A/C, Company Name..." />
        </div>
        <div class="ac-tablewrap">
          <table class="ac-table ac-table-sm">
            <thead>
              <tr>
                <th>Debtor A/C</th>
                <th>Company Name</th>
                <th>Bill Address</th>
                <th>Phone</th>
                <th style="width: 90px"></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let d of debtorFiltered" (dblclick)="pickDebtor(d)">
                <td>{{ d.debtorAccount }}</td>
                <td>{{ d.companyName }}</td>
                <td class="cut">{{ d.billAddress }}</td>
                <td>{{ d.phone }}</td>
                <td>
                  <button type="button" class="ac-btn ac-btn-primary" (click)="pickDebtor(d)">
                    Select
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="ac-dialog-backdrop" *ngIf="showDeleteInvoiceConfirm">
    <div class="ac-card-no-padding ac-dialog-panel-sm" role="dialog" aria-modal="true" style="min-width: 360px">
      <div class="ac-dialog-header">
        <span>Delete Invoice</span>
        <button class="ac-dialog-close" type="button" (click)="closeDeleteInvoiceConfirm()" aria-label="Close">
          Ã—
        </button>
      </div>

      <div class="ac-dialog-body">
        <p>
          Are you sure you want to delete
          <b>{{ selected?.docNo || 'this invoice' }}</b>?
        </p>
      </div>

      <div class="ac-dialog-footer">
        <button type="button" class="ac-btn ac-btn-ghost" (click)="closeDeleteInvoiceConfirm()">
          Cancel
        </button>
        <button type="button" class="ac-btn ac-btn-danger" (click)="confirmDeleteInvoice()">
          Delete
        </button>
      </div>
    </div>
  </div>
<!-- Success popup -->
  <div class="ac-dialog-backdrop" *ngIf="showSuccess">
    <div
      class="ac-card-no-padding ac-dialog-panel-sm ac-dialog-success"
      role="dialog"
      aria-modal="true"
    >
      <div class="ac-dialog-header ac-dialog-success-header">
        <span>Success</span>
        <button
          class="ac-dialog-close"
          (click)="closeSuccess()"
          aria-label="Close"
        >
          Ã—
        </button>
      </div>
      <div class="ac-dialog-body">
        <p class="ac-dialog-success-text">
          {{ successMsg }}
        </p>
      </div>
      <div class="ac-dialog-footer">
        <button
          class="ac-btn ac-btn-primary"
          type="button"
          (click)="closeSuccess()"
        >
          OK
        </button>
      </div>
    </div>
  </div>
