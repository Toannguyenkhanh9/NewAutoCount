<div class="page">
  <!-- header + toolbar -->
  <div class="page">
    <h1>Debit Note Entry</h1>
    <div class="toolbar" role="toolbar">
      <input
        class="search1"
        type="text"
        [(ngModel)]="q"
        placeholder="Search dn no/ company name..."
      />
      <button class="btn primary" (click)="newInvoice()">
        <span class="ico plus"></span> New
      </button>

      <button class="btn" [disabled]="!selected" (click)="editInvoice()">
        <span class="ico edit"></span> Edit
      </button>
      <button
        class="btn danger"
        [disabled]="!selected"
        (click)="openDeleteInvoiceConfirm()"
      >
        <span class="ico trash"></span> Delete
      </button>
    </div>
  </div>
  <!-- list + history shell -->
  <div class="list-shell">
    <!-- grid (giá»¯ table cÅ©) -->
    <div class="gridwrap main-grid">
      <table>
        <thead>
          <tr>
            <th (click)="setSort('docDate')">DN No</th>
            <th (click)="setSort('docNo')">Date</th>
            <th (click)="setSort('debtor')">Company Name</th>
            <th>Description</th>
            <th class="r">Total</th>
            <th class="r">Outstanding</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let inv of paged"
            (click)="toggleSelect(inv)"
            [class.selected]="selected === inv"
            [class.overdue]="isOverdue(inv)"
          >
            <td>{{ inv.docNo }}</td>
            <td>{{ inv.docDate }}</td>
            <td>{{ inv.debtor }} â€” {{ inv.debtorName }}</td>
            <td>{{ inv.description || "-" }}</td>
            <td class="r">{{ inv.grandTotal | number : "1.2-2" }}</td>
            <td class="r">{{ inv.outstanding | number : "1.2-2" }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- pager -->
    <div class="pager">
      <div class="nav">
        <button class="pg" (click)="goFirst()">&laquo;</button>
        <button class="pg" (click)="goPrev()">&lsaquo;</button>
        <span class="pginfo">Page {{ page }} / {{ totalPages }}</span>
        <button class="pg" (click)="goNext()">&rsaquo;</button>
        <button class="pg" (click)="goLast()">&raquo;</button>
      </div>
    </div>

    <!-- payment history -->
    <div class="payment-panel" *ngIf="selected">
      <div class="pp-head">
        <div class="pp-title">
          Payment History
          <ng-container *ngIf="selected"
            >&nbsp;â€”&nbsp;<b>{{ selected.docNo }}</b></ng-container
          >
        </div>
      </div>
      <div class="pp-body" *ngIf="selected; else noSel">
        <table>
          <colgroup>
            <col style="width: 12%" />
            <!-- Type -->
            <col style="width: 20%" />
            <!-- No. -->
            <col style="width: 42%" />
            <!-- Description -->
            <col style="width: 13%" />
            <!-- Date -->
            <col style="width: 13%" />
            <!-- Amount -->
          </colgroup>
          <thead>
            <tr>
              <th style="width: 90px">Type</th>
              <th style="width: 120px">No.</th>
              <th>Description</th>
              <th style="width: 120px">Date</th>
              <th class="r" style="width: 140px">Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of paymentHistory">
              <td>{{ p.type }}</td>
              <td>{{ p.no }}</td>
              <td class="cut">{{ p.description || "-" }}</td>
              <td>{{ p.date }}</td>
              <td class="r">{{ p.amount | number : "1.2-2" }}</td>
            </tr>
            <tr *ngIf="!paymentHistory.length">
              <td colspan="5" class="c muted">â€” No payment â€”</td>
            </tr>
          </tbody>
        </table>
      </div>
      <ng-template #noSel>
        <div class="pp-empty">
          Select an invoice to see its payment history.
        </div>
      </ng-template>
    </div>
  </div>

  <!-- ================== MODALS ================== -->

  <!-- invoice form (New/Edit/View) -->
  <div class="dialog" *ngIf="showForm">
    <div class="dialog-panel">
      <div class="dialog-title">
        {{
          formMode === "new"
            ? "New Debit Note"
            : formMode === "edit"
            ? "Edit Debit Note"
            : "View Debit Note"
        }}
        <button class="x" (click)="showForm = false">âœ•</button>
      </div>

      <form [formGroup]="invForm" class="dialog-body">
        <div class="grid3">
          <!-- Debtor / Journal / Agent / Ref2 -->
          <label>
            Debtor
            <div class="inline-field">
              <select
                class="inp"
                formControlName="debtor"
                (change)="onDebtorChanged()"
              >
                <option value="">Select debtor...</option>
                <option *ngFor="let d of debtors" [ngValue]="d.debtorAccount">
                  {{ d.debtorAccount }} â€” {{ d.companyName }}
                </option>
              </select>

              <!-- search dropdown -->
              <button
                class="btn icon"
                type="button"
                (click)="openDebtorDropdown()"
                title="Search debtors"
                aria-label="Search debtors"
              >
                ðŸ”Ž
              </button>
            </div>
            <div class="err" *ngIf="isInvalid('debtor')">
              Please select a debtor.
            </div>
          </label>

          <label
            >Journal Type
            <select
              formControlName="journalType"
              [disabled]="formMode === 'view'"
            >
              <option *ngFor="let j of journalTypes" [ngValue]="j.typeCode">
                {{ j.typeCode }}
              </option>
            </select>
          </label>
          <label>
            DN Type
            <select formControlName="dnType" [disabled]="formMode === 'view'">
              <option *ngFor="let t of dnTypes" [ngValue]="t">{{ t }}</option>
            </select>
          </label>
          <label
            >Ref. No
            <input formControlName="ref" [readonly]="formMode === 'view'"
          /></label>
          <label
            >Ref. No.2
            <input formControlName="ref2" [readonly]="formMode === 'view'"
          /></label>

          <!-- Invoice No / Date / Terms / Due Date -->
          <label
            >DN No
              <input
                formControlName="docNo"
                [readonly]="invForm.value.autoNumbering || formMode !== 'new'"
                placeholder="&lt;&lt;new&gt;&gt;"
                [class.invalid]="isInvalid('docNo')"
              />
            <div class="err" *ngIf="isInvalid('docNo')">
              <ng-container *ngIf="invForm.get('docNo')?.errors?.['pattern']">
                Only letters, numbers, '-', '_' and '/' are allowed.
              </ng-container>
              <ng-container *ngIf="invForm.get('docNo')?.errors?.['duplicate']">
                This debit note number already exists.
              </ng-container>
            </div>
          </label>

          <label
            >Date
            <input
              type="date"
              formControlName="docDate"
              (change)="recalcDue()"
              [readonly]="formMode === 'view'"
          /></label>

          <label
            >Terms
            <select
              formControlName="terms"
              (change)="recalcDue()"
              [disabled]="formMode === 'view'"
            >
              <option *ngFor="let t of creditTerms" [ngValue]="t.code">
                {{ t.name }}
              </option>
            </select>
          </label>

          <label
            >Due Date
            <input
              style="background-color: rgb(251 241 241)"
              type="date"
              formControlName="dueDate"
              [readonly]="true"
          /></label>
                    <!-- Is Debit Journal -->
          <label class="chk">
            <input
              type="checkbox"
              formControlName="isDebitJournal"
              [disabled]="formMode === 'view'"
            />
            <span>Is Debit Journal</span>
          </label>

          <!-- Document description (ghi nhá»› láº§n gáº§n nháº¥t) -->
          <label class="wide"
            >Description
            <input
              formControlName="description"
              [readonly]="formMode === 'view'"
              placeholder="Document description"
            />
          </label>
        </div>
        <div class="to-box">
          <div class="to-title">To :</div>
          <textarea
            class="to-text"
            rows="3"
            readonly
            [value]="debtorToText"
          ></textarea>
        </div>
        <div class="lines">
          <div class="lines-head">
            <div class="actions">
              <button
                class="btn primary"
                (click)="addAcLine()"
                [disabled]="formMode === 'view'"
              >
                <span class="ico plus"></span> Add
              </button>
            </div>
          </div>

          <div>
            <table class="table bordered" style="width: 100%">
              <thead>
                <tr>
                  <th style="width: 200px">Credit A/C</th>
                  <th>Description</th>
                  <th class="r" style="width: 160px">Amount</th>
                  <th style="width: 44px"></th>
                </tr>
              </thead>
              <tbody *ngIf="invForm">
                <tr
                  *ngFor="
                    let fg of acLineGroups;
                    let i = index;
                    trackBy: trackByIndex
                  "
                  [formGroup]="fg"
                >
                  <td>
                    <input
                      class="inp"
                      formControlName="accNo"
                      [attr.list]="'accnos-' + i"
                      (focus)="prepAccNoSuggestions(i)"
                      (input)="prepAccNoSuggestions(i)"
                    />
                    <datalist [id]="'accnos-' + i">
                      <option
                        *ngFor="let s of accNoSugs[i]"
                        [value]="s"
                      ></option>
                    </datalist>
                  </td>
                  <td>
                    <input
                    style="width: 100%;"
                      formControlName="lineDesc"
                      [readonly]="formMode === 'view'"
                    />
                  </td>

                  <td class="r">
                    <input
                      appAmount
                      formControlName="amount"
                      [allowNegative]="false"
                      (input)="recalcTotals()"
                      [readonly]="formMode === 'view'"
                    />
                  </td>

                  <td class="c">
                    <button
                      class="btn btn-danger"
                      (click)="removeAcLine(i)"
                      [disabled]="formMode === 'view'"
                    >
                      <span class="ico trash"></span>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        <div class="totals-grid">
          <div class="label">Total</div>
          <div class="value">{{  invForm.value.grandTotal | number : "1.2-2" }}</div>
          <div class="label">Net Total</div>
          <div class="value">{{  invForm.value.grandTotal | number : "1.2-2" }}</div>
          <div class="label">Outstanding</div>
          <div class="value">
            {{  invForm.value.outstanding | number : "1.2-2" }}
          </div>
        </div>
        </div>

        <div class="dialog-actions">
          <label class="chk">
            <input type="checkbox" formControlName="continueNew" />
            <span>After save, proceed with new debit note entry</span>
          </label>
          <span class="spacer"></span>
          <button class="btn cancel" (click)="showForm = false">Cancel</button>
          <button
            *ngIf="formMode !== 'view'"
            class="btn primary"
            (click)="saveInvoice()"
            [disabled]="invForm.invalid"
          >
            Save
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Find dialog -->
  <div class="dialog" *ngIf="showFind">
    <div class="dialog-panel">
      <div class="dialog-title">
        Find Invoice
        <button class="x" (click)="showFind = false">âœ•</button>
      </div>
      <div class="dialog-body">
        <form [formGroup]="findForm" class="grid3">
          <label>From <input type="date" formControlName="from" /></label>
          <label>To <input type="date" formControlName="to" /></label>
          <label
            >Debtor
            <select formControlName="debtor">
              <option value="">Any</option>
              <option *ngFor="let d of debtors" [value]="d.debtorAccount">
                {{ d.debtorAccount }} â€” {{ d.companyName }}
              </option>
            </select>
          </label>
          <label
            >Status
            <select formControlName="status">
              <option value="all">All</option>
              <option>OPEN</option>
              <option>POSTED</option>
              <option>VOID</option>
            </select>
          </label>
          <label
            >Min Amount <input type="number" step="0.01" formControlName="min"
          /></label>
          <label
            >Max Amount <input type="number" step="0.01" formControlName="max"
          /></label>
        </form>

        <div class="dialog-foot">
          <button class="btn btn-primary" (click)="runFind()">Search</button>
        </div>

        <table *ngIf="findResults.length">
          <thead>
            <tr>
              <th>Date</th>
              <th>Doc No</th>
              <th>Debtor</th>
              <th class="r">Total</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of findResults">
              <td>{{ r.docDate }}</td>
              <td>{{ r.docNo }}</td>
              <td>{{ r.debtor }} â€” {{ r.debtorName }}</td>
              <td class="r">{{ r.grandTotal | number : "1.2-2" }}</td>
              <td>
                <button class="btn btn-primary" (click)="pickFromFind(r)">
                  Select
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Print Listing -->
  <div class="dialog" *ngIf="showPrint">
    <div class="dialog-panel">
      <div class="dialog-title">
        A/R Invoice Listing
        <button class="x" (click)="showPrint = false">âœ•</button>
      </div>
      <div class="dialog-body">
        <form [formGroup]="printForm" class="grid4">
          <label>From <input type="date" formControlName="from" /></label>
          <label>To <input type="date" formControlName="to" /></label>
          <label
            >Debtor
            <select formControlName="debtor">
              <option value="">Any</option>
              <option *ngFor="let d of debtors" [value]="d.debtorAccount">
                {{ d.debtorAccount }} â€” {{ d.companyName }}
              </option>
            </select>
          </label>
          <label
            >Status
            <select formControlName="status">
              <option value="all">All</option>
              <option>OPEN</option>
              <option>POSTED</option>
              <option>VOID</option>
            </select>
          </label>
          <label
            >Sort by
            <select formControlName="sort">
              <option value="docDate">Date</option>
              <option value="docNo">Doc No</option>
              <option value="debtor">Debtor</option>
              <option value="grandTotal">Amount</option>
            </select>
          </label>
        </form>

        <div class="dialog-actions">
          <button class="btn primary" (click)="showPreview = true">
            Preview
          </button>
        </div>

        <div class="preview" *ngIf="showPreview">
          <h3>A/R Invoice Listing (Preview)</h3>
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Doc No</th>
                <th>Debtor</th>
                <th class="r">Sub Total</th>
                <th class="r">Tax</th>
                <th class="r">Total</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let x of buildListing()">
                <td>{{ x.docDate }}</td>
                <td>{{ x.docNo }}</td>
                <td>{{ x.debtor }} â€” {{ x.debtorName }}</td>
                <td class="r">{{ x.subTotal | number : "1.2-2" }}</td>
                <td class="r">{{ x.taxTotal | number : "1.2-2" }}</td>
                <td class="r">{{ x.grandTotal | number : "1.2-2" }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Debtor picker -->
<div class="dialog" *ngIf="showDebtorPicker">
  <div class="dialog-panel">
    <div class="dialog-title">
      Select Debtor
      <button class="x" (click)="showDebtorPicker = false">Ã—</button>
    </div>
    <div class="dialog-body">
      <div class="toolbar" style="padding: 0 0 8px 0; gap: 8px; display: flex">
        <input
          class="search1"
          [(ngModel)]="debtorQuery"
          (ngModelChange)="filterDebtors()"
          placeholder="Search Debtor A/C, CompanyÂ Name..."
        />
      </div>
      <div class="gridwrap">
        <table>
          <thead>
            <tr>
              <th>Debtor A/C</th>
              <th>Company Name</th>
              <th>Bill Address</th>
              <th>Phone</th>
              <th style="width: 90px"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let d of debtorFiltered" (dblclick)="pickDebtor(d)">
              <td>{{ d.debtorAccount }}</td>
              <td>{{ d.companyName }}</td>
              <td class="cut">{{ d.billAddress }}</td>
              <td>{{ d.phone }}</td>
              <td>
                <button class="btn primary" (click)="pickDebtor(d)">
                  Select
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
<div class="dialog" *ngIf="showDeleteInvoiceConfirm">
  <div
    class="dialog-panel-small"
    role="dialog"
    aria-modal="true"
    style="min-width: 360px"
  >
    <div class="dialog-title">
      Delete Invoice
      <button
        class="x"
        (click)="closeDeleteInvoiceConfirm()"
        aria-label="Close"
      >
        Ã—
      </button>
    </div>

    <div class="dialog-body">
      <p>
        Are you sure you want to delete
        <b>{{ selected?.docNo || "this invoice" }}</b
        >?
      </p>
    </div>

    <div class="dialog-actions">
      <button class="btn cancel" (click)="closeDeleteInvoiceConfirm()">
        Cancel
      </button>
      <button class="btn danger" (click)="confirmDeleteInvoice()">
        Delete
      </button>
    </div>
  </div>
</div>
<!-- Success popup -->
  <div class="ac-dialog-backdrop" *ngIf="showSuccess">
    <div
      class="ac-card-no-padding ac-dialog-panel-sm ac-dialog-success"
      role="dialog"
      aria-modal="true"
    >
      <div class="ac-dialog-header ac-dialog-success-header">
        <span>Success</span>
        <button
          class="ac-dialog-close"
          (click)="closeSuccess()"
          aria-label="Close"
        >
          Ã—
        </button>
      </div>
      <div class="ac-dialog-body">
        <p class="ac-dialog-success-text">
          {{ successMsg }}
        </p>
      </div>
      <div class="ac-dialog-footer">
        <button
          class="ac-btn ac-btn-primary"
          type="button"
          (click)="closeSuccess()"
        >
          OK
        </button>
      </div>
    </div>
  </div>
