<div class="ac-page">

  <!-- =============== LIST MODE (GRID) =============== -->
  <ng-container *ngIf="!showForm">

    <!-- Header -->
    <div class="ac-card">
      <div class="ac-page-header">
        <div>
          <div class="ac-page-title">A/R Receive Payment</div>
          <div class="ac-page-subtitle">
            Record customer receipts and knock off outstanding invoices / debit notes.
          </div>
        </div>

        <div class="ac-page-toolbar" role="toolbar">
          <input class="ac-form-control ac-page-search" [(ngModel)]="q" placeholder="Search OR no. / company name..." />

          <button type="button" class="ac-btn ac-btn-primary" (click)="openNew()">
            <span class="ico plus"></span>
            New
          </button>

          <button type="button" class="ac-btn" (click)="openEdit()" [disabled]="!selected">
            <span class="ico eye"></span>
            View
          </button>
        </div>
      </div>
    </div>

    <!-- List grid -->
    <div class="ac-card ac-card-no-padding">
      <div class="ac-tablewrap">
        <table class="ac-table">
          <thead>
            <tr>
              <th class="ac-text-left" (click)="setSort('receiptNo')">OR No</th>
              <th class="ac-text-left" (click)="setSort('date')">Date</th>
              <th class="ac-text-left" (click)="setSort('debtorName')">Company Name</th>
              <th class="ac-text-left">Description</th>
              <th class="ac-text-right" (click)="setSort('amount')">Amount</th>
              <th class="ac-text-right" (click)="setSort('paidAmt')">
                Paid Amount
              </th>
              <th class="ac-text-right" (click)="setSort('outstanding')">
                Outstanding
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of paged" (click)="toggleDetailFor(r)" [class.ac-row-selected]="r === selected">
              <td>{{ r.receiptNo }}</td>
              <td>{{ r.date }}</td>
              <td>{{ r.debtorName }}</td>
              <td class="cut">{{ r.description || '-' }}</td>
              <td class="ac-text-right">{{ r.amount | number : '1.2-2' }}</td>
              <td class="ac-text-right">
                {{ r.paidAmt | number : '1.2-2' }}
              </td>
              <td class="ac-text-right">
                {{ r.outstanding | number : '1.2-2' }}
              </td>
            </tr>

            <tr *ngIf="!paged.length">
              <td class="ac-text-center ac-text-muted" colspan="7">
                No data
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Detail pane -->
    <div class="ac-card ac-card-no-padding payment-panel" *ngIf="selected">
      <div class="pp-head">
        <div class="pp-title">
          Invoices / Debit Notes Paid
        </div>
      </div>
      <div class="pp-body">
        <table class="ac-table ac-table-sm">
          <colgroup>
            <col style="width: 8%" />
            <col style="width: 14%" />
            <col style="width: 28%" />
            <col style="width: 16%" />
            <col style="width: 16%" />
            <col style="width: 18%" />
          </colgroup>
          <thead>
            <tr>
              <th class="ac-text-left" style="width: 70px">Type</th>
              <th class="ac-text-left" style="width: 110px">Date</th>
              <th class="ac-text-left">No.</th>
              <th  class="ac-text-right" style="width: 140px">Org. Amt.</th>
              <th  class="ac-text-right" style="width: 140px">Outstanding</th>
              <th  class="ac-text-right" style="width: 140px">Paid Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let d of detailItems">
              <td>{{ d.type }}</td>
              <td>{{ d.date }}</td>
              <td>{{ d.no }}</td>
              <td  class="ac-text-right">{{ fmt(d.orgAmt) }}</td>
              <td  class="ac-text-right">{{ fmt(d.outstanding) }}</td>
              <td  class="ac-text-right">{{ fmt(d.paid) }}</td>
            </tr>
            <tr *ngIf="!detailItems.length">
              <td colspan="6" class="text-center text-muted py-3">
                No invoices/debit notes paid for this credit note.
              </td>
            </tr>
          </tbody>
          <tfoot *ngIf="detailItems.length">
            <tr class="sum">
              <th colspan="5"  class="ac-text-right">Total Paid</th>
              <th class="ac-text-right">{{ fmt(detailPaidTotal) }}</th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
    <div class="account-type-footer">
      <div class="account-type-rec">
        Total Records: 3
      </div>

      <div class="account-type-pager">
        <button
          class="ac-btn ac-btn-ghost account-type-pg-btn"
          [disabled]="page === 1"
          (click)="page = 1"
        >
          &laquo;
        </button>
        <button
          class="ac-btn ac-btn-ghost account-type-pg-btn"
          [disabled]="page === 1"
          (click)="page = page - 1"
        >
          &lsaquo;
        </button>

        <span class="account-type-pg-label">
          Page {{ page }} / {{ 1 }}
        </span>

        <button
          class="ac-btn ac-btn-ghost account-type-pg-btn"
          [disabled]="page === 1"
          (click)="page = page + 1"
        >
          &rsaquo;
        </button>
        <button
          class="ac-btn ac-btn-ghost account-type-pg-btn"
          [disabled]="page === 1"
          (click)="page = 1"
        >
          &raquo;
        </button>
      </div>
    </div>
  </ng-container>

  <!-- =============== FORM MODE (FULL PAGE) =============== -->
  <ng-container *ngIf="showForm">
    <div class="rp-form-shell">
      <!-- page header cho form -->
      <div class="rp-header">
        <div class="rp-title">
          {{ formMode === 'edit' ? 'Edit A/R Receive Payment' : 'New A/R Receive Payment' }}
        </div>
        <div class="rp-subtitle">
          Record customer receipts and knock off outstanding invoices / debit notes.
        </div>
      </div>

      <!-- thÃ¢n form -->
      <form class="rp-body" [formGroup]="rpForm">
        <div class="rp-body-scroll">
          <!-- Header fields -->
          <div class="ac-dialog-form-grid-3">
            <label>
              Debtor
              <select class="ac-form-control" formControlName="debtor" (change)="onDebtorChanged()">
                <option value="">-- Select --</option>
                <option *ngFor="let d of debtors" [ngValue]="d.debtorAccount">
                  {{ d.debtorAccount }} â€” {{ d.companyName }}
                </option>
              </select>
            </label>

            <label>
              Official Receipt No
              <input class="ac-form-control" formControlName="officialNo" placeholder="&lt;&lt;new&gt;&gt;"
                (input)="buildOrNoSuggestions()" (focus)="buildOrNoSuggestions()" list="orno-list" />
              <datalist id="orno-list">
                <option *ngFor="let v of orNoSuggestions" [value]="v"></option>
              </datalist>
            </label>

            <label>
              Date
              <input type="date" class="ac-form-control" formControlName="date" />
            </label>

            <label class="wide">
              Description
              <input class="ac-form-control" formControlName="description" />
            </label>
          </div>

          <br />

          <!-- ===== PAYMENT METHODS TABLE ===== -->
          <div formArrayName="methods" class="box" style="margin-bottom: 12px">
            <div class="inv-lines-tablewrap">
              <table class="ac-table-addnew inv-lines-table">
                <thead>
                  <tr>
                    <th>Payment Method</th>
                    <th>Cheque No.</th>
                    <th class="r">Payment Amount</th>
                    <th class="r">Charge Fee</th>
                    <th>Payment By</th>
                    <th class="c">Is RCHQ</th>
                    <th>RCHQ Date</th>
                    <th class="col-del"></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let _ of methodsFA.controls; let i = index" [formGroupName]="i">
                    <td>
                      <select class="ac-form-control" formControlName="method" (change)="onMethodChanged(i)">
                        <option *ngFor="let m of paymentMethods" [ngValue]="m.value">
                          {{ m.label }}
                        </option>
                      </select>
                    </td>
                    <td>
                      <input class="ac-form-control" formControlName="chequeNo" />
                    </td>
                    <td class="r">
                      <input class="ac-form-control" appAmount formControlName="amount"
                        (input)="onMethodAmtOrFeeChanged()" />
                    </td>
                    <td class="r">
                      <input class="ac-form-control" appAmount formControlName="bankCharge" [class.invalid]="
                          methodsFA.at(i).errors?.['feeOverAmount']
                        " (input)="onMethodAmtOrFeeChanged()" />
                    </td>
                    <td>
                      <input class="ac-form-control" formControlName="paymentBy" readonly />
                    </td>
                    <td class="c">
                      <input type="checkbox" formControlName="isRCHQ" [disabled]="formMode === 'new'" />
                    </td>
                    <td>
                      <input type="date" class="ac-form-control" formControlName="rchqDate"
                        [disabled]="formMode !== 'edit'" />
                    </td>
                    <td class="col-del">
                      <button type="button" class="ac-btn ac-btn-icon-danger" (click)="removeMethod(i)"
                        [disabled]="formMode === 'edit'">
                        ðŸ—‘
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="inv-lines-bottom">
              <!-- Add row dropdown -->
              <div class="inv-addrow-wrapper" *ngIf="formMode !== 'edit'">
                <div class="inv-addrow-split" [class.open]="showAddRowMenu">
                  <!-- nÃºt chÃ­nh: thÃªm 1 dÃ²ng -->
                  <button type="button" class="ac-btn ac-btn-primary inv-addrow-main" (click)="addRows(1)">
                    Add row
                  </button>

                  <!-- nÃºt caret má»Ÿ menu -->
                  <button type="button" class="ac-btn ac-btn-primary inv-addrow-caret" (click)="toggleAddRowMenu()">
                    â–¾
                  </button>

                  <!-- menu chá»n sá»‘ dÃ²ng -->
                  <div class="inv-addrow-menu" *ngIf="showAddRowMenu">
                    <button type="button" class="inv-addrow-menu-item" (click)="addRows(5); closeAddRowMenu()">
                      Add 5 rows
                    </button>
                    <button type="button" class="inv-addrow-menu-item" (click)="addRows(10); closeAddRowMenu()">
                      Add 10 rows
                    </button>
                    <button type="button" class="inv-addrow-menu-item" (click)="addRows(20); closeAddRowMenu()">
                      Add 20 rows
                    </button>
                  </div>
                </div>
              </div>

              <!-- Totals giá»¯ nguyÃªn bÃªn pháº£i -->
              <div class="inv-totals">
                <div class="row">
                  <div class="label">Amount</div>
                  <div class="value">
                    {{ totalAmount | number : '1.2-2' }}
                  </div>
                </div>
                <div class="row total">
                  <div class="label">Unapplied Amount</div>
                  <div class="value">
                    {{ unappliedAmount | number : '1.2-2' }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <br />
          <!-- ===== KNOCK OFF TABLE ===== -->
          <div formArrayName="knockOff">
            <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 6px;
              ">
              <div class="title sm knock-title">
                Knock Off Invoices / Debit Notes
              </div>
              <button class="ac-btn ac-btn-primary" type="button" (click)="autoAllocate()"
                [disabled]="!canAllocate || formMode === 'edit'">
                Auto allocate
              </button>
            </div>

            <table class="ac-table table bordered">
              <thead>
                <tr>
                  <th (click)="sortKnock('type')" style="cursor: pointer;color: black;">
                    Type
                    <span *ngIf="knockSortBy === 'type'">
                      {{ knockSortDir === 'asc' ? 'â–²' : 'â–¼' }}
                    </span>
                  </th>
                  <th (click)="sortKnock('date')" style="cursor: pointer;color: black;">
                    Date
                    <span *ngIf="knockSortBy === 'date'">
                      {{ knockSortDir === 'asc' ? 'â–²' : 'â–¼' }}
                    </span>
                  </th>
                  <th>No.</th>
                  <th class="r" (click)="sortKnock('orgAmt')" style="cursor: pointer;color: black;">
                    Org. Amt.
                    <span *ngIf="knockSortBy === 'orgAmt'">
                      {{ knockSortDir === 'asc' ? 'â–²' : 'â–¼' }}
                    </span>
                  </th>
                  <th class="r" style="color: black;">Outstanding</th>
                  <th class="r" style="color: black;">Discount Due</th>
                  <th class="c withdisc" style="color: black;">With Dis.</th>
                  <th class="r" style="color: black;">Disc. Amount</th>
                  <th class="r" style="color: black;">Pay</th>
                  <th class="c" style="color: black;"></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let fg of knockFA.controls; let i = index" [formGroupName]="i"
                  [class.overdue-row]="isRowOverdue(i)">
                  <td>
                    {{ knockFA.at(i).get('type')!.value }}
                  </td>
                  <td>
                    {{ knockFA.at(i).get('date')!.value }}
                  </td>
                  <td>
                    {{ knockFA.at(i).get('no')!.value }}
                  </td>
                  <td class="r">
                    {{
                    knockFA.at(i).get('orgAmt')!.value
                    | number : '1.2-2'
                    }}
                  </td>
                  <td class="r" [ngClass]="{
                      'out-gt0':
                        (+knockFA.at(i).get('outstanding')!.value || 0) > 0
                    }">
                    {{
                    knockFA.at(i).get('outstanding')!.value
                    | number : '1.2-2'
                    }}
                  </td>
                  <td>
                    {{
                    knockFA.at(i).get('discountdue')!.value
                    }}
                  </td>

                  <td class="c withdisc">
                    <input type="checkbox" formControlName="withDisc" (change)="onWithDiscChanged(i)"
                      [disabled]="isSelDisabled(i)" />
                  </td>

                  <td class="r">
                    <input appAmount [decimals]="2" [allowNegative]="false" [formatOnBlurOnly]="true"
                      formControlName="discAmt" [readonly]="
                        !fg.value.withDisc ||
                        !canAllocate ||
                        isSelDisabled(i)
                      " (blur)="onDiscBlur(i)" />
                  </td>

                  <td class="r">
                    <input appAmount [decimals]="2" [allowNegative]="false" [formatOnBlurOnly]="true"
                      formControlName="pay" [readonly]="
                        formMode === 'edit' ||
                        !canAllocate ||
                        discIsFull(i)
                      " (input)="onPayChanged(i)" (blur)="onPayBlur(i)" />
                  </td>
                  <td class="c">
                    <input type="checkbox" [checked]="(+fg.value.pay || 0) > 0" (change)="toggleAlloc(i, $event)"
                      [disabled]="formMode === 'edit'" />
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- footer cá»‘ Ä‘á»‹nh -->
        <div class="rp-footer">
          <button type="button" class="ac-btn ac-btn-ghost" (click)="closeForm()">
            Cancel
          </button>

          <ng-container *ngIf="formMode !== 'edit' || hasAnyChequeMethod">
            <button type="button" class="ac-btn ac-btn-primary" (click)="askSave()" [disabled]="
                unappliedAmount !== 0 ||
                rpForm.invalid ||
                totalAmount === 0
              ">
              Save
            </button>
          </ng-container>
        </div>
      </form>
    </div>
  </ng-container>

  <!-- ===== DELETE CONFIRM ===== -->
  <div class="dialog" *ngIf="showDeleteConfirm">
    <div class="dialog-panel-small ac-card-no-padding" role="dialog" aria-modal="true" style="min-width: 360px">
      <div class="ac-dialog-header">
        <span>Delete Receive Payment</span>
        <button class="ac-dialog-close" type="button" (click)="showDeleteConfirm = false" aria-label="Close">
          Ã—
        </button>
      </div>
      <div class="ac-dialog-body">
        Are you sure you want to delete
        <b>{{ selected?.receiptNo }}</b>?
      </div>
      <div class="ac-dialog-footer">
        <button type="button" class="ac-btn ac-btn-ghost" (click)="showDeleteConfirm = false">
          Cancel
        </button>
        <button type="button" class="ac-btn ac-btn-danger" (click)="doDelete()">
          Delete
        </button>
      </div>
    </div>
  </div>

  <div class="ac-dialog-backdrop" *ngIf="showSuccess">
    <div class="ac-card-no-padding ac-dialog-panel-sm ac-dialog-success" role="dialog" aria-modal="true">
      <div class="ac-dialog-header ac-dialog-success-header">
        <span>Success</span>
        <button class="ac-dialog-close" (click)="closeSuccess()" aria-label="Close">
          Ã—
        </button>
      </div>
      <div class="ac-dialog-body">
        <p class="ac-dialog-success-text">
          {{ successMsg }}
        </p>
      </div>
      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-primary" type="button" (click)="closeSuccess()">
          OK
        </button>
      </div>
    </div>
  </div>

  <!-- ===== SAVE CONFIRM ===== -->
  <div class="ac-dialog-backdrop" *ngIf="showSaveConfirm">
    <div class="ac-card-no-padding ac-dialog-panel-sm" role="dialog" aria-modal="true" style="min-width: 360px">
      <div class="ac-dialog-header">
        <span>Confirm</span>
        <button class="ac-dialog-close" type="button" (click)="cancelConfirmSave()" aria-label="Close">
          Ã—
        </button>
      </div>
      <div class="ac-dialog-body">
        {{ confirmMsg }}
      </div>
      <div class="ac-dialog-footer">
        <button type="button" class="ac-btn ac-btn-ghost" (click)="cancelConfirmSave()">
          Cancel
        </button>
        <button type="button" class="ac-btn ac-btn-primary" (click)="doConfirmSave()">
          OK
        </button>
      </div>
    </div>
  </div>
</div>
