<div class="ac-page">
  <!-- ============ HEADER ============ -->
  <div class="ac-page-header">
    <div>
      <div class="ac-page-title">A/R Receive Payment</div>
      <div class="ac-page-subtitle">
        Record customer receipts and knock off outstanding invoices / debit notes.
      </div>
    </div>

    <div class="ac-page-toolbar" role="toolbar">
      <input
        class="ac-form-control ac-page-search"
        [(ngModel)]="q"
        placeholder="Search OR no. / company name..."
      />

      <button
        type="button"
        class="ac-btn ac-btn-primary"
        (click)="openNew()"
      >
        <span class="ico plus"></span>
        New
      </button>

      <button
        type="button"
        class="ac-btn"
        (click)="openEdit()"
        [disabled]="!selected"
      >
        <span class="ico eye"></span>
        View
      </button>
    </div>
  </div>

  <!-- ============ LIST ============ -->
  <div class="ac-card ac-card-no-padding">
    <div class="ac-tablewrap">
      <table class="ac-table">
        <thead>
          <tr>
            <th (click)="setSort('receiptNo')">OR No</th>
            <th (click)="setSort('date')">Date</th>
            <th (click)="setSort('debtorName')">Company Name</th>
            <th>Description</th>
            <th class="ac-text-right" (click)="setSort('amount')">Amount</th>
            <th class="ac-text-right" (click)="setSort('paidAmt')">Paid Amount</th>
            <th class="ac-text-right" (click)="setSort('outstanding')">Outstanding</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let r of paged"
            (click)="toggleDetailFor(r)"
            [class.ac-row-selected]="r === selected"
          >
            <td>{{ r.receiptNo }}</td>
            <td>{{ r.date }}</td>
            <td>{{ r.debtorName }}</td>
            <td class="cut">{{ r.description || '-' }}</td>
            <td class="ac-text-right">{{ r.amount | number : '1.2-2' }}</td>
            <td class="ac-text-right">{{ r.paidAmt | number : '1.2-2' }}</td>
            <td class="ac-text-right">{{ r.outstanding | number : '1.2-2' }}</td>
          </tr>
          <tr *ngIf="!paged.length">
            <td class="ac-text-center ac-text-muted" colspan="7">
              No data
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ============ DETAIL PANE ============ -->
  <div *ngIf="detailOpen" class="cn-detail-pane">
    <div class="cn-detail-header">Invoices / Debit Notes Paid</div>

    <table class="table table-sm cn-subgrid">
      <colgroup>
        <col style="width: 8%" />
        <col style="width: 14%" />
        <col style="width: 28%" />
        <col style="width: 16%" />
        <col style="width: 16%" />
        <col style="width: 18%" />
      </colgroup>
      <thead>
        <tr>
          <th style="width:70px;">Type</th>
          <th style="width:110px;">Date</th>
          <th>No.</th>
          <th class="text-end" style="width:140px;">Org. Amt.</th>
          <th class="text-end" style="width:140px;">Outstanding</th>
          <th class="text-end" style="width:140px;">Paid Amount</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let d of detailItems">
          <td>{{ d.type }}</td>
          <td>{{ d.date }}</td>
          <td>{{ d.no }}</td>
          <td class="text-end">{{ fmt(d.orgAmt) }}</td>
          <td class="text-end">{{ fmt(d.outstanding) }}</td>
          <td class="text-end">{{ fmt(d.paid) }}</td>
        </tr>
        <tr *ngIf="!detailItems.length">
          <td colspan="6" class="text-center text-muted py-3">
            No invoices/debit notes paid for this credit note.
          </td>
        </tr>
      </tbody>
      <tfoot *ngIf="detailItems.length">
        <tr class="sum">
          <th colspan="5" class="text-end">Total Paid</th>
          <th class="text-end">{{ fmt(detailPaidTotal) }}</th>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- ============ PAGER ============ -->
  <div class="ac-page-footer">
    <div class="ac-pager">
      <button
        type="button"
        class="ac-btn ac-pager-btn"
        (click)="first()"
      >
        &laquo;
      </button>
      <button
        type="button"
        class="ac-btn ac-pager-btn"
        (click)="prev()"
      >
        &lsaquo;
      </button>

      <span class="ac-pager-label">
        Page {{ page }} / {{ totalPages }}
      </span>

      <button
        type="button"
        class="ac-btn ac-pager-btn"
        (click)="next()"
      >
        &rsaquo;
      </button>
      <button
        type="button"
        class="ac-btn ac-pager-btn"
        (click)="last()"
      >
        &raquo;
      </button>
    </div>
  </div>

  <!-- ========== MODAL: RECEIVE PAYMENT ========== -->
  <div class="dialog" *ngIf="showForm">
    <div class="dialog-panel ac-card-no-padding ac-dialog-panel-xl">
      <div class="ac-dialog-header">
        <span>
          {{ formMode === 'edit' ? 'Edit' : 'New' }} A/R Receive Payment
        </span>
        <button
          type="button"
          class="ac-dialog-close"
          (click)="closeForm()"
        >
          Ã—
        </button>
      </div>

      <form class="ac-dialog-body" [formGroup]="rpForm">
        <!-- Header -->
        <div class="grid3">
          <label>
            Debtor
            <select
              class="ac-form-control"
              formControlName="debtor"
              (change)="onDebtorChanged()"
            >
              <option value="">-- Select --</option>
              <option *ngFor="let d of debtors" [ngValue]="d.debtorAccount">
                {{ d.debtorAccount }} â€” {{ d.companyName }}
              </option>
            </select>
          </label>

          <label>
            Official Receipt No
            <input
              class="ac-form-control"
              formControlName="officialNo"
              placeholder="&lt;&lt;new&gt;&gt;"
              (input)="buildOrNoSuggestions()"
              (focus)="buildOrNoSuggestions()"
              list="orno-list"
            />
            <datalist id="orno-list">
              <option *ngFor="let v of orNoSuggestions" [value]="v"></option>
            </datalist>
          </label>

          <label>
            Date
            <input
              type="date"
              class="ac-form-control"
              formControlName="date"
            />
          </label>

          <label class="wide">
            Description
            <input
              class="ac-form-control"
              formControlName="description"
            />
          </label>
        </div>

        <br />

        <!-- ===== PAYMENT METHODS TABLE ===== -->
        <div formArrayName="methods" class="box" style="margin-bottom: 12px">
          <div class="tablewrap">
            <table class="table bordered pm-table">
              <thead>
                <tr>
                  <th>Payment Method</th>
                  <th>Cheque No.</th>
                  <th class="r">Payment Amount</th>
                  <th class="r">Charge Fee</th>
                  <th>Payment By</th>
                  <th class="c">Is RCHQ</th>
                  <th>RCHQ Date</th>
                  <th class="col-del"></th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="let _ of methodsFA.controls; let i = index"
                  [formGroupName]="i"
                >
                  <td>
                    <select
                      class="ac-form-control"
                      formControlName="method"
                      (change)="onMethodChanged(i)"
                    >
                      <option
                        *ngFor="let m of paymentMethods"
                        [ngValue]="m.value"
                      >
                        {{ m.label }}
                      </option>
                    </select>
                  </td>
                  <td>
                    <input
                      class="ac-form-control"
                      formControlName="chequeNo"
                    />
                  </td>
                  <td class="r">
                    <input
                      class="ac-form-control"
                      appAmount
                      formControlName="amount"
                      (input)="onMethodAmtOrFeeChanged()"
                    />
                  </td>
                  <td class="r">
                    <input
                      class="ac-form-control"
                      appAmount
                      formControlName="bankCharge"
                      [class.invalid]="methodsFA.at(i).errors?.['feeOverAmount']"
                      (input)="onMethodAmtOrFeeChanged()"
                    />
                  </td>
                  <td>
                    <input
                      class="ac-form-control"
                      formControlName="paymentBy"
                      readonly
                    />
                  </td>
                  <td class="c">
                    <input
                      type="checkbox"
                      formControlName="isRCHQ"
                      [disabled]="formMode === 'new'"
                    />
                  </td>
                  <td>
                    <input
                      type="date"
                      class="ac-form-control"
                      formControlName="rchqDate"
                      [disabled]="formMode !== 'edit'"
                    />
                  </td>
                  <td class="col-del">
                    <button
                      class="btn del"
                      type="button"
                      (click)="removeMethod(i)"
                      [disabled]="formMode === 'edit'"
                      aria-label="Delete"
                    >
                      ðŸ—‘
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div style="padding: 10px 12px; border-top: 1px solid #e5e7eb">
            <button
              class="ac-btn ac-btn-primary"
              type="button"
              (click)="addMethod()"
              [disabled]="formMode === 'edit'"
            >
              ï¼‹ Add
            </button>
          </div>
        </div>

        <br />

        <!-- ===== TOTALS ===== -->
        <div class="totals-grid">
          <div class="label">Amount</div>
          <div class="value">{{ totalAmount | number : '1.2-2' }}</div>
          <div class="label">Unapplied Amount</div>
          <div class="value" [class.warn]="unappliedAmount !== 0">
            {{ unappliedAmount | number : '1.2-2' }}
          </div>
        </div>

        <br />

        <!-- ===== KNOCK OFF TABLE ===== -->
        <div formArrayName="knockOff">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 6px;
            "
          >
            <div class="title sm knock-title">
              Knock Off Invoices / Debit Notes
            </div>
            <button
              class="ac-btn ac-btn-primary"
              type="button"
              (click)="autoAllocate()"
              [disabled]="!canAllocate || formMode === 'edit'"
            >
              Auto allocate
            </button>
          </div>

          <table class="table bordered knock-table">
            <thead>
              <tr>
                <th (click)="sortKnock('type')" style="cursor: pointer">
                  Type
                  <span *ngIf="knockSortBy === 'type'">
                    {{ knockSortDir === 'asc' ? 'â–²' : 'â–¼' }}
                  </span>
                </th>
                <th (click)="sortKnock('date')" style="cursor: pointer">
                  Date
                  <span *ngIf="knockSortBy === 'date'">
                    {{ knockSortDir === 'asc' ? 'â–²' : 'â–¼' }}
                  </span>
                </th>
                <th>No.</th>
                <th
                  class="r"
                  (click)="sortKnock('orgAmt')"
                  style="cursor: pointer"
                >
                  Org. Amt.
                  <span *ngIf="knockSortBy === 'orgAmt'">
                    {{ knockSortDir === 'asc' ? 'â–²' : 'â–¼' }}
                  </span>
                </th>
                <th class="r">Outstanding</th>
                <th class="r">Discount Due</th>
                <th class="c withdisc">With Dis.</th>
                <th class="r">Disc. Amount</th>
                <th class="r">Pay</th>
                <th class="c"></th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let fg of knockFA.controls; let i = index"
                [formGroupName]="i"
                [class.overdue-row]="isRowOverdue(i)"
              >
                <td>{{ knockFA.at(i).get('type')!.value }}</td>
                <td>{{ knockFA.at(i).get('date')!.value }}</td>
                <td>{{ knockFA.at(i).get('no')!.value }}</td>
                <td class="r">
                  {{
                    knockFA.at(i).get('orgAmt')!.value
                      | number : '1.2-2'
                  }}
                </td>
                <td
                  class="r"
                  [ngClass]="{
                    'out-gt0':
                      (+knockFA.at(i).get('outstanding')!.value || 0) > 0
                  }"
                >
                  {{
                    knockFA.at(i).get('outstanding')!.value
                      | number : '1.2-2'
                  }}
                </td>
                <td>{{ knockFA.at(i).get('discountdue')!.value }}</td>

                <td class="c withdisc">
                  <input
                    type="checkbox"
                    formControlName="withDisc"
                    (change)="onWithDiscChanged(i)"
                    [disabled]="isSelDisabled(i)"
                  />
                </td>

                <td class="r">
                  <input
                    appAmount
                    [decimals]="2"
                    [allowNegative]="false"
                    [formatOnBlurOnly]="true"
                    formControlName="discAmt"
                    [readonly]="
                      !fg.value.withDisc || !canAllocate || isSelDisabled(i)
                    "
                    (blur)="onDiscBlur(i)"
                  />
                </td>

                <td class="r">
                  <input
                    appAmount
                    [decimals]="2"
                    [allowNegative]="false"
                    [formatOnBlurOnly]="true"
                    formControlName="pay"
                    [readonly]="
                      formMode === 'edit' ||
                      !canAllocate ||
                      discIsFull(i)
                    "
                    (input)="onPayChanged(i)"
                    (blur)="onPayBlur(i)"
                  />
                </td>
                <td class="c">
                  <input
                    type="checkbox"
                    [checked]="(+fg.value.pay || 0) > 0"
                    (change)="toggleAlloc(i, $event)"
                    [disabled]="formMode === 'edit'"
                  />
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="ac-dialog-footer">
          <button
            type="button"
            class="ac-btn ac-btn-ghost"
            (click)="closeForm()"
          >
            Cancel
          </button>

          <ng-container *ngIf="formMode !== 'edit' || hasAnyChequeMethod">
            <button
              type="button"
              class="ac-btn ac-btn-primary"
              (click)="askSave()"
              [disabled]="
                unappliedAmount !== 0 ||
                rpForm.invalid ||
                totalAmount === 0
              "
            >
              Save
            </button>
          </ng-container>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== DELETE CONFIRM ===== -->
  <div class="dialog" *ngIf="showDeleteConfirm">
    <div
      class="dialog-panel-small ac-card-no-padding"
      role="dialog"
      aria-modal="true"
      style="min-width: 360px"
    >
      <div class="ac-dialog-header">
        <span>Delete Receive Payment</span>
        <button
          class="ac-dialog-close"
          type="button"
          (click)="showDeleteConfirm = false"
          aria-label="Close"
        >
          Ã—
        </button>
      </div>
      <div class="ac-dialog-body">
        Are you sure you want to delete
        <b>{{ selected?.receiptNo }}</b>?
      </div>
      <div class="ac-dialog-footer">
        <button
          type="button"
          class="ac-btn ac-btn-ghost"
          (click)="showDeleteConfirm = false"
        >
          Cancel
        </button>
        <button
          type="button"
          class="ac-btn ac-btn-danger"
          (click)="doDelete()"
        >
          Delete
        </button>
      </div>
    </div>
  </div>

  <!-- ===== SUCCESS ===== -->
  <div class="dialog" *ngIf="showSuccess">
    <div
      class="dialog-panel-small ac-card-no-padding"
      role="dialog"
      aria-modal="true"
      style="min-width: 360px"
    >
      <div
        class="ac-dialog-header"
        style="background: linear-gradient(180deg, #9be28a 0%, #62c84f 100%)"
      >
        <span>Success</span>
        <button
          class="ac-dialog-close"
          type="button"
          (click)="closeSuccess()"
          aria-label="Close"
        >
          Ã—
        </button>
      </div>
      <div class="ac-dialog-body">
        <p style="margin: 8px 0; font-weight: 600; color: #14532d">
          {{ successMsg }}
        </p>
      </div>
      <div class="ac-dialog-footer">
        <button
          type="button"
          class="ac-btn ac-btn-primary"
          (click)="closeSuccess()"
        >
          OK
        </button>
      </div>
    </div>
  </div>

  <!-- ===== SAVE CONFIRM ===== -->
  <div class="dialog" *ngIf="showSaveConfirm">
    <div
      class="dialog-panel-small ac-card-no-padding"
      role="dialog"
      aria-modal="true"
      style="min-width: 360px"
    >
      <div class="ac-dialog-header">
        <span>Confirm</span>
        <button
          class="ac-dialog-close"
          type="button"
          (click)="cancelConfirmSave()"
          aria-label="Close"
        >
          Ã—
        </button>
      </div>
      <div class="ac-dialog-body">
        {{ confirmMsg }}
      </div>
      <div class="ac-dialog-footer">
        <button
          type="button"
          class="ac-btn ac-btn-ghost"
          (click)="cancelConfirmSave()"
        >
          Cancel
        </button>
        <button
          type="button"
          class="ac-btn ac-btn-primary"
          (click)="doConfirmSave()"
        >
          OK
        </button>
      </div>
    </div>
  </div>
</div>
