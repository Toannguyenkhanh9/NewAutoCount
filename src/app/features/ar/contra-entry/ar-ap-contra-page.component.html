<div class="page">
  <!-- ===== Title + Toolbar ===== -->
  <div class="titlebar">
    <h1>A/R and A/P Contra Entry</h1>
    <div class="toolbar">
      <input
        class="search1"
        [(ngModel)]="q"
        placeholder="Search contra no, debtor, creditor..."
      />
      <button class="btn primary" type="button" (click)="openContraForm()">
        <span class="ico plus"></span> New
      </button>
      <button
        class="btn"
        (click)="openView(selected)"
        type="button"
        [disabled]="!selected"
      >
        <span class="ico eye"></span> View
      </button>
    </div>
  </div>

  <!-- ===== LIST ===== -->
  <div class="gridwrap">
    <table>
      <thead>
        <tr>
          <th (click)="setSort('contraNo')">Contra No.</th>
          <th (click)="setSort('date')">Date</th>
          <th (click)="setSort('debtorName')">Debtor</th>
          <th (click)="setSort('creditorName')">Creditor</th>
          <th>Description</th>
          <th class="r" (click)="setSort('netTotal')">Net Total</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let r of paged"
          (click)="toggleDetailFor(r)"
          [class.selected]="r === selected"
        >
          <td>{{ r.contraNo }}</td>
          <td>{{ r.date }}</td>
          <td>{{ r.debtorName }}</td>
          <td>{{ r.creditorName }}</td>
          <td class="cut">{{ r.description || "-" }}</td>
          <td class="r">{{ r.netTotal | number : "1.2-2" }}</td>
        </tr>
        <tr *ngIf="!paged.length">
          <td class="center muted" colspan="8">No data</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ===== Pager ===== -->
  <div class="pager">
    <div class="nav">
      <button class="pg" (click)="first()">&laquo;</button>
      <button class="pg" (click)="prev()">&lsaquo;</button>
      <span class="pginfo">Page {{ page }} / {{ totalPages }}</span>
      <button class="pg" (click)="next()">&rsaquo;</button>
      <button class="pg" (click)="last()">&raquo;</button>
    </div>
  </div>
  <!-- Detail Pane: Invoices/Debit Notes Paid -->
  <div *ngIf="detailOpen" class="cn-detail-pane">
    <div class="cn-detail-header">Invoices/Debit Notes Paid</div>

    <table class="table table-sm cn-subgrid">
      <colgroup>
        <col style="width: 8%" />
        <!-- Type -->
        <col style="width: 14%" />
        <!-- Date -->
        <col style="width: 28%" />
        <!-- No. -->
        <col style="width: 16%" />
        <!-- Org. Amt. -->
        <col style="width: 16%" />
        <!-- Outstanding -->
        <col style="width: 18%" />
        <!-- Paid Amount -->
      </colgroup>
      <thead>
        <tr>
          <th style="width: 70px">Type</th>
          <th style="width: 110px">Date</th>
          <th>No.</th>
          <th class="text-end" style="width: 140px">Org. Amt.</th>
          <th class="text-end" style="width: 140px">Outstanding</th>
          <th class="text-end" style="width: 140px">Paid Amount</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let d of detailItems">
          <td>{{ d.type }}</td>
          <td>{{ d.date }}</td>
          <td>{{ d.no }}</td>
          <td class="text-end">{{ fmt(d.orgAmt) }}</td>
          <td class="text-end">{{ fmt(d.outstanding) }}</td>
          <td class="text-end">{{ fmt(d.paid) }}</td>
        </tr>
        <tr *ngIf="!detailItems.length">
          <td colspan="6" class="text-center text-muted py-3">
            No invoices/debit notes paid for this credit note.
          </td>
        </tr>
      </tbody>
      <tfoot *ngIf="detailItems.length">
        <tr>
          <th colspan="5" class="text-end">Total Paid</th>
          <th class="text-end">{{ fmt(detailPaidTotal) }}</th>
        </tr>
      </tfoot>
    </table>
  </div>
  <!-- =================== MODAL: NEW A/R & A/P CONTRA ENTRY =================== -->
  <div class="dialog" *ngIf="showContraForm">
    <div class="dialog-panel" style="width: min(1100px, 96vw)">
      <div class="dialog-title">
        {{
          isReadOnly
            ? "View A/R and A/P Contra Entry"
            : "New A/R and A/P Contra Entry"
        }}
        <button class="x" (click)="closeContraForm()">×</button>
      </div>

      <form class="dialog-body" [formGroup]="contraForm">
        <!-- ===== HEADER ===== -->
        <div class="grid3">
          <label>
            Debtor
            <select formControlName="debtor">
              <option *ngFor="let d of debtorOptions" [value]="d.code">
                {{ d.code }} — {{ d.name }}
              </option>
            </select>
          </label>

          <label>
            Creditor
            <select formControlName="creditor">
              <option *ngFor="let c of creditorOptions" [value]="c.code">
                {{ c.code }} — {{ c.name }}
              </option>
            </select>
          </label>

          <label>
            Journal Type
            <select formControlName="journalType">
              <option *ngFor="let j of journalTypes" [value]="j.typeCode">
                {{ j.typeCode }}
              </option>
            </select>
          </label>
          <label>Ref. <input formControlName="ref" /></label>
          <label>Ref. No.2 <input formControlName="ref2" /></label>
          <label
            >Contra No
            <input
              formControlName="contraNo"
              placeholder="&lt;&lt;new&gt;&gt;"
              (input)="buildOrNoSuggestions()"
              (focus)="buildOrNoSuggestions()"
              list="orno-list"
            />
            <datalist id="orno-list">
              <option *ngFor="let v of orNoSuggestions" [value]="v"></option>
            </datalist>
          </label>
          <label>Date <input type="date" formControlName="date" /></label>
          <label class="wide"
            >Description <input formControlName="description"
          /></label>
          <label>
            Contra Amt
            <input
              appAmount
              min="0"
              formControlName="contraAmt"
              (input)="recalcContra()"
            />
          </label>
        </div>

        <br />

        <!-- ===== KNOCK-OFF A/R ===== -->
        <div class="box">
          <div class="totals-grid">
            <div class="label">Unapplied Amount</div>
            <div class="value">{{ unappliedAR() | number : "1.2-2" }}</div>
          </div>
          <div
            class="title sm"
            style="
              display: flex;
              justify-content: space-between;
              align-items: flex-start;
            "
          >
            <div style="font-weight: bold">
              Knock-off A/R Invoices / Debit Notes
              <span class="party">{{ debtorName }}</span>
            </div>

            <!-- Cụm bên phải xếp dọc: Amount ở trên, Auto Allocate ở dưới -->
            <div class="side-stack">
              <button
                class="btn primary"
                type="button"
                (click)="autoAllocate('ar')"
                [disabled]="isReadOnly || !canAllocate"
              >
                Auto Allocate
              </button>
            </div>
          </div>

          <div formArrayName="ar" class="tablewrap">
            <table class="table bordered">
              <thead>
                <tr>
                  <th class="sortable" (click)="sortKnock('ar', 'type')">
                    Type
                    <span class="sort" [class.on]="knSort.ar.key === 'type'">{{
                      knSort.ar.dir === "asc" ? "▲" : "▼"
                    }}</span>
                  </th>
                  <th class="sortable" (click)="sortKnock('ar', 'date')">
                    Date
                    <span class="sort" [class.on]="knSort.ar.key === 'date'">{{
                      knSort.ar.dir === "asc" ? "▲" : "▼"
                    }}</span>
                  </th>
                  <th class="sortable" (click)="sortKnock('ar', 'no')">
                    No.
                    <span class="sort" [class.on]="knSort.ar.key === 'no'">{{
                      knSort.ar.dir === "asc" ? "▲" : "▼"
                    }}</span>
                  </th>
                  <th class="r sortable" (click)="sortKnock('ar', 'orgAmt')">
                    Org. Amt.
                    <span
                      class="sort"
                      [class.on]="knSort.ar.key === 'orgAmt'"
                      >{{ knSort.ar.dir === "asc" ? "▲" : "▼" }}</span
                    >
                  </th>
                  <th class="r">Outstanding</th>
                  <th class="r">Pay</th>
                  <!-- bỏ (click) ở header -->
                  <th class="c"></th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="let fg of arFA.controls; let i = index"
                  [formGroupName]="i"
                  [class.overdue-row]="isOverdue(fg.get('date')?.value)"
                >
                  <td>{{ fg.get("type")!.value }}</td>
                  <td>{{ fg.get("date")!.value }}</td>
                  <td>{{ fg.get("no")!.value }}</td>
                  <td class="r">
                    {{ fg.get("orgAmt")!.value | number : "1.2-2" }}
                  </td>
                  <td class="r">
                    <span
                      [class.blue]="(fg.get('outstanding')?.value || 0) > 0"
                    >
                      {{ fg.get("outstanding")?.value | number : "1.2-2" }}
                    </span>
                  </td>
                  <td class="r">
                    <input
                      style="width: 100%"
                      appAmount
                      formControlName="pay"
                      (input)="clampPay(arFA.at(i), 'ar')"
                      [disabled]="isReadOnly"
                    />
                  </td>
                  <!-- Alloc -->
                  <td class="c">
                    <input
                      type="checkbox"
                      formControlName="alloc"
                      (change)="toggleAlloc(arFA.at(i), 'ar')"
                      [disabled]="isReadOnly"
                    />
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr class="sum">
                  <td colspan="3">Total</td>
                  <td class="r">{{ sumOrg("ar") | number : "1.2-2" }}</td>
                  <td class="r">
                    <span [class.blue]="sumOutstanding('ar') > 0">
                      {{ sumOutstanding("ar") | number : "1.2-2" }}
                    </span>
                  </td>
                  <td colspan="2"></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <br />

        <!-- ===== KNOCK-OFF A/P ===== -->
        <div class="box">
          <div class="totals-grid">
            <div class="label">Unapplied Amount</div>
            <div class="value">{{ unappliedAP() | number : "1.2-2" }}</div>
          </div>
          <div
            class="title sm"
            style="
              display: flex;
              justify-content: space-between;
              align-items: flex-start;
            "
          >
            <div style="font-weight: bold">
              Knock-off A/P Invoices / Debit Notes
              <span class="party">{{ creditorName }}</span>
            </div>
            <div class="side-stack">
              <button
                class="btn primary"
                type="button"
                (click)="autoAllocate('ap')"
                [disabled]="!canAllocate"
              >
                Auto Allocate
              </button>
            </div>
          </div>

          <div formArrayName="ap" class="tablewrap">
            <table class="table bordered">
              <thead>
                <tr>
                  <th class="sortable" (click)="sortKnock('ap', 'type')">
                    Type
                    <span class="sort" [class.on]="knSort.ap.key === 'type'">{{
                      knSort.ap.dir === "asc" ? "▲" : "▼"
                    }}</span>
                  </th>
                  <th class="sortable" (click)="sortKnock('ap', 'date')">
                    Date
                    <span class="sort" [class.on]="knSort.ap.key === 'date'">{{
                      knSort.ap.dir === "asc" ? "▲" : "▼"
                    }}</span>
                  </th>
                  <th class="sortable" (click)="sortKnock('ap', 'no')">
                    No.
                    <span class="sort" [class.on]="knSort.ap.key === 'no'">{{
                      knSort.ap.dir === "asc" ? "▲" : "▼"
                    }}</span>
                  </th>
                  <th class="r sortable" (click)="sortKnock('ap', 'orgAmt')">
                    Org. Amt.
                    <span
                      class="sort"
                      [class.on]="knSort.ap.key === 'orgAmt'"
                      >{{ knSort.ap.dir === "asc" ? "▲" : "▼" }}</span
                    >
                  </th>
                  <th class="r">Outstanding</th>
                  <th class="r">Pay</th>
                  <th class="c"></th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="let fg of apFA.controls; let i = index"
                  [formGroupName]="i"
                  [class.overdue-row]="isOverdue(fg.get('date')?.value)"
                >
                  <td>{{ fg.get("type")!.value }}</td>
                  <td>{{ fg.get("date")!.value }}</td>
                  <td>{{ fg.get("no")!.value }}</td>
                  <td class="r">
                    {{ fg.get("orgAmt")!.value | number : "1.2-2" }}
                  </td>
                  <td class="r">
                    <span
                      [class.blue]="(fg.get('outstanding')?.value || 0) > 0"
                    >
                      {{ fg.get("outstanding")?.value | number : "1.2-2" }}
                    </span>
                  </td>
                  <td class="r">
                    <input
                      style="width: 100%"
                      appAmount
                      formControlName="pay"
                      (input)="clampPay(apFA.at(i), 'ap')"
                      [disabled]="isReadOnly"
                    />
                  </td>
                  <td class="c">
                    <input
                      type="checkbox"
                      formControlName="alloc"
                      (change)="toggleAlloc(apFA.at(i), 'ap')"
                      [disabled]="isReadOnly"
                    />
                  </td>
                </tr>
              </tbody>
              <tfoot>
                <tr class="sum">
                  <td colspan="3">Total</td>
                  <td class="r">{{ sumOrg("ap") | number : "1.2-2" }}</td>
                  <td class="r">
                    <span [class.blue]="sumOutstanding('ap') > 0">
                      {{ sumOutstanding("ap") | number : "1.2-2" }}
                    </span>
                  </td>
                  <td colspan="2"></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <div class="dialog-actions">
          <label class="chk">
            <input type="checkbox" />
            <span>After save, proceed with new debit note entry</span>
          </label>
          <span class="spacer"></span>
          <button class="btn cancel" (click)="closeContraForm()">Cancel</button>
          <button
            *ngIf="!isReadOnly"
            class="btn primary"
            type="button"
            (click)="saveContra()"
            [disabled]="
              contraForm.invalid ||
              unappliedAR() !== 0 ||
              unappliedAP() !== 0 ||
              !meetsOutstandingRule
            "
          >
            Save
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== Delete confirm ===== -->
  <div class="dialog" *ngIf="showDeleteConfirm">
    <div class="dialog-panel-small">
      <div class="dialog-title">
        Delete Receive Payment
        <button class="x" (click)="showDeleteConfirm = false">×</button>
      </div>
      <div class="dialog-body">
        Are you sure you want to delete <b>{{ selected?.contraNo }}</b
        >?
      </div>
      <div class="dialog-actions">
        <button class="btn" (click)="showDeleteConfirm = false">Cancel</button>
        <button class="btn danger" (click)="doDelete()">Delete</button>
      </div>
    </div>
  </div>
  <div class="dialog" *ngIf="showSuccess">
    <div
      class="dialog-panel-small"
      role="dialog"
      aria-modal="true"
      style="min-width: 360px"
    >
      <div
        class="dialog-title"
        style="background: linear-gradient(180deg, #9be28a 0%, #62c84f 100%)"
      >
        Success
        <button class="x" (click)="closeSuccess()" aria-label="Close">×</button>
      </div>
      <div class="dialog-body">
        <p style="margin: 8px 0; font-weight: 600; color: #14532d">
          {{ successMsg }}
        </p>
      </div>
      <div class="dialog-actions">
        <button class="btn primary" (click)="closeSuccess()">OK</button>
      </div>
    </div>
  </div>
  <div class="dialog" *ngIf="showSaveConfirm">
    <div class="dialog-panel-small">
      <div class="dialog-title">
        Confirm
        <button class="x" (click)="cancelConfirmSave()">×</button>
      </div>
      <div class="dialog-body">
        {{ confirmMsg }}
      </div>
      <div class="dialog-actions">
        <button class="btn cancel" (click)="cancelConfirmSave()">Cancel</button>
        <button class="btn primary" (click)="doConfirmSave()">OK</button>
      </div>
    </div>
  </div>
</div>
