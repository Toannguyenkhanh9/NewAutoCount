<div class="page">

  <!-- Options -->
  <div class="options">
    <form [formGroup]="fg">
      <fieldset class="filters">
        <div class="inv-field">
          <div class="inv-label">From Date</div>
          <div class="">
            <input type="date" formControlName="fromDate" />
          </div>
        </div>

        <div class="inv-field">
          <div class="inv-label">To Date</div>
          <div class="">
            <input type="date" formControlName="toDate" />
          </div>
        </div>

        <div class="inv-field">
          <div class="inv-label">Creditor</div>
          <div class="">
            <select formControlName="debtor">
              <option value="ALL">All</option>
              <option *ngFor="let d of debtors" [value]="d.code">
                {{ d.name }}
              </option>
            </select>
          </div>
        </div>

        <div class="inv-field">
          <div class="inv-label">Debtor Type</div>
          <div class="">
            <select formControlName="debtorType">
              <option value="ALL">All</option>
              <option *ngFor="let t of debtorTypes" [value]="t">
                {{ t }}
              </option>
            </select>
          </div>
        </div>

        <div class="inv-field">
          <div class="inv-label">Aging Months</div>
          <div class="">
            <select formControlName="agingMonths">
              <option [value]="4">4</option>
              <option [value]="6">6</option>
            </select>
          </div>
        </div>

        <div class="inv-field">
          <div class="inv-label">Group by</div>
          <div class="">
            <select formControlName="groupBy">
              <option value="none">None</option>
              <option value="debtorType">Debtor Type</option>
            </select>
          </div>
        </div>

        <!-- Inquiry (right aligned like Outstanding) -->
        <div class="f action">
          <div class="lbl">&nbsp;</div>
          <div class="ctl">
            <button type="button" class="ac-btn ac-btn-primary" (click)="inquiry()">Inquiry</button>
          </div>
        </div>
      </fieldset>
    </form>
  </div>

<!-- Report Card -->
<div class="report-card">
  <div class="report-head">
    <div class="rh-title">Debtor Aging Report</div>
    <div class="rh-company">{{ companyName }}</div>
    <div class="rh-period">{{ periodLabel }}</div>
  </div>

  <!-- LIST MODE -->
  <ng-container *ngIf="viewMode() === 'list'">

    <!-- Table (no group) -->
    <div class="gridwrap" *ngIf="!showGrouped()">
      <table>
        <thead>
          <tr>
            <th class="l" (click)="onHeaderSort('debtorCode')">
              Debtor No.
              <span class="arrow" *ngIf="sortKey() === 'debtorCode'">
                {{ sortDir() === "asc" ? "▲" : "▼" }}
              </span>
            </th>

            <th class="l" (click)="onHeaderSort('debtorName')">
              Company Name
              <span class="arrow" *ngIf="sortKey() === 'debtorName'">
                {{ sortDir() === "asc" ? "▲" : "▼" }}
              </span>
            </th>

            <th class="l">Currency</th>

            <th class="r">CURRENT</th>
            <th class="r">1 MONTH</th>
            <th class="r">2 MONTHS</th>
            <th class="r">3 MONTHS</th>
            <th class="r" *ngIf="colShown('m4')">4 MONTHS</th>
            <th class="r" *ngIf="colShown('over5')">5 &amp; OVER</th>
            <th class="r">Total Over Due</th>

            <th class="r" (click)="onHeaderSort('balance')">
              Balance
              <span class="arrow" *ngIf="sortKey() === 'balance'">
                {{ sortDir() === "asc" ? "▲" : "▼" }}
              </span>
            </th>
          </tr>
        </thead>

        <tbody>
          <tr class="debtor" *ngFor="let r of rows()">
            <td class="l">
              <a href="#" class="link" (click)="openDetail(r); $event.preventDefault()">
                {{ r.debtorCode }}
              </a>
            </td>
            <td class="l">{{ r.debtorName }}</td>
            <td class="l">{{ r.currency }}</td>

            <td class="r">{{ r.totals.cur | number : "1.2-2" }}</td>
            <td class="r">{{ r.totals.m1 | number : "1.2-2" }}</td>
            <td class="r">{{ r.totals.m2 | number : "1.2-2" }}</td>
            <td class="r">{{ r.totals.m3 | number : "1.2-2" }}</td>
            <td class="r" *ngIf="colShown('m4')">{{ (r.totals.m4 ?? 0) | number : "1.2-2" }}</td>
            <td class="r" *ngIf="colShown('over5')">{{ (r.totals.over5 ?? 0) | number : "1.2-2" }}</td>
            <td class="r">{{ r.totals.totalOverDue | number : "1.2-2" }}</td>
            <td class="r">{{ r.totals.balance | number : "1.2-2" }}</td>
          </tr>
        </tbody>

        <tfoot class="sum-row">
          <tr>
            <td colspan="3" class="r">Total</td>
            <td class="r blue">{{ totalsAll.cur | number : "1.2-2" }}</td>
            <td class="r blue">{{ totalsAll.m1 | number : "1.2-2" }}</td>
            <td class="r blue">{{ totalsAll.m2 | number : "1.2-2" }}</td>
            <td class="r blue">{{ totalsAll.m3 | number : "1.2-2" }}</td>
            <td class="r blue" *ngIf="colShown('m4')">{{ totalsAll.m4 | number : "1.2-2" }}</td>
            <td class="r blue" *ngIf="colShown('over5')">{{ totalsAll.over5 | number : "1.2-2" }}</td>
            <td class="r blue">{{ totalsAll.totalOverDue | number : "1.2-2" }}</td>
            <td class="r blue">{{ totalsAll.balance | number : "1.2-2" }}</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Grouped view -->
    <div class="gridwrap" *ngIf="showGrouped()">
      <table>
        <thead>
          <tr>
            <th class="l" (click)="onHeaderSort('debtorCode')">
              Debtor No.
              <span class="arrow" *ngIf="sortKey() === 'debtorCode'">
                {{ sortDir() === "asc" ? "▲" : "▼" }}
              </span>
            </th>

            <th class="l" (click)="onHeaderSort('debtorName')">
              Company Name
              <span class="arrow" *ngIf="sortKey() === 'debtorName'">
                {{ sortDir() === "asc" ? "▲" : "▼" }}
              </span>
            </th>

            <th class="l">Currency</th>

            <th class="r">CURRENT</th>
            <th class="r">1 MONTH</th>
            <th class="r">2 MONTHS</th>
            <th class="r">3 MONTHS</th>
            <th class="r" *ngIf="colShown('m4')">4 MONTHS</th>
            <th class="r" *ngIf="colShown('over5')">5 &amp; OVER</th>
            <th class="r">Total Over Due</th>

            <th class="r" (click)="onHeaderSort('balance')">
              Balance
              <span class="arrow" *ngIf="sortKey() === 'balance'">
                {{ sortDir() === "asc" ? "▲" : "▼" }}
              </span>
            </th>
          </tr>
        </thead>

        <ng-container *ngFor="let g of groups()">
          <tbody class="group-head">
            <tr>
              <td colspan="11">
                <strong>Debtor Type: {{ g.key }}</strong>
                &nbsp; — Total Debtor: {{ g.items.length }}
              </td>
            </tr>
          </tbody>

          <tbody>
            <tr class="debtor" *ngFor="let r of g.items">
              <td class="l">
                <a href="#" class="link" (click)="openDetail(r); $event.preventDefault()">
                  {{ r.debtorCode }}
                </a>
              </td>
              <td class="l">{{ r.debtorName }}</td>
              <td class="l">{{ r.currency }}</td>

              <td class="r">{{ r.totals.cur | number : "1.2-2" }}</td>
              <td class="r">{{ r.totals.m1 | number : "1.2-2" }}</td>
              <td class="r">{{ r.totals.m2 | number : "1.2-2" }}</td>
              <td class="r">{{ r.totals.m3 | number : "1.2-2" }}</td>
              <td class="r" *ngIf="colShown('m4')">{{ (r.totals.m4 ?? 0) | number : "1.2-2" }}</td>
              <td class="r" *ngIf="colShown('over5')">{{ (r.totals.over5 ?? 0) | number : "1.2-2" }}</td>
              <td class="r">{{ r.totals.totalOverDue | number : "1.2-2" }}</td>
              <td class="r">{{ r.totals.balance | number : "1.2-2" }}</td>
            </tr>
          </tbody>
        </ng-container>

        <tfoot class="sum-row">
          <tr>
            <td colspan="3" class="r"><strong>Total</strong></td>
            <td class="r blue">{{ totalsAll.cur | number : "1.2-2" }}</td>
            <td class="r blue">{{ totalsAll.m1 | number : "1.2-2" }}</td>
            <td class="r blue">{{ totalsAll.m2 | number : "1.2-2" }}</td>
            <td class="r blue">{{ totalsAll.m3 | number : "1.2-2" }}</td>
            <td class="r blue" *ngIf="colShown('m4')">{{ totalsAll.m4 | number : "1.2-2" }}</td>
            <td class="r blue" *ngIf="colShown('over5')">{{ totalsAll.over5 | number : "1.2-2" }}</td>
            <td class="r blue">{{ totalsAll.totalOverDue | number : "1.2-2" }}</td>
            <td class="r blue">{{ totalsAll.balance | number : "1.2-2" }}</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </ng-container>


    <ng-container *ngIf="viewMode() === 'detail' && selected() as s">
      <div class="gridwrap">
        <div class="detail-toolbar">
         <a href="#" (click)="backToList(); $event.preventDefault()">
                  ←
                </a>
          <div class="detail-title">
            <strong>{{ s.debtorCode }}</strong> — {{ s.debtorName }} ({{ s.currency }})
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th class="l">Doc Date</th>
              <th class="l">Due Date</th>
              <th class="l">Doc Type</th>
              <th class="c">Is OverDue</th>
              <th class="r">CURRENT</th>
              <th class="r">1 MONTH</th>
              <th class="r">2 MONTHS</th>
              <th class="r">3 MONTHS</th>
              <th class="r" *ngIf="colShown('m4')">4 MONTHS</th>
              <th class="r" *ngIf="colShown('over5')">5 &amp; OVER</th>
              <th class="r">Balance</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let t of s.txns">
              <td class="l">{{ t.docDate }}</td>
              <td class="l">{{ t.dueDate }}</td>
              <td class="l">{{ t.docType }}</td>
              <td class="c">
                <input type="checkbox" [checked]="t.isOverDue" disabled />
              </td>
              <td class="r">{{ t.buckets?.cur ?? 0 | number : "1.2-2" }}</td>
              <td class="r">{{ t.buckets?.m1 ?? 0 | number : "1.2-2" }}</td>
              <td class="r">{{ t.buckets?.m2 ?? 0 | number : "1.2-2" }}</td>
              <td class="r">{{ t.buckets?.m3 ?? 0 | number : "1.2-2" }}</td>
              <td class="r" *ngIf="colShown('m4')">{{ t.buckets?.m4 ?? 0 | number : "1.2-2" }}</td>
              <td class="r" *ngIf="colShown('over5')">{{ t.buckets?.over5 ?? 0 | number : "1.2-2" }}</td>
              <td class="r">{{ (t.runBalance ?? t.buckets?.balance ?? 0) | number : "1.2-2" }}</td>
            </tr>
          </tbody>
          <tfoot class="sum-row">
            <tr>
              <td colspan="4" class="r">Total</td>
              <td class="r blue">{{ s.totals.cur | number : "1.2-2" }}</td>
              <td class="r blue">{{ s.totals.m1 | number : "1.2-2" }}</td>
              <td class="r blue">{{ s.totals.m2 | number : "1.2-2" }}</td>
              <td class="r blue">{{ s.totals.m3 | number : "1.2-2" }}</td>
              <td class="r blue" *ngIf="colShown('m4')">{{ s.totals.m4 | number : "1.2-2" }}</td>
              <td class="r blue" *ngIf="colShown('over5')">{{ s.totals.over5 | number : "1.2-2" }}</td>
              <td class="r blue">{{ s.totals.balance | number : "1.2-2" }}</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </ng-container>

  </div>

</div>
