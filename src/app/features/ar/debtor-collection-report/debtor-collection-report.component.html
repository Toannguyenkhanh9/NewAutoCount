<div class="page">
  <!-- Filters -->
  <div class="options">
    <form [formGroup]="fg" class="options">
      <fieldset class="filters">
        <!-- Date range -->
        <div class="inv-field">
          <div class="inv-label">Date From</div>
          <div class="">
            <input type="date" formControlName="dateFrom" />
          </div>
        </div>

        <div class="inv-field">
          <div class="inv-label">Date To</div>
          <div class="">
            <input type="date" formControlName="dateTo" />
          </div>
        </div>

        <!-- Debtor: multi select -->
        <div class="inv-field">
          <div class="inv-label">Debtor</div>
          <div class="">
            <div class="ms" (click)="onToggleDebtor($event)">
              <span class="ms-text">{{ debtorSummary }}</span>
              <span class="caret">▾</span>
            </div>

            <div
              class="ms-panel"
              *ngIf="debtorDropOpen"
              (click)="$event.stopPropagation()"
            >
              <label class="row all">
                <input
                  type="checkbox"
                  [checked]="
                    selectedDebtors.length === debtors.length &&
                    debtors.length > 0
                  "
                  (change)="selectAllDebtors($any($event.target).checked)"
                />
                <span>Select all</span>
              </label>

              <div class="list">
                <label class="row" *ngFor="let d of debtors">
                  <input
                    type="checkbox"
                    [checked]="isDebtorChecked(d.code)"
                    (change)="
                      toggleDebtor(d.code, $any($event.target).checked)
                    "
                  />
                  <span>{{ d.code }} — {{ d.name }}</span>
                </label>
              </div>

              <div class="actions">
                <button
                  type="button"
                  class="btn sm"
                  (click)="closeDebtor()"
                >
                  OK
                </button>
                <button
                  type="button"
                  class="btn sm ghost"
                  (click)="selectAllDebtors(false)"
                >
                  Clear
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Type: multi select -->
        <div class="inv-field">
          <div class="inv-label">Payment Type</div>
          <div class="">
            <div class="ms" (click)="onTogglePaymentType($event)">
              <span class="ms-text">{{ paymentTypeSummary }}</span>
              <span class="caret">▾</span>
            </div>

            <div
              class="ms-panel"
              *ngIf="paymentTypeDropOpen"
              (click)="$event.stopPropagation()"
            >
              <label class="row all">
                <input
                  type="checkbox"
                  [checked]="
                    selectedPaymentTypes.length === paymentTypes.length &&
                    paymentTypes.length > 0
                  "
                  (change)="
                    selectAllPaymentTypes($any($event.target).checked)
                  "
                />
                <span>Select all</span>
              </label>

              <div class="list">
                <label class="row" *ngFor="let p of paymentTypes">
                  <input
                    type="checkbox"
                    [checked]="isPaymentTypeChecked(p.value)"
                    (change)="
                      togglePaymentType(
                        p.value,
                        $any($event.target).checked
                      )
                    "
                  />
                  <span>{{ p.label }}</span>
                </label>
              </div>

              <div class="actions">
                <button
                  type="button"
                  class="btn sm"
                  (click)="closePaymentType()"
                >
                  OK
                </button>
                <button
                  type="button"
                  class="btn sm ghost"
                  (click)="selectAllPaymentTypes(false)"
                >
                  Clear
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Group by -->
        <div class="inv-field">
          <div class="inv-label">Group by</div>
          <div class="">
            <select formControlName="groupBy">
              <option value="none">None</option>
              <option value="debtorType">Debtor Type</option>
            </select>
          </div>
        </div>

        <!-- Debtor Type -->
        <div class="inv-field">
          <div class="inv-label">Debtor Type</div>
          <div class="">
            <select formControlName="debtorType">
              <option value="ALL">All</option>
              <option *ngFor="let t of debtorTypes" [value]="t">
                {{ t }}
              </option>
            </select>
          </div>
        </div>

        <!-- Currency -->
        <div class="inv-field">
          <div class="inv-label">Currency</div>
          <div class="">
            <select formControlName="currency">
              <option value="ALL">All</option>
              <option *ngFor="let c of currencies" [value]="c">
                {{ c }}
              </option>
            </select>
          </div>
        </div>

        <!-- Cancelled Status -->
        <div class="inv-field">
          <div class="inv-label">Cancelled Status</div>
          <div class="">
            <select formControlName="cancelledStatus">
              <option
                *ngFor="let s of cancelledStatuses"
                [value]="s.value"
              >
                {{ s.label }}
              </option>
            </select>
          </div>
        </div>

        <!-- Inquiry -->
        <div class="f action">
          <div class="lbl">&nbsp;</div>
          <div class="ctl">
            <button type="button" class="ac-btn ac-btn-primary" (click)="inquiry()"> Inquiry
            </button>
          </div>
        </div>
      </fieldset>
    </form>
  </div>
<div class="report-card">
    <div class="report-head">
    <div class="rh-title">Debtor Collection Report</div>
    <div class="rh-company">{{ companyName }}</div>
    <div class="rh-period">{{ periodLabel }}</div>
  </div>
  <ng-container *ngIf="viewMode() === 'list'">
  <!-- ========== NORMAL VIEW ========== -->
  <div class="gridwrap" *ngIf="!showGrouped()">
    <table>
      <thead>
        <tr>
          <th class="l" (click)="onHeaderSort('debtorCode')">
            Debtor Code
            <span *ngIf="sortKey() === 'debtorCode'" class="arrow">
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th class="l" (click)="onHeaderSort('debtorName')">
            Company Name
            <span *ngIf="sortKey() === 'debtorName'" class="arrow">
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th class="l" (click)="onHeaderSort('debtorType')">
            Debtor Type
            <span *ngIf="sortKey() === 'debtorType'" class="arrow">
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th class="l" (click)="onHeaderSort('phone')">
            Phone
            <span *ngIf="sortKey() === 'phone'" class="arrow">
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th class="l" (click)="onHeaderSort('currency')">
            Currency
            <span *ngIf="sortKey() === 'currency'" class="arrow">
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th class="r" (click)="onHeaderSort('totalPrePayment')">
            PrePayment
            <span *ngIf="sortKey() === 'totalPrePayment'" class="arrow">
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th class="r" (click)="onHeaderSort('totalAmount')">
            Payment Amount
            <span *ngIf="sortKey() === 'totalAmount'" class="arrow">
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th class="r" (click)="onHeaderSort('avgAge')">
            Average Age
            <span *ngIf="sortKey() === 'avgAge'" class="arrow">
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th class="r" (click)="onHeaderSort('avgPaymentDays')">
            Average Payment Days
            <span *ngIf="sortKey() === 'avgPaymentDays'" class="arrow">
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>
        </tr>
      </thead>

      <tbody>
        <tr class="debtor" *ngFor="let r of rows()">
          <td class="l">
            <a href="#" class="link" (click)="openDetail(r); $event.preventDefault()">
              {{ r.debtorCode }}
            </a>
          </td>
          <td class="l">{{ r.debtorName }}</td>
          <td class="l">{{ r.debtorType }}</td>
          <td class="l">{{ r.phone }}</td>
          <td class="l">{{ r.currency }}</td>
          <td class="r">{{ r.totalPrePayment | number : '1.2-2' }}</td>
          <td class="r">{{ r.totalAmount | number : '1.2-2' }}</td>
          <td class="r">{{ r.avgAge | number : '1.0-0' }}</td>
          <td class="r">{{ r.avgPaymentDays | number : '1.0-0' }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ========== GROUPED VIEW ========== -->
  <div class="gridwrap" *ngIf="showGrouped()">
    <table>
      <thead>
        <tr>
          <th class="l">Debtor Code</th>
          <th class="l">Company Name</th>
          <th class="l">Debtor Type</th>
          <th class="l">Phone</th>
          <th class="l">Currency</th>
          <th class="r">PrePayment</th>
          <th class="r">Payment Amount</th>
          <th class="r">Average Age</th>
          <th class="r">Average Payment Days</th>
        </tr>
      </thead>

      <ng-container *ngFor="let g of groups()">
        <tbody class="group-head">
          <tr>
            <td colspan="9">
              <strong>
                {{ fg.value.groupBy === 'area' ? 'Area' : 'Debtor Type' }}:
                {{ g.key }}
              </strong>
              — Total Debtor: {{ g.items.length }}
            </td>
          </tr>
        </tbody>

        <tbody>
          <tr class="debtor" *ngFor="let r of g.items">
            <td class="l">
              <a href="#" class="link" (click)="openDetail(r); $event.preventDefault()">
                {{ r.debtorCode }}
              </a>
            </td>
            <td>{{ r.debtorName }}</td>
            <td>{{ r.debtorType }}</td>
            <td>{{ r.phone }}</td>
            <td class="c">{{ r.currency }}</td>
            <td class="r">{{ r.totalPrePayment | number : '1.2-2' }}</td>
            <td class="r">{{ r.totalAmount | number : '1.2-2' }}</td>
            <td class="r">{{ r.avgAge | number : '1.0-0' }}</td>
            <td class="r">{{ r.avgPaymentDays | number : '1.0-0' }}</td>
          </tr>
        </tbody>
      </ng-container>
    </table>
  </div>
</ng-container>

<!-- ========== DETAIL VIEW ========== -->
<ng-container *ngIf="viewMode() === 'detail' && selected() as r">
  <div class="gridwrap">
    <div class="detail-toolbar">
      <a href="#" class="back-link" (click)="backToList(); $event.preventDefault()">←</a>
      <div class="detail-title">
        <strong>{{ r.debtorCode }}</strong> — {{ r.debtorName }} ({{ r.currency }})
      </div>
    </div>

    <table class="grid detail-yellow">
      <thead>
        <tr>
          <th class="l">Doc No</th>
          <th class="l">Doc Date</th>
          <th class="l">Doc Type</th>
          <th class="l">Description</th>
          <th class="l">Currency</th>
          <th class="l">Cheque No</th>
          <th class="r">PrePayment</th>
          <th class="r">Amount</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let d of r.details">
          <td class="l">{{ d.docNo }}</td>
          <td class="l">{{ d.docDate }}</td>
          <td class="l">{{ d.docType }}</td>
          <td class="l">{{ d.description }}</td>
          <td class="l">{{ d.currency }}</td>
          <td class="l">{{ d.chequeNo }}</td>
          <td class="r">{{ d.prePayment | number : '1.2-2' }}</td>
          <td class="r">{{ d.amount | number : '1.2-2' }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</ng-container>
</div>
</div>
