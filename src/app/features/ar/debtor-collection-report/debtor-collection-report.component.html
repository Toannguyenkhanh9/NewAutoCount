<div class="page">
  <div class="titlebar">
    <h1>Debtor Collection Report</h1>
  </div>

  <!-- Filters -->
  <div class="options">
    <form [formGroup]="fg" class="options">
      <fieldset class="filters">
        <!-- Date range -->
        <div class="f">
          <div class="lbl">Date From</div>
          <div class="ctl">
            <input type="date" formControlName="dateFrom" />
          </div>
        </div>

        <div class="f">
          <div class="lbl">Date To</div>
          <div class="ctl">
            <input type="date" formControlName="dateTo" />
          </div>
        </div>

        <!-- Debtor: multi select -->
        <div class="f">
          <div class="lbl">Debtor</div>
          <div class="ctl">
            <div class="ms" (click)="onToggleDebtor($event)">
              <span class="ms-text">{{ debtorSummary }}</span>
              <span class="caret">▾</span>
            </div>

            <div
              class="ms-panel"
              *ngIf="debtorDropOpen"
              (click)="$event.stopPropagation()"
            >
              <label class="row all">
                <input
                  type="checkbox"
                  [checked]="
                    selectedDebtors.length === debtors.length &&
                    debtors.length > 0
                  "
                  (change)="selectAllDebtors($any($event.target).checked)"
                />
                <span>Select all</span>
              </label>

              <div class="list">
                <label class="row" *ngFor="let d of debtors">
                  <input
                    type="checkbox"
                    [checked]="isDebtorChecked(d.code)"
                    (change)="
                      toggleDebtor(d.code, $any($event.target).checked)
                    "
                  />
                  <span>{{ d.code }} — {{ d.name }}</span>
                </label>
              </div>

              <div class="actions">
                <button
                  type="button"
                  class="btn sm"
                  (click)="closeDebtor()"
                >
                  OK
                </button>
                <button
                  type="button"
                  class="btn sm ghost"
                  (click)="selectAllDebtors(false)"
                >
                  Clear
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Payment Type: multi select -->
        <div class="f">
          <div class="lbl">Payment Type</div>
          <div class="ctl">
            <div class="ms" (click)="onTogglePaymentType($event)">
              <span class="ms-text">{{ paymentTypeSummary }}</span>
              <span class="caret">▾</span>
            </div>

            <div
              class="ms-panel"
              *ngIf="paymentTypeDropOpen"
              (click)="$event.stopPropagation()"
            >
              <label class="row all">
                <input
                  type="checkbox"
                  [checked]="
                    selectedPaymentTypes.length === paymentTypes.length &&
                    paymentTypes.length > 0
                  "
                  (change)="
                    selectAllPaymentTypes($any($event.target).checked)
                  "
                />
                <span>Select all</span>
              </label>

              <div class="list">
                <label class="row" *ngFor="let p of paymentTypes">
                  <input
                    type="checkbox"
                    [checked]="isPaymentTypeChecked(p.value)"
                    (change)="
                      togglePaymentType(
                        p.value,
                        $any($event.target).checked
                      )
                    "
                  />
                  <span>{{ p.label }}</span>
                </label>
              </div>

              <div class="actions">
                <button
                  type="button"
                  class="btn sm"
                  (click)="closePaymentType()"
                >
                  OK
                </button>
                <button
                  type="button"
                  class="btn sm ghost"
                  (click)="selectAllPaymentTypes(false)"
                >
                  Clear
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Group by -->
        <div class="f">
          <div class="lbl">Group by</div>
          <div class="ctl">
            <select formControlName="groupBy">
              <option value="none">None</option>
              <option value="debtorType">Debtor Type</option>
            </select>
          </div>
        </div>

        <!-- Debtor Type -->
        <div class="f">
          <div class="lbl">Debtor Type</div>
          <div class="ctl">
            <select formControlName="debtorType">
              <option value="ALL">All</option>
              <option *ngFor="let t of debtorTypes" [value]="t">
                {{ t }}
              </option>
            </select>
          </div>
        </div>

        <!-- Currency -->
        <div class="f">
          <div class="lbl">Currency</div>
          <div class="ctl">
            <select formControlName="currency">
              <option value="ALL">All</option>
              <option *ngFor="let c of currencies" [value]="c">
                {{ c }}
              </option>
            </select>
          </div>
        </div>

        <!-- Cancelled Status -->
        <div class="f">
          <div class="lbl">Cancelled Status</div>
          <div class="ctl">
            <select formControlName="cancelledStatus">
              <option
                *ngFor="let s of cancelledStatuses"
                [value]="s.value"
              >
                {{ s.label }}
              </option>
            </select>
          </div>
        </div>

        <!-- Inquiry -->
        <div class="f">
          <div class="lbl"></div>
          <div class="ctl">
            <br />
            <button
              type="button"
              class="btn primary"
              (click)="inquiry()"
            >
              <span class="ico refresh"></span>
              Inquiry
            </button>
          </div>
        </div>
      </fieldset>
    </form>
  </div>

  <!-- ========== NORMAL VIEW ========== -->
  <div class="gridwrap" *ngIf="!showGrouped()">
    <table>
      <thead>
        <tr>
          <th class="toggle"></th>

          <th (click)="onHeaderSort('debtorCode')">
            Debtor Code
            <span
              *ngIf="sortKey() === 'debtorCode'"
              class="arrow"
            >
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th (click)="onHeaderSort('debtorName')">
            Company Name
            <span
              *ngIf="sortKey() === 'debtorName'"
              class="arrow"
            >
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th (click)="onHeaderSort('debtorType')">
            Debtor Type
            <span
              *ngIf="sortKey() === 'debtorType'"
              class="arrow"
            >
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th (click)="onHeaderSort('phone')">
            Phone
            <span
              *ngIf="sortKey() === 'phone'"
              class="arrow"
            >
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th (click)="onHeaderSort('currency')">
            Currency
            <span
              *ngIf="sortKey() === 'currency'"
              class="arrow"
            >
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th class="r" (click)="onHeaderSort('totalPrePayment')">
            PrePayment
            <span
              *ngIf="sortKey() === 'totalPrePayment'"
              class="arrow"
            >
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th class="r" (click)="onHeaderSort('totalAmount')">
            Payment Amount
            <span
              *ngIf="sortKey() === 'totalAmount'"
              class="arrow"
            >
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th class="r" (click)="onHeaderSort('avgAge')">
            Average Age
            <span
              *ngIf="sortKey() === 'avgAge'"
              class="arrow"
            >
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>

          <th class="r" (click)="onHeaderSort('avgPaymentDays')">
            Average Payment Days
            <span
              *ngIf="sortKey() === 'avgPaymentDays'"
              class="arrow"
            >
              {{ sortDir() === 'asc' ? '▲' : '▼' }}
            </span>
          </th>
        </tr>
      </thead>

      <tbody *ngFor="let r of rows()">
        <!-- Level 1: Debtor -->
        <tr class="debtor">
          <td class="toggle">
            <button
              class="toggle-btn"
              type="button"
              (click)="toggleRow(r)"
            >
              {{ r.expanded ? '−' : '+' }}
            </button>
          </td>
          <td>{{ r.debtorCode }}</td>
          <td>{{ r.debtorName }}</td>
          <td>{{ r.debtorType }}</td>
          <td>{{ r.phone }}</td>
          <td class="c">{{ r.currency }}</td>
          <td class="r">
            {{ r.totalPrePayment | number : '1.2-2' }}
          </td>
          <td class="r">
            {{ r.totalAmount | number : '1.2-2' }}
          </td>
          <td class="r">
            {{ r.avgAge | number : '1.0-0' }}
          </td>
          <td class="r">
            {{ r.avgPaymentDays | number : '1.0-0' }}
          </td>
        </tr>

        <!-- Level 2: Details -->
        <tr class="detail-row" *ngIf="r.expanded">
          <td [attr.colspan]="10">
            <div class="detail-wrap full">
              <table class="grid detail-yellow">
                <thead>
                  <tr>
                    <th>Doc No</th>
                    <th>Doc Date</th>
                    <th>Doc Type</th>
                    <th>Description</th>
                    <th>Currency</th>
                    <th>Cheque No</th>
                    <th class="r">PrePayment</th>
                    <th class="r">Amount</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let d of r.details">
                    <td>{{ d.docNo }}</td>
                    <td>{{ d.docDate }}</td>
                    <td class="c">{{ d.docType }}</td>
                    <td>{{ d.description }}</td>
                    <td class="c">{{ d.currency }}</td>
                    <td>{{ d.chequeNo }}</td>
                    <td class="r">
                      {{ d.prePayment | number : '1.2-2' }}
                    </td>
                    <td class="r">
                      {{ d.amount | number : '1.2-2' }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </td>
        </tr>
      </tbody>
<!--
      <tfoot class="sum-row">
        <tr>
          <td colspan="6" class="r"><strong>Total</strong></td>
          <td class="r">
            <strong>
              {{ totals().prePayment | number : '1.2-2' }}
            </strong>
          </td>
          <td class="r">
            <strong>
              {{ totals().amount | number : '1.2-2' }}
            </strong>
          </td>
          <td colspan="2"></td>
        </tr>
      </tfoot> -->
    </table>
  </div>

  <!-- ========== GROUPED VIEW ========== -->
  <div class="gridwrap" *ngIf="showGrouped()">
    <table>
      <thead>
        <tr>
          <th class="toggle"></th>
          <th>Debtor Code</th>
          <th>Company Name</th>
          <th>Debtor Type</th>
          <th>Phone</th>
          <th>Currency</th>
          <th class="r">PrePayment</th>
          <th class="r">Payment Amount</th>
          <th class="r">Average Age</th>
          <th class="r">Average Payment Days</th>
        </tr>
      </thead>

      <ng-container *ngFor="let g of groups()">
        <tbody class="group-head">
          <tr>
            <td colspan="10">
              <strong>
                {{ fg.value.groupBy === 'area' ? 'Area' : 'Debtor Type' }}:
                {{ g.key }}
              </strong>
              — Total Debtor: {{ g.items.length }}
            </td>
          </tr>
        </tbody>

        <tbody *ngFor="let r of g.items">
          <tr class="debtor">
            <td class="toggle">
              <button
                class="toggle-btn"
                type="button"
                (click)="toggleRow(r)"
              >
                {{ r.expanded ? '−' : '+' }}
              </button>
            </td>
            <td>{{ r.debtorCode }}</td>
            <td>{{ r.debtorName }}</td>
            <td>{{ r.debtorType }}</td>
            <td>{{ r.phone }}</td>
            <td class="c">{{ r.currency }}</td>
            <td class="r">
              {{ r.totalPrePayment | number : '1.2-2' }}
            </td>
            <td class="r">
              {{ r.totalAmount | number : '1.2-2' }}
            </td>
            <td class="r">
              {{ r.avgAge | number : '1.0-0' }}
            </td>
            <td class="r">
              {{ r.avgPaymentDays | number : '1.0-0' }}
            </td>
          </tr>

          <tr class="detail-row" *ngIf="r.expanded">
            <td [attr.colspan]="10">
              <div class="detail-wrap full">
                <table class="grid detail-yellow">
                  <thead>
                    <tr>
                      <th>Doc No</th>
                      <th>Doc Date</th>
                      <th>Doc Type</th>
                      <th>Description</th>
                      <th>Currency</th>
                      <th>Cheque No</th>
                      <th class="r">PrePayment</th>
                      <th class="r">Amount</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let d of r.details">
                      <td>{{ d.docNo }}</td>
                      <td>{{ d.docDate }}</td>
                      <td class="c">{{ d.docType }}</td>
                      <td>{{ d.description }}</td>
                      <td class="c">{{ d.currency }}</td>
                      <td>{{ d.chequeNo }}</td>
                      <td class="r">
                        {{ d.prePayment | number : '1.2-2' }}
                      </td>
                      <td class="r">
                        {{ d.amount | number : '1.2-2' }}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </td>
          </tr>
        </tbody>
      </ng-container>

      <!-- <tfoot class="sum-row">
        <tr>
          <td colspan="6" class="r"><strong>Total</strong></td>
          <td class="r">
            <strong>
              {{ totals().prePayment | number : '1.2-2' }}
            </strong>
          </td>
          <td class="r">
            <strong>
              {{ totals().amount | number : '1.2-2' }}
            </strong>
          </td>
          <td colspan="2"></td>
        </tr>
      </tfoot> -->
    </table>
  </div>
</div>
