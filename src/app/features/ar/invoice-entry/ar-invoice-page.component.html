<div class="ac-page">
  <!-- ============ HEADER ============ -->
  <div class="ac-page-header">
    <div>
      <div class="ac-page-title">A/R Invoice Entry</div>
      <div class="ac-page-subtitle">
        Record and manage sales invoices and their payment history.
      </div>
    </div>

    <div class="ac-page-toolbar" role="toolbar">
      <input class="ac-form-control ac-page-search" type="text" [(ngModel)]="q"
        placeholder="Search invoice no / company name..." />

      <button type="button" class="ac-btn ac-btn-primary" (click)="newInvoice()">
        <span class="ico plus"></span>
        New
      </button>

      <button type="button" class="ac-btn" [disabled]="!selected" (click)="editInvoice()">
        <span class="ico edit"></span>
        Edit
      </button>

      <button type="button" class="ac-btn ac-btn-danger" [disabled]="!selected" (click)="openDeleteInvoiceConfirm()">
        <span class="ico trash"></span>
        Delete
      </button>
    </div>
  </div>

  <!-- ============ LIST + HISTORY ============ -->
  <div class="list-shell">
    <!-- Main grid -->
    <div class="ac-card ac-card-no-padding main-grid">
      <div class="ac-tablewrap">
        <table class="ac-table">
          <thead>
            <tr>
              <th (click)="setSort('docDate')">Invoice No</th>
              <th (click)="setSort('docNo')">Date</th>
              <th (click)="setSort('debtor')">Company Name</th>
              <th>Description</th>
              <th class="ac-text-right">Total</th>
              <th class="ac-text-right">Outstanding</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let inv of paged" (click)="toggleSelect(inv)" [class.ac-row-selected]="selected === inv"
              [class.ac-row-overdue]="isOverdue(inv)">
              <td>{{ inv.docNo }}</td>
              <td>{{ inv.docDate }}</td>
              <td>{{ inv.debtor }} â€” {{ inv.debtorName }}</td>
              <td>{{ inv.description || '-' }}</td>
              <td class="ac-text-right">
                {{ inv.grandTotal | number : '1.2-2' }}
              </td>
              <td class="ac-text-right">
                {{ inv.outstanding | number : '1.2-2' }}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Payment history -->
    <div class="ac-card ac-card-no-padding payment-panel" *ngIf="selected">
      <div class="pp-head">
        <div class="pp-title">
          Payment History
          <ng-container *ngIf="selected">
            &nbsp;â€”&nbsp;<b>{{ selected.docNo }}</b>
          </ng-container>
        </div>
      </div>

      <div class="pp-body" *ngIf="selected; else noSel">
        <div class="ac-tablewrap">
          <table class="ac-table ac-table-sm">
            <colgroup>
              <col style="width: 12%" />
              <col style="width: 20%" />
              <col style="width: 42%" />
              <col style="width: 13%" />
              <col style="width: 13%" />
            </colgroup>
            <thead>
              <tr>
                <th style="width: 90px">Type</th>
                <th style="width: 120px">No.</th>
                <th>Description</th>
                <th style="width: 120px">Date</th>
                <th class="ac-text-right" style="width: 140px">Amount</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let p of paymentHistory">
                <td>{{ p.type }}</td>
                <td>{{ p.no }}</td>
                <td class="cut">{{ p.description || '-' }}</td>
                <td>{{ p.date }}</td>
                <td class="ac-text-right">
                  {{ p.amount | number : '1.2-2' }}
                </td>
              </tr>
              <tr *ngIf="!paymentHistory.length">
                <td colspan="5" class="ac-text-center ac-text-muted">
                  â€” No payment â€”
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <ng-template #noSel>
        <div class="pp-empty">
          Select an invoice to see its payment history.
        </div>
      </ng-template>
    </div>
  </div>

  <!-- ============ PAGER ============ -->
  <div class="ac-page-footer">
    <div class="ac-pager">
      <button type="button" class="ac-btn ac-pager-btn" (click)="goFirst()">
        &laquo;
      </button>
      <button type="button" class="ac-btn ac-pager-btn" (click)="goPrev()">
        &lsaquo;
      </button>

      <span class="ac-pager-label">
        Page {{ page }} / {{ totalPages }}
      </span>

      <button type="button" class="ac-btn ac-pager-btn" (click)="goNext()">
        &rsaquo;
      </button>
      <button type="button" class="ac-btn ac-pager-btn" (click)="goLast()">
        &raquo;
      </button>
    </div>
  </div>

  <!-- ================== MODALS ================== -->

  <!-- INVOICE FORM (New/Edit/View) -->
  <div class="ac-dialog-backdrop" *ngIf="showForm">
    <div class="dialog-panel ac-card-no-padding ac-dialog-panel-xl">
      <!-- HEADER -->
      <div class="ac-dialog-header">
        <span>
          {{
          formMode === 'new'
          ? 'New A/R Invoice'
          : formMode === 'edit'
          ? 'Edit A/R Invoice'
          : 'View A/R Invoice'
          }}
        </span>
        <button type="button" class="ac-dialog-close" (click)="showForm = false" aria-label="Close">
          âœ•
        </button>
      </div>

      <!-- BODY + SCROLL + FOOTER -->
      <form [formGroup]="invForm" class="ac-dialog-body">
        <!-- VÃ™NG CUá»˜N (giá»‘ng Contra: ac-dialog-scroll) -->
        <div class="ac-dialog-scroll">
          <!-- FORM GRID 3 Cá»˜T -->
          <div class="ac-dialog-form-grid-3">
            <!-- Debtor / Journal / Ref2 -->
            <label>
              Debtor
              <div class="inline-field">
                <select class="ac-form-control" formControlName="debtor" (change)="onDebtorChanged()">
                  <option value="">Select debtor...</option>
                  <option *ngFor="let d of debtors" [ngValue]="d.debtorAccount">
                    {{ d.debtorAccount }} â€” {{ d.companyName }}
                  </option>
                </select>

                <button type="button" class="ac-btn ac-btn-ghost" (click)="openDebtorDropdown()" title="Search debtors"
                  aria-label="Search debtors">
                  ðŸ”Ž
                </button>
              </div>
              <div class="err" *ngIf="isInvalid('debtor')">
                Please select a debtor.
              </div>
            </label>

            <label>
              Journal Type
              <select class="ac-form-control" formControlName="journalType" [disabled]="formMode === 'view'">
                <option *ngFor="let j of journalTypes" [ngValue]="j.typeCode">
                  {{ j.typeCode }}
                </option>
              </select>
            </label>

            <label>
              Ref. No.2
              <input class="ac-form-control" formControlName="ref2" [readonly]="formMode === 'view'" />
            </label>

            <!-- Invoice No / Date / Terms / Due Date -->
            <label>
              Invoice No
              <input class="ac-form-control" formControlName="docNo"
                [readonly]="invForm.value.autoNumbering || formMode !== 'new'" placeholder="&lt;&lt;new&gt;&gt;"
                [class.invalid]="isInvalid('docNo')" />
              <div class="err" *ngIf="isInvalid('docNo')">
                <ng-container *ngIf="invForm.get('docNo')?.errors?.['pattern']">
                  Only letters, numbers, '-', '_' and '/' are allowed.
                </ng-container>
                <ng-container *ngIf="invForm.get('docNo')?.errors?.['duplicate']">
                  This invoice number already exists.
                </ng-container>
              </div>
            </label>

            <label>
              Date
              <input type="date" class="ac-form-control" formControlName="docDate" (change)="recalcDue()"
                [readonly]="formMode === 'view'" />
            </label>

            <label>
              Terms
              <select class="ac-form-control" formControlName="terms" (change)="recalcDue()"
                [disabled]="formMode === 'view'">
                <option *ngFor="let t of creditTerms" [ngValue]="t.code">
                  {{ t.name }}
                </option>
              </select>
            </label>

            <label>
              Due Date
              <input type="date" class="ac-form-control" style="background-color: rgb(251 241 241)"
                formControlName="dueDate" [readonly]="true" />
            </label>

            <label class="wide">
              Description
              <input class="ac-form-control" formControlName="description" [readonly]="formMode === 'view'"
                placeholder="Document description" />
            </label>
          </div>

          <!-- To box -->
          <div class="to-box">
            <div class="to-title">To :</div>
            <textarea class="to-text" rows="3" readonly [value]="debtorToText"></textarea>
          </div>

          <!-- Lines -->
          <div class="lines">
            <div class="lines-head">
              <div class="title">Sales A/C</div>
              <div class="actions">
                <button type="button" class="ac-btn ac-btn-primary" (click)="addAcLine()"
                  [disabled]="formMode === 'view'">
                  <span class="ico plus"></span>
                  Add
                </button>
              </div>
            </div>

            <div>
              <table class="ac-table table bordered" style="width: 100%">
                <thead>
                  <tr>
                    <th style="width: 200px">Sales A/C</th>
                    <th style="width: 120px">To Acc. Rate</th>
                    <th>Description</th>
                    <th class="ac-text-right" style="width: 160px">Amount</th>
                    <th style="width: 44px"></th>
                  </tr>
                </thead>
                <tbody *ngIf="invForm">
                  <tr *ngFor="
                    let fg of acLineGroups;
                    let i = index;
                    trackBy: trackByIndex
                  " [formGroup]="fg">
                    <td>
                      <input class="ac-form-control" formControlName="accNo" [attr.list]="'accnos-' + i"
                        (focus)="prepAccNoSuggestions(i)" (input)="prepAccNoSuggestions(i)" />
                      <datalist [id]="'accnos-' + i">
                        <option *ngFor="let s of accNoSugs[i]" [value]="s"></option>
                      </datalist>
                    </td>

                    <td class="ac-text-right">
                      <input type="number" step="0.0001" class="ac-form-control" formControlName="toAccRate"
                        (input)="recalcLine(i)" [readonly]="formMode === 'view'" />
                    </td>

                    <td>
                      <input class="ac-form-control" formControlName="lineDesc" [readonly]="formMode === 'view'" />
                    </td>

                    <td class="ac-text-right">
                      <input class="ac-form-control" appAmount formControlName="amount" [allowNegative]="false"
                        (input)="recalcTotals()" [readonly]="formMode === 'view'" />
                    </td>

                    <td class="ac-text-center">
                      <button type="button" class="ac-btn ac-btn-icon-danger" (click)="removeAcLine(i)"
                        [disabled]="formMode === 'view'">
                        ðŸ—‘
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div class="totals-grid">
              <div class="label">Total</div>
              <div class="value">
                {{ invForm.value.grandTotal | number : '1.2-2' }}
              </div>
              <div class="label">Net Total</div>
              <div class="value">
                {{ invForm.value.grandTotal | number : '1.2-2' }}
              </div>
              <div class="label">Outstanding</div>
              <div class="value">
                {{ invForm.value.outstanding | number : '1.2-2' }}
              </div>
            </div>
          </div>
        </div>
        <!-- /ac-dialog-scroll -->

        <!-- FOOTER DÃNH ÄÃY (giá»‘ng Contra) -->
        <div class="ac-dialog-footer">

          <span class="spacer"></span>

          <button type="button" class="ac-btn ac-btn-ghost" (click)="showForm = false">
            Cancel
          </button>
          <button *ngIf="formMode !== 'view'" type="button" class="ac-btn ac-btn-primary" (click)="saveInvoice()"
            [disabled]="invForm.invalid">
            Save
          </button>
        </div>
      </form>
    </div>
  </div>


  <!-- FIND dialog -->
  <div class="dialog" *ngIf="showFind">
    <div class="dialog-panel ac-card-no-padding ac-dialog-panel-lg">
      <div class="ac-dialog-header">
        <span>Find Invoice</span>
        <button class="ac-dialog-close" type="button" (click)="showFind = false" aria-label="Close">
          âœ•
        </button>
      </div>

      <div class="ac-dialog-body">
        <form [formGroup]="findForm" class="grid3">
          <label>
            From
            <input type="date" class="ac-form-control" formControlName="from" />
          </label>
          <label>
            To
            <input type="date" class="ac-form-control" formControlName="to" />
          </label>
          <label>
            Debtor
            <select class="ac-form-control" formControlName="debtor">
              <option value="">Any</option>
              <option *ngFor="let d of debtors" [value]="d.debtorAccount">
                {{ d.debtorAccount }} â€” {{ d.companyName }}
              </option>
            </select>
          </label>
          <label>
            Status
            <select class="ac-form-control" formControlName="status">
              <option value="all">All</option>
              <option>OPEN</option>
              <option>POSTED</option>
              <option>VOID</option>
            </select>
          </label>
          <label>
            Min Amount
            <input type="number" step="0.01" class="ac-form-control" formControlName="min" />
          </label>
          <label>
            Max Amount
            <input type="number" step="0.01" class="ac-form-control" formControlName="max" />
          </label>
        </form>

        <div class="ac-dialog-footer">
          <button type="button" class="ac-btn ac-btn-primary" (click)="runFind()">
            Search
          </button>
        </div>

        <div class="ac-tablewrap" *ngIf="findResults.length">
          <table class="ac-table ac-table-sm">
            <thead>
              <tr>
                <th>Date</th>
                <th>Doc No</th>
                <th>Debtor</th>
                <th class="r">Total</th>
                <th>Status</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let r of findResults">
                <td>{{ r.docDate }}</td>
                <td>{{ r.docNo }}</td>
                <td>{{ r.debtor }} â€” {{ r.debtorName }}</td>
                <td class="r">{{ r.grandTotal | number : "1.2-2" }}</td>
                <td>
                  <button class="btn btn-primary" (click)="pickFromFind(r)">
                    Select
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- PRINT LISTING -->
  <div class="dialog" *ngIf="showPrint">
    <div class="dialog-panel ac-card-no-padding ac-dialog-panel-lg">
      <div class="ac-dialog-header">
        <span>A/R Invoice Listing</span>
        <button class="ac-dialog-close" type="button" (click)="showPrint = false" aria-label="Close">
          âœ•
        </button>
      </div>

      <div class="ac-dialog-body">
        <form [formGroup]="printForm" class="grid4">
          <label>
            From
            <input type="date" class="ac-form-control" formControlName="from" />
          </label>
          <label>
            To
            <input type="date" class="ac-form-control" formControlName="to" />
          </label>
          <label>
            Debtor
            <select class="ac-form-control" formControlName="debtor">
              <option value="">Any</option>
              <option *ngFor="let d of debtors" [value]="d.debtorAccount">
                {{ d.debtorAccount }} â€” {{ d.companyName }}
              </option>
            </select>
          </label>
          <label>
            Status
            <select class="ac-form-control" formControlName="status">
              <option value="all">All</option>
              <option>OPEN</option>
              <option>POSTED</option>
              <option>VOID</option>
            </select>
          </label>
          <label>
            Sort by
            <select class="ac-form-control" formControlName="sort">
              <option value="docDate">Date</option>
              <option value="docNo">Doc No</option>
              <option value="debtor">Debtor</option>
              <option value="grandTotal">Amount</option>
            </select>
          </label>
        </form>

        <div class="ac-dialog-footer">
          <button type="button" class="ac-btn ac-btn-primary" (click)="showPreview = true">
            Preview
          </button>
        </div>

        <div class="preview" *ngIf="showPreview">
          <h3>A/R Invoice Listing (Preview)</h3>
          <div class="ac-tablewrap">
            <table class="ac-table ac-table-sm">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Doc No</th>
                  <th>Debtor</th>
                  <th class="ac-text-right">Sub Total</th>
                  <th class="ac-text-right">Tax</th>
                  <th class="ac-text-right">Total</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let x of buildListing()">
                  <td>{{ x.docDate }}</td>
                  <td>{{ x.docNo }}</td>
                  <td>{{ x.debtor }} â€” {{ x.debtorName }}</td>
                  <td class="ac-text-right">
                    {{ x.subTotal | number : '1.2-2' }}
                  </td>
                  <td class="ac-text-right">
                    {{ x.taxTotal | number : '1.2-2' }}
                  </td>
                  <td class="ac-text-right">
                    {{ x.grandTotal | number : '1.2-2' }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DEBTOR PICKER -->
  <div class="dialog" *ngIf="showDebtorPicker">
    <div class="dialog-panel ac-card-no-padding ac-dialog-panel-lg">
      <div class="ac-dialog-header">
        <span>Select Debtor</span>
        <button class="ac-dialog-close" type="button" (click)="showDebtorPicker = false">
          Ã—
        </button>
      </div>
      <div class="ac-dialog-body">
        <div class="ac-page-toolbar" style="padding: 0 0 8px 0; gap: 8px; display: flex">
          <input class="ac-form-control ac-page-search" [(ngModel)]="debtorQuery" (ngModelChange)="filterDebtors()"
            placeholder="Search Debtor A/C, Company Name..." />
        </div>
        <div class="ac-tablewrap">
          <table class="ac-table ac-table-sm">
            <thead>
              <tr>
                <th>Debtor A/C</th>
                <th>Company Name</th>
                <th>Bill Address</th>
                <th>Phone</th>
                <th style="width: 90px"></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let d of debtorFiltered" (dblclick)="pickDebtor(d)">
                <td>{{ d.debtorAccount }}</td>
                <td>{{ d.companyName }}</td>
                <td class="cut">{{ d.billAddress }}</td>
                <td>{{ d.phone }}</td>
                <td>
                  <button type="button" class="ac-btn ac-btn-primary" (click)="pickDebtor(d)">
                    Select
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- DELETE INVOICE CONFIRM -->
  <div class="dialog" *ngIf="showDeleteInvoiceConfirm">
    <div class="dialog-panel-small ac-card-no-padding" role="dialog" aria-modal="true" style="min-width: 360px">
      <div class="ac-dialog-header">
        <span>Delete Invoice</span>
        <button class="ac-dialog-close" type="button" (click)="closeDeleteInvoiceConfirm()" aria-label="Close">
          Ã—
        </button>
      </div>

      <div class="ac-dialog-body">
        <p>
          Are you sure you want to delete
          <b>{{ selected?.docNo || 'this invoice' }}</b>?
        </p>
      </div>

      <div class="ac-dialog-footer">
        <button type="button" class="ac-btn ac-btn-ghost" (click)="closeDeleteInvoiceConfirm()">
          Cancel
        </button>
        <button type="button" class="ac-btn ac-btn-danger" (click)="confirmDeleteInvoice()">
          Delete
        </button>
      </div>
    </div>
  </div>

  <!-- SUCCESS POPUP -->
  <div class="dialog" *ngIf="showSuccess">
    <div class="dialog-panel-small ac-card-no-padding" role="dialog" aria-modal="true" style="min-width: 360px">
      <div class="ac-dialog-header" style="background: linear-gradient(180deg, #9be28a 0%, #62c84f 100%)">
        <span>Success</span>
        <button class="ac-dialog-close" type="button" (click)="closeSuccess()" aria-label="Close">
          Ã—
        </button>
      </div>
      <div class="ac-dialog-body">
        <p style="margin: 8px 0; font-weight: 600; color: #14532d">
          {{ successMsg }}
        </p>
      </div>
      <div class="ac-dialog-footer">
        <button type="button" class="ac-btn ac-btn-primary" (click)="closeSuccess()">
          OK
        </button>
      </div>
    </div>
  </div>
</div>
