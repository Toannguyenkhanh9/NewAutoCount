<div class="ac-page">
    <div class="ac-card">
  <!-- ============ HEADER ============ -->
  <div class="ac-page-header">
    <div>
      <div class="ac-page-title">Debtor Maintenance</div>
      <div class="ac-page-subtitle">
        Maintain customer (debtor) master data, addresses and credit settings.
      </div>
    </div>

    <div class="ac-page-toolbar" role="toolbar" aria-label="Debtor actions">
      <input
        class="ac-form-control ac-page-search"
        type="text"
        placeholder="Search code / company name..."
        [(ngModel)]="q"
      />

      <button class="ac-btn ac-btn-primary" type="button" (click)="newDebtor()">
        New
      </button>

      <button
        class="ac-btn"
        type="button"
        [disabled]="!selected"
        (click)="editDebtor()"
      >
        Edit
      </button>

      <button
        class="ac-btn ac-btn-danger"
        type="button"
        [disabled]="!selected"
        (click)="onDeleteDebtor()"
      >
        Delete
      </button>
    </div>
  </div>

  <!-- ============ GRID ============ -->
  <div class="ac-card ac-card-no-padding">
    <div class="ac-tablewrap">
      <table class="ac-table">
        <thead>
          <tr>
            <th (click)="setSort('debtorAccount')">Code</th>
            <th>Customer Name</th>
            <th>Company/SSM ID</th>
            <th>Phone</th>
            <th>Customer's TIN</th>
            <th>Active</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let r of filteredRows(); let i = index"
            (click)="select(r)"
            [class.ac-row-selected]="selected === r"
          >
            <td>{{ r.debtorAccount }}</td>
            <td>{{ r.companyName }}</td>
            <td>{{ r.type }}</td>
            <td>{{ r.phone }}</td>
            <td>{{ r.customerTin }}</td>
            <td>
              <input type="checkbox" [checked]="r.active" disabled />
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ============ PAGER ============ -->
  <div class="ac-page-footer">
    <div class="ac-pager">
      <button class="ac-btn ac-pager-btn" type="button" (click)="first()">
        &laquo;
      </button>
      <button class="ac-btn ac-pager-btn" type="button" (click)="prev()">
        &lsaquo;
      </button>

      <span class="ac-pager-label">
        Page {{ page }} / {{ totalPages }}
      </span>

      <button class="ac-btn ac-pager-btn" type="button" (click)="next()">
        &rsaquo;
      </button>
      <button class="ac-btn ac-pager-btn" type="button" (click)="last()">
        &raquo;
      </button>
    </div>
  </div>
</div>
  <!-- ============ PRINT LISTING ============ -->
  <div class="dialog" *ngIf="showPrint">
    <div class="dialog-panel ac-card-no-padding ac-dialog-panel-lg">
      <div class="ac-dialog-header">
        <span>Debtor Listing</span>
        <button
          type="button"
          class="ac-dialog-close"
          (click)="showPrint = false"
          aria-label="Close"
        >
          &times;
        </button>
      </div>

      <div class="ac-dialog-body">
        <form [formGroup]="printForm" class="grid4">
          <label>
            <span class="ac-form-label">Status</span>
            <select class="ac-form-control" formControlName="active">
              <option value="all">All</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
            </select>
          </label>

          <label>
            <span class="ac-form-label">Area</span>
            <select class="ac-form-control" formControlName="area">
              <option value="">Any</option>
              <option>CENTRAL</option>
              <option>SOUTH</option>
              <option>NORTH</option>
              <option>EAST</option>
              <option>WEST</option>
            </select>
          </label>

          <label>
            <span class="ac-form-label">Agent</span>
            <input class="ac-form-control" formControlName="agent" />
          </label>

          <label>
            <span class="ac-form-label">Currency</span>
            <select class="ac-form-control" formControlName="currency">
              <option value="">Any</option>
              <option>MYR</option>
              <option>USD</option>
              <option>SGD</option>
            </select>
          </label>

          <label>
            <span class="ac-form-label">Sort by</span>
            <select class="ac-form-control" formControlName="sort">
              <option value="code">Code</option>
              <option value="name">Name</option>
              <option value="area">Area</option>
              <option value="agent">Agent</option>
            </select>
          </label>
        </form>

        <div class="ac-dialog-footer">
          <button
            class="ac-btn ac-btn-primary"
            type="button"
            (click)="showPrintPreview = true"
          >
            Preview
          </button>
          <button
            class="ac-btn ac-btn-ghost"
            type="button"
            (click)="printNow()"
            *ngIf="showPrintPreview"
          >
            Print
          </button>
        </div>

        <div class="preview" *ngIf="showPrintPreview">
          <h3>Debtor Listing (Preview)</h3>
          <div class="ac-tablewrap">
            <table class="ac-table ac-table-sm">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Name</th>
                  <th>Agent</th>
                  <th>Currency</th>
                  <th>Active</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let d of buildListing()">
                  <td>{{ d.debtorAccount }}</td>
                  <td>{{ d.companyName }}</td>
                  <td>{{ d.currency }}</td>
                  <td>{{ d.active ? 'Y' : 'N' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ DETAIL REPORT ============ -->
  <div class="dialog" *ngIf="showDetail">
    <div class="dialog-panel ac-card-no-padding ac-dialog-panel-lg">
      <div class="ac-dialog-header">
        <span>Debtor Detail Report — {{ selected?.debtorAccount }}</span>
        <button
          type="button"
          class="ac-dialog-close"
          (click)="showDetail = false"
          aria-label="Close"
        >
          &times;
        </button>
      </div>

      <div class="ac-dialog-body report">
        <h2>{{ selected?.companyName }}</h2>
        <div class="kv">
          <div><b>Type:</b> {{ selected?.type }}</div>
          <div><b>Phone:</b> {{ selected?.phone }}</div>
          <div><b>Currency:</b> {{ selected?.currency }}</div>
          <div><b>Credit Term:</b> {{ selected?.creditTerm }}</div>
          <div>
            <b>Credit Limit:</b>
            {{ selected?.creditLimit | number : '1.0-0' }}
          </div>
          <div><b>Active:</b> {{ selected?.active ? 'Yes' : 'No' }}</div>
        </div>
      </div>

      <div class="ac-dialog-footer">
        <button
          class="ac-btn ac-btn-ghost"
          type="button"
          (click)="printNow()"
        >
          Print
        </button>
        <button
          class="ac-btn ac-btn-primary"
          type="button"
          (click)="showDetail = false"
        >
          Close
        </button>
      </div>
    </div>
  </div>

  <!-- ============ CREATE / EDIT / VIEW DEBTOR ============ -->
  <div class="ac-dialog-backdrop" *ngIf="showForm">
    <div class="dialog-panel ac-card-no-padding ac-dialog-panel-xl">
      <div class="ac-dialog-header">
        <span>
          {{
            formMode === 'new'
              ? 'Create Debtor'
              : formMode === 'edit'
              ? 'Edit Debtor'
              : 'View Debtor'
          }}
        </span>
        <button
          type="button"
          class="ac-dialog-close"
          (click)="showForm = false"
          aria-label="Close"
        >
          &times;
        </button>
      </div>

      <form [formGroup]="debtorForm" class="ac-dialog-body">
        <div class="ac-dialog-scroll">
        <!-- Profile -->
        <div class="gbox">
          <div class="gbox-title">Profile</div>

          <div class="gbox-body grid3">
            <label>
              <span class="lbl">Debtor Code <span class="req">*</span></span>
              <input
                formControlName="code"
                required
                placeholder="300-xxx"
                list="debtorCodeOptions"
                (focus)="onCodeFocus()"
                [readonly]="formMode === 'view'"
              />
              <datalist id="debtorCodeOptions">
                <option *ngFor="let c of debtorCodeList" [value]="c"></option>
              </datalist>
            </label>

            <label>
              <span class="lbl">Customer Name <span class="req">*</span></span>
              <input
                formControlName="name"
                required
                [readonly]="formMode === 'view'"
              />
            </label>

            <label>
              <span class="lbl">Company/SSM ID</span>
              <input
                formControlName="registrationNo"
                [readonly]="formMode === 'view'"
              />
            </label>

            <label>
              <span class="lbl">
                Individual ID / Passport No <span class="req">*</span>
              </span>
              <input
                formControlName="individualId"
                required
                [readonly]="formMode === 'view'"
              />
            </label>

            <label>
              <span class="lbl">
                Customer's TIN <span class="req">*</span>
                <button
                  type="button"
                  class="chip chip-link"
                  (click)="openTinLookup()"
                  title="Search TIN"
                >
                  Search TIN
                </button>
              </span>
              <input
                formControlName="tinNo"
                required
                [readonly]="formMode === 'view'"
              />
            </label>

            <label>
              <span class="lbl">Customer's SST Registration No.</span>
              <input
                formControlName="sstRegNo"
                [readonly]="formMode === 'view'"
              />
            </label>

            <label>
              <span class="lbl">Currency</span>
              <select
                formControlName="currency"
                [disabled]="formMode === 'view'"
              >
                <option *ngFor="let c of currencies" [ngValue]="c.code">
                  {{ c.code }}
                </option>
              </select>
            </label>
          </div>
        </div>

        <!-- Address & Contact -->
        <div class="gbox">
          <div class="gbox-title">Address & Contact</div>
          <div class="gbox-body grid3">
            <label class="wide">
              <span class="lbl">
                Billing Address <span class="req">*</span>
              </span>
              <textarea
                rows="1"
                formControlName="billAddress"
                required
                [readonly]="formMode === 'view'"
              ></textarea>
            </label>

            <label>
              <span class="lbl">Phone <span class="req">*</span></span>
              <input
                formControlName="phone"
                required
                [readonly]="formMode === 'view'"
              />
            </label>

            <label>
              <span class="lbl">Fax <span class="req">*</span></span>
              <input
                formControlName="fax"
                required
                [readonly]="formMode === 'view'"
              />
            </label>

            <label>
              <span class="lbl">Post Code <span class="req">*</span></span>
              <input
                formControlName="postCode"
                required
                [readonly]="formMode === 'view'"
              />
            </label>

            <div class="addr-sep" aria-hidden="true"></div>

            <label class="wide">
              <span class="lbl">
                Delivery Address
                <button
                  type="button"
                  class="chip"
                  (click)="copyBillingToDelivery()"
                  title="Copy from Billing Address"
                >
                  Copy
                </button>
              </span>
              <textarea
                rows="1"
                formControlName="deliveryAddress"
                [readonly]="formMode === 'view'"
              ></textarea>
            </label>

            <label>
              <span class="lbl">Post Code</span>
              <input
                formControlName="deliveryPostCode"
                [readonly]="formMode === 'view'"
              />
            </label>

            <label>
              <span class="lbl">Email Address</span>
              <input
                formControlName="email"
                [readonly]="formMode === 'view'"
              />
            </label>

            <label>
              <span class="lbl">Website</span>
              <input
                formControlName="website"
                [readonly]="formMode === 'view'"
              />
            </label>
          </div>
        </div>

        <!-- Credit & Others -->
        <div class="gbox">
          <div class="gbox-title">Credit & Others</div>

          <div class="gbox-body grid3 three-cols">
            <div class="col">
              <label class="lbl">Credit Term</label>
              <div class="input-with-btn">
                <select formControlName="creditTerm">
                  <option *ngFor="let ct of creditTerms" [ngValue]="ct.code">
                    {{ ct.name }}
                  </option>
                </select>

                <button
                  type="button"
                  class="ac-btn ac-btn-primary"
                  (click)="openCreditControl()"
                  title="Open Credit Control"
                >
                  Credit Control
                </button>
              </div>
            </div>

            <label *ngIf="formMode === 'edit'">
              <span class="lbl">Actual Term</span>
              <input
                type="number"
                min="0"
                step="1"
                formControlName="actualTerm"
              />
            </label>

            <label>
              <span class="lbl">Sales Tax Exemption No.</span>
              <input
                formControlName="taxExemptionNo"
                [readonly]="formMode === 'view'"
              />
            </label>

            <label>
              <span class="lbl">Expired Date</span>
              <input
                type="date"
                formControlName="taxExemptionExpiry"
                [disabled]="formMode === 'view'"
              />
            </label>
          </div>
        </div>

        <div class="ac-dialog-footer">
          <button
            type="button"
            class="ac-btn ac-btn-ghost"
            (click)="showForm = false"
          >
            Cancel
          </button>
          <button
            *ngIf="formMode !== 'view'"
            type="button"
            class="ac-btn ac-btn-primary"
            (click)="saveDebtor()"
          >
            Save
          </button>
        </div>
        </div>
      </form>
    </div>
  </div>

  <!-- ============ CREDIT CONTROL POPUP ============ -->
  <div class="dialog" *ngIf="showCredit">
    <div class="dialog-panel-small ac-card-no-padding" style="width: min(720px, 96vw)">
      <div class="ac-dialog-header">
        <span>Debtor Credit Control</span>
        <button
          class="ac-dialog-close"
          type="button"
          (click)="showCredit = false"
          aria-label="Close"
        >
          ×
        </button>
      </div>

      <div class="ac-dialog-body">
        <form [formGroup]="creditForm" class="cc-grid">
          <label class="cell">
            <span class="ac-form-label">Credit Limit</span>
            <input
              type="text"
              appAmount
              [decimals]="2"
              formControlName="creditLimit"
            />
          </label>

          <label class="cell">
            <span class="ac-form-label">Credit Term's Overdue Limit</span>
            <input
              type="text"
              appAmount
              [decimals]="2"
              formControlName="overdueLimit"
            />
          </label>

          <label class="cell">
            <span class="ac-form-label">Credit Control</span>
            <select formControlName="scope">
              <option value="ALL">All Documents</option>
              <option value="BYDOC">By Document</option>
            </select>
          </label>
        </form>

        <div class="cc-modes" [formGroup]="creditForm">
          <label class="radio-inline">
            <input type="radio" formControlName="mode" value="DISABLED" />
            <span>All Disabled</span>
          </label>

          <div
            class="mode-row"
            [class.dimmed]="creditForm.value.mode !== 'BY_TERM'"
          >
            <label class="radio-inline">
              <input type="radio" formControlName="mode" value="BY_TERM" />
              <span>Controlled by credit term</span>
            </label>

            <div class="mode-body grid2">
              <label>
                If exceed credit limit
                <select formControlName="exceedCreditAction">
                  <option value="ALLOW">No Block</option>
                  <option value="BLOCK">Block</option>
                  <option value="NEEDPWD">Need Password</option>
                </select>
              </label>
              <label>
                If exceed overdue limit
                <select formControlName="exceedOverdueAction">
                  <option value="ALLOW">No Block</option>
                  <option value="BLOCK">Block</option>
                  <option value="NEEDPWD">Need Password</option>
                </select>
              </label>
            </div>
          </div>

          <div
            class="mode-row"
            [class.dimmed]="creditForm.value.mode !== 'SUSPEND'"
          >
            <label class="radio-inline">
              <input type="radio" formControlName="mode" value="SUSPEND" />
              <span>Suspend</span>
            </label>

            <div class="mode-body">
              <label>
                Suspend Reason
                <input formControlName="suspendReason" />
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="ac-dialog-footer">
        <button
          class="ac-btn ac-btn-ghost"
          type="button"
          (click)="showCredit = false"
        >
          Cancel
        </button>
        <button
          class="ac-btn ac-btn-primary"
          type="button"
          (click)="saveCreditControl()"
        >
          OK
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ============ CONFIRM DELETE CONTACT ============ -->
<div class="dialog" *ngIf="showContactDeleteConfirm">
  <div class="dialog-panel-small ac-card-no-padding" role="dialog" aria-modal="true">
    <div class="ac-dialog-header">
      <span>Delete Contact</span>
      <button
        class="ac-dialog-close"
        type="button"
        (click)="closeContactDeleteConfirm()"
        aria-label="Close"
      >
        ×
      </button>
    </div>

    <div class="ac-dialog-body">
      <p>
        Are you sure you want to delete
        <b>{{ selectedContact?.name || 'this contact' }}</b>?
      </p>
    </div>

    <div class="ac-dialog-footer">
      <button
        class="ac-btn ac-btn-ghost"
        type="button"
        (click)="closeContactDeleteConfirm()"
      >
        Cancel
      </button>
      <button
        class="ac-btn ac-btn-danger"
        type="button"
        (click)="confirmDeleteContact()"
      >
        Delete
      </button>
    </div>
  </div>
</div>

<!-- ============ SUCCESS POPUP ============ -->
<div class="dialog" *ngIf="showSuccess">
  <div
    class="dialog-panel-small ac-card-no-padding"
    role="dialog"
    aria-modal="true"
    style="min-width: 360px"
  >
    <div
      class="ac-dialog-header"
    >
      <span>Success</span>
      <button
        class="ac-dialog-close"
        type="button"
        (click)="closeSuccess()"
        aria-label="Close"
      >
        ×
      </button>
    </div>
    <div class="ac-dialog-body">
      <p style="margin: 8px 0; font-weight: 600; color: #14532d">
        {{ successMsg }}
      </p>
    </div>
    <div class="ac-dialog-footer">
      <button
        class="ac-btn ac-btn-primary"
        type="button"
        (click)="closeSuccess()"
      >
        OK
      </button>
    </div>
  </div>
</div>

<!-- ============ BRANCH EDITOR ============ -->
<div class="dialog" *ngIf="showBranchEditor">
  <div class="dialog-panel-small ac-card-no-padding" style="width: min(720px, 96vw)">
    <div class="ac-dialog-header">
      <span>
        {{ branchEditIndex === -1 ? 'Add Branch' : 'Edit Branch' }}
      </span>
      <button
        class="ac-dialog-close"
        type="button"
        (click)="closeBranchEditor()"
      >
        ×
      </button>
    </div>

    <form class="ac-dialog-body" [formGroup]="branchForm">
      <div class="grid2">
        <label>Branch Code<input formControlName="code" /></label>
        <label>Branch Name<input formControlName="name" /></label>
      </div>

      <label class="wide">
        Address
        <textarea rows="3" formControlName="address"></textarea>
      </label>

      <div class="grid3">
        <label>Post Code<input formControlName="postCode" /></label>
        <label>Attention<input formControlName="attention" /></label>
        <label>Email Address<input formControlName="email" /></label>

        <label>Phone 1<input formControlName="phone1" /></label>
        <label>Phone 2<input formControlName="phone2" /></label>
        <label>Fax 1<input formControlName="fax1" /></label>
        <label>Fax 2<input formControlName="fax2" /></label>
        <label>
          Area
          <select formControlName="area">
            <option *ngFor="let a of areas" [ngValue]="a.code">
              {{ a.name }}
            </option>
          </select>
        </label>
      </div>
    </form>

    <div class="ac-dialog-footer">
      <button
        class="ac-btn ac-btn-ghost"
        type="button"
        (click)="closeBranchEditor()"
      >
        Cancel
      </button>
      <button
        class="ac-btn ac-btn-primary"
        type="button"
        (click)="saveBranchEditor()"
        [disabled]="!branchForm.valid"
      >
        OK
      </button>
    </div>
  </div>
</div>

<!-- ============ CONFIRM DELETE BRANCH ============ -->
<div class="dialog" *ngIf="showBranchDeleteConfirm">
  <div class="dialog-panel-small ac-card-no-padding" role="dialog" aria-modal="true">
    <div class="ac-dialog-header">
      <span>Delete Branch</span>
      <button
        class="ac-dialog-close"
        type="button"
        (click)="closeBranchDeleteConfirm()"
        aria-label="Close"
      >
        ×
      </button>
    </div>

    <div class="ac-dialog-body">
      <p>
        Are you sure you want to delete
        <b>{{ selectedBranch?.code || 'this branch' }}</b>?
      </p>
    </div>

    <div class="ac-dialog-footer">
      <button
        class="ac-btn ac-btn-ghost"
        type="button"
        (click)="closeBranchDeleteConfirm()"
      >
        Cancel
      </button>
      <button
        class="ac-btn ac-btn-danger"
        type="button"
        (click)="confirmDeleteBranch()"
      >
        Delete
      </button>
    </div>
  </div>
</div>

<!-- ============ CONFIRM DELETE DEBTOR ============ -->
<div class="dialog" *ngIf="showDeleteDebtorConfirm">
  <div class="dialog-panel-small ac-card-no-padding" role="dialog" aria-modal="true">
    <div class="ac-dialog-header">
      <span>Delete Debtor</span>
      <button
        class="ac-dialog-close"
        type="button"
        (click)="closeDeleteDebtorConfirm()"
        aria-label="Close"
      >
        ×
      </button>
    </div>

    <div class="ac-dialog-body">
      <p>
        Are you sure you want to delete
        <b>{{ selected?.debtorAccount }}</b>?
      </p>
    </div>

    <div class="ac-dialog-footer">
      <button
        class="ac-btn ac-btn-ghost"
        type="button"
        (click)="closeDeleteDebtorConfirm()"
      >
        Cancel
      </button>
      <button
        class="ac-btn ac-btn-danger"
        type="button"
        (click)="deleteDebtor()"
      >
        Delete
      </button>
    </div>
  </div>
</div>
