<div class="ac-page">
  <!-- ================= LIST MODE ================= -->
  <ng-container *ngIf="!showForm">
    <div class="ac-card">
      <div class="ac-page-header">
        <div>
          <div class="ac-page-title">Debtor Maintenance</div>
          <div class="ac-page-subtitle">
            Maintain customer (debtor) master data, addresses and credit settings.
          </div>
        </div>

        <div class="ac-page-toolbar">
          <input class="ac-form-control ac-page-search" type="text" placeholder="Search code / company name..."
            [(ngModel)]="q" />

          <button class="ac-btn ac-btn-primary" (click)="newDebtor()">New</button>
          <button class="ac-btn" [disabled]="!selected" (click)="editDebtor()">Edit</button>
          <button class="ac-btn ac-btn-danger" [disabled]="!selected" (click)="onDeleteDebtor()">Delete</button>
        </div>
      </div>
    </div>

    <div class="ac-card ac-card-no-padding">
      <div class="ac-tablewrap">
        <table class="ac-table">
          <thead>
            <tr>
              <th (click)="setSort('debtorAccount')">Code</th>
              <th>Customer Name</th>
              <th>Company/SSM ID</th>
              <th>Phone</th>
              <th>Customer's TIN</th>
              <th>Active</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let r of filteredRows()" (click)="select(r)" [class.ac-row-selected]="selected === r">
              <td>{{ r.debtorAccount }}</td>
              <td>{{ r.companyName }}</td>
              <td>{{ r.type }}</td>
              <td>{{ r.phone }}</td>
              <td>{{ r.customerTin }}</td>
              <td><input type="checkbox" [checked]="r.active" disabled /></td>
            </tr>

            <tr *ngIf="!filteredRows().length">
              <td colspan="6" class="ac-text-center ac-text-muted">No data</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </ng-container>
  <!-- ================= FORM MODE ================= -->
  <ng-container *ngIf="showForm">
    <div class="debtor-form">
      <!-- Header -->
      <div class="form-header">
        <div class="popup-title">
          {{
          formMode === 'new'
          ? 'New Debtor'
          : formMode === 'edit'
          ? 'Edit Debtor'
          : 'View Debtor'
          }}
        </div>
        <p>Maintain debtor profile, contact, and business information.</p>
      </div>

      <!-- BODY: side tabs + content -->
      <form [formGroup]="debtorForm" class="form-body" #formScroll>
        <div class="debtor-layout">
          <!-- ==== SIDE TABS ==== -->
          <nav class="debtor-tabs">
            <button type="button" class="debtor-tab" [class.active]="activeSection === 'contact'"
              [class.has-error]="sectionHasError('contact')" (click)="scrollToSection('contact')">
              <span class="debtor-tab-label">Contact details</span>
              <span class="debtor-tab-error" *ngIf="sectionHasError('contact')">!</span>
            </button>

            <button type="button" class="debtor-tab" [class.active]="activeSection === 'primary'"
              [class.has-error]="sectionHasError('primary')" (click)="scrollToSection('primary')">
              <span class="debtor-tab-label">Addresses</span>
              <span class="debtor-tab-error" *ngIf="sectionHasError('primary')">!</span>
            </button>

            <button type="button" class="debtor-tab" [class.has-error]="sectionHasError('additional')"
              [class.active]="activeSection === 'additional'" (click)="scrollToSection('additional')">
              <span class="debtor-tab-label">Others contact</span>
              <span class="debtor-tab-error" *ngIf="sectionHasError('additional')">!</span>
            </button>

            <button type="button" class="debtor-tab" [class.has-error]="sectionHasError('business')"
              [class.active]="activeSection === 'business'" (click)="scrollToSection('business')">
              <span class="debtor-tab-label">Credit Term Control</span>
              <span class="debtor-tab-error" *ngIf="sectionHasError('business')">!</span>
            </button>
          </nav>


          <!-- ==== MAIN CONTENT ==== -->
          <div class="debtor-main">
            <div class="debtor-main-inner">
              <!-- TAB: CONTACT DETAILS -->
              <section #contactSection>
                <h3>Contact details</h3>
                <div class="form-grid">
                  <label [class.field-error]="isFieldInvalid('code')">
                    <span>
                      Debtor Code <span class="required-tag">(required)</span>
                    </span>
                    <input formControlName="code" placeholder="300-xxx" />

                    <div class="field-error-row">
                      <span class="field-error-icon" *ngIf="isFieldInvalid('code')">!</span>
                      <span *ngIf="isFieldInvalid('code')">Enter a debtor code</span>
                    </div>
                  </label>

                  <label [class.field-error]="isFieldInvalid('name')">
                    <span>
                      Customer Name <span class="required-tag">(required)</span>
                    </span>
                    <input placeholder="e.g. A business or person's name" formControlName="name" />
                    <div class="field-error-row">
                      <span class="field-error-icon" *ngIf="isFieldInvalid('name')">!</span>
                      <span *ngIf="isFieldInvalid('name')">Enter a customer name</span>
                    </div>
                  </label>

                  <label>
                    <span>Company/SSM ID</span>
                    <input formControlName="registrationNo" />
                  </label>

                  <label [class.field-error]="isFieldInvalid('individualId')">
                    <span>
                      Individual ID / Passport No <span class="required-tag">(required)</span>
                    </span>
                    <input formControlName="individualId" />
                    <div class="field-error-row">
                      <span class="field-error-icon" *ngIf="isFieldInvalid('individualId')">!</span>
                      <span *ngIf="isFieldInvalid('individualId')">Enter an individual ID / passport no</span>
                    </div>
                  </label>

                  <label class="field-with-action" [class.field-error]="isFieldInvalid('tinNo')">
                    <div class="field-label-row">
                      <span class="field-label">
                        Customer‚Äôs TIN <span class="required-tag">(required)</span>
                      </span>
                      <button type="button" class="link" (click)="openTinLookup()">
                        Search TIN
                      </button>
                    </div>

                    <input formControlName="tinNo" placeholder="e.g. 123456789" />
                    <div class="field-error-row">
                      <span class="field-error-icon" *ngIf="isFieldInvalid('tinNo')">!</span>
                      <span *ngIf="isFieldInvalid('tinNo')">Enter a customer TIN</span>
                    </div>
                  </label>

                  <label>
                    <span>Customer‚Äôs SST Registration No.</span>
                    <input formControlName="sstRegNo" />
                  </label>

                  <!-- CURRENCY DROPDOWN XERO-STYLE -->
                  <label class="currency-field">
                    <span>Currency</span>

                    <!-- n√∫t m·ªü dropdown -->
                    <div class="currency-trigger" (click)="toggleCurrencyPanel()">
                      <div class="currency-trigger-main">
                        <span class="currency-trigger-label">
                          <!-- t√™n + (default) -->
                          <ng-container *ngIf="selectedCurrency; else noCurrency">
                            {{ selectedCurrency?.name || selectedCurrency?.code }}
                            <span *ngIf="selectedCurrency?.isDefault">
                              (default)
                            </span>
                          </ng-container>

                          <ng-template #noCurrency>
                            Select currency
                          </ng-template>
                        </span>

                        <span class="currency-trigger-code" *ngIf="selectedCurrency?.code">
                          {{ selectedCurrency?.code }}
                        </span>
                      </div>

                      <span class="currency-arrow">‚ñæ</span>
                    </div>

                    <!-- PANEL DROPDOWN -->
                    <div class="currency-panel" *ngIf="showCurrencyPanel" (click)="$event.stopPropagation()">
                      <!-- SEARCH BOX -->
                      <div class="currency-search-row">
                        <span class="currency-search-icon">üîç</span>
                        <input type="text" [(ngModel)]="currencySearch" (input)="filterCurrencies()"
                          placeholder="Search currency" />
                      </div>

                      <!-- MY CURRENCIES -->
                      <div class="currency-group" *ngIf="myCurrencies?.length">
                        <div class="currency-group-title">My currencies</div>

                        <button type="button" class="currency-row" *ngFor="let c of myCurrencies"
                          (click)="selectCurrency(c)">
                          <span class="currency-name">
                            {{ c.name || c.code }}
                            <span *ngIf="c.isDefault">(default)</span>
                          </span>
                          <span class="currency-code">{{ c.code }}</span>
                        </button>
                      </div>

                      <!-- ALL CURRENCIES -->
                      <div class="currency-group">
                        <div class="currency-group-title">All currencies</div>

                        <button type="button" class="currency-row" *ngFor="let c of filteredCurrencies"
                          (click)="selectCurrency(c)">
                          <span class="currency-name">{{ c.name || c.code }}</span>
                          <span class="currency-code">{{ c.code }}</span>
                        </button>
                      </div>
                    </div>
                  </label>

                </div>
              </section>

              <!-- TAB: PRIMARY PERSON -->
              <section #primarySection>
                <h3>Addresses</h3>
                <div class="form-grid">
                  <label class="full" [class.field-error]="isFieldInvalid('billAddress')">
                    <span>
                      Billing Address <span class="required-tag">(required)</span>
                    </span>
                    <textarea formControlName="billAddress"></textarea>
                    <div class="field-error-row">
                      <span class="field-error-icon" *ngIf="isFieldInvalid('billAddress')">!</span>
                      <span *ngIf="isFieldInvalid('billAddress')">Enter a billing address</span>
                    </div>

                  </label>
                  <label [class.field-error]="isFieldInvalid('phone')">
                    <span>
                      Phone <span class="required-tag">(required)</span>
                    </span>
                    <input formControlName="phone" />
                    <div class="field-error-row">
                      <span class="field-error-icon" *ngIf="isFieldInvalid('phone')">!</span>
                      <span *ngIf="isFieldInvalid('phone')">Enter a phone number</span>
                    </div>
                  </label>

                  <label [class.field-error]="isFieldInvalid('fax')">
                    <span>
                      Fax <span class="required-tag">(required)</span>
                    </span>
                    <input formControlName="fax" />
                    <div class="field-error-row">
                      <span class="field-error-icon" *ngIf="isFieldInvalid('fax')">!</span>
                      <span *ngIf="isFieldInvalid('fax')">Enter a fax number</span>
                    </div>

                  </label>

                  <!-- Post Code -->
                  <label [class.field-error]="isFieldInvalid('postCode')">
                    <span>
                      Post Code <span class="required-tag">(required)</span>
                    </span>
                    <input formControlName="postCode" />
                    <div class="field-error-row">
                      <span class="field-error-icon" *ngIf="isFieldInvalid('postCode')">!</span>
                      <span *ngIf="isFieldInvalid('postCode')">Enter a post code</span>
                    </div>
                  </label>
                </div>
              </section>

              <!-- TAB: ADDITIONAL PEOPLE -->
              <section #additionalSection>
                <h3>Others contact</h3>
                <div class="form-grid">
                  <label class="field-with-action">
                    <div class="field-label-row">
                      <span class="field-label">Delivery Address</span>
                      <button type="button" class="link" (click)="copyBillingToDelivery()">
                        Copy
                      </button>
                    </div>

                    <textarea formControlName="deliveryAddress"></textarea>
                  </label>

                  <label>
                    <span>Post Code</span>
                    <input formControlName="deliveryPostCode" />
                  </label>

                  <label class="field-with-leading-icon">
                    <span>Email</span>
                    <div class="icon-input-row">
                      <span class="icon-box">
                        ‚úâ
                      </span>
                      <input type="email" formControlName="email" class="icon-input-control"
                        placeholder="name@email.com" />
                    </div>
                  </label>

                  <label>
                    <span>Website</span>
                    <input formControlName="website" />
                  </label>
                </div>
              </section>

              <!-- TAB: BUSINESS INFORMATION -->
              <!-- TAB: BUSINESS INFORMATION -->
              <section #businessSection>
                <h3>Credit Term Control</h3>
                <div class="form-grid">
                  <!-- Credit Term -->
                  <label class="field-with-action">
                    <div class="field-label-row">
                      <span class="field-label">Credit Term</span>
                    </div>

                    <select formControlName="creditTerm">
                      <option *ngFor="let ct of creditTerms" [ngValue]="ct.code">
                        {{ ct.name }}
                      </option>
                    </select>
                  </label>

                  <!-- Actual Term: ch·ªâ hi·ªán ·ªü Edit -->
                  <label *ngIf="formMode === 'edit'">
                    <span>Actual Term</span>
                    <input type="number" formControlName="actualTerm" min="0" step="1" />
                  </label>

                  <!-- Credit limit amount -->
                  <label>
                    <span>Credit limit amount</span>
                    <input type="number" formControlName="creditLimitAmount" min="0" step="0.01" />
                  </label>

                  <!-- Checkbox: Block new invoices... -->
                  <div class="credit-limit-row" [class.disabled]="!debtorForm.get('creditLimitAmount')?.value">
                    <label class="credit-limit-checkbox">
                      <input type="checkbox" formControlName="blockInvoicesWhenLimitReached"
                        [disabled]="!debtorForm.get('creditLimitAmount')?.value" />
                      <span>Block new invoices when credit limit is reached</span>
                    </label>
                  </div>

                  <!-- Sales Tax Exemption No -->
                  <label>
                    <span>Sales Tax Exemption No.</span>
                    <input formControlName="taxExemptionNo" />
                  </label>

                  <!-- Expired Date -->
                  <label>
                    <span>Expired Date</span>
                    <input type="date" formControlName="taxExemptionExpiry" />
                  </label>
                </div>
              </section>

            </div>
          </div>
        </div>
      </form>

      <!-- FOOTER STICKY -->
      <div class="form-footer">
        <button class="btn cancel" type="button" (click)="closeForm()">
          Cancel
        </button>
        <button class="btn primary" type="button" (click)="saveDebtor()" [disabled]="debtorForm.invalid">
          Save &amp; Close
        </button>
      </div>
    </div>
  </ng-container>


</div>