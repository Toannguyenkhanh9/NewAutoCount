<div class="page">
  <div class="titlebar">
    <h1>Creditor Aging Report</h1>
  </div>

  <!-- Options -->
  <div class="options">
    <form [formGroup]="fg" class="options">
      <fieldset class="filters">
        <div class="f">
          <div class="lbl">Date</div>
          <div class="ctl">
            <input type="date" formControlName="asOf" />
          </div>
        </div>

        <div class="f">
          <div class="lbl">Creditor</div>
          <div class="ctl">
            <select formControlName="debtor">
              <option value="ALL">All</option>
              <option *ngFor="let d of debtors" [value]="d.code">
                {{ d.name }}
              </option>
            </select>
          </div>
        </div>
        <div class="f">
          <div class="lbl">Creditor Type</div>
          <div class="ctl">
            <select formControlName="debtorType">
              <option value="ALL">All</option>
              <option *ngFor="let t of debtorTypes" [value]="t">
                {{ t }}
              </option>
            </select>
          </div>
        </div>

        <div class="f">
          <div class="lbl">Aging Months</div>
          <div class="ctl">
            <select formControlName="agingMonths">
              <option [value]="4">4</option>
              <option [value]="6">6</option>
            </select>
          </div>
        </div>

        <div class="f">
          <div class="lbl">Group by</div>
          <div class="ctl inline">
            <select formControlName="groupBy">
              <option value="none">None</option>
              <option value="debtorType">Creditor Type</option>
            </select>
          </div>
        </div>
        <div class="f">
          <div class="lbl"></div>
          <div class="ctl inline">
            <br />
            <button type="button" class="btn primary" (click)="inquiry()">
              <span class="ico refresh"></span> Inquiry
            </button>
          </div>
        </div>
      </fieldset>
    </form>
  </div>
  <!-- Table -->
  <div class="gridwrap" *ngIf="!showGrouped()">
    <table>
      <thead>
        <tr>
          <th class="toggle"></th>
          <th (click)="onHeaderSort('debtorCode')">
            Creditor No.
            <span class="arrow" *ngIf="sortKey() === 'debtorCode'">{{
              sortDir() === "asc" ? "▲" : "▼"
            }}</span>
          </th>
          <th (click)="onHeaderSort('debtorName')">
            Company Name
            <span class="arrow" *ngIf="sortKey() === 'debtorName'">{{
              sortDir() === "asc" ? "▲" : "▼"
            }}</span>
          </th>
          <th>Currency</th>

          <th class="r">CURRENT</th>
          <th class="r">1 MONTH</th>
          <th class="r">2 MONTHS</th>
          <th class="r">3 MONTHS</th>
          <th class="r" *ngIf="colShown('m4')">4 MONTHS</th>
          <th class="r" *ngIf="colShown('over5')">5 &amp; OVER</th>
          <th class="r">Total Over Due</th>
          <th class="r" (click)="onHeaderSort('balance')">
            Balance
            <span class="arrow" *ngIf="sortKey() === 'balance'">{{
              sortDir() === "asc" ? "▲" : "▼"
            }}</span>
          </th>
        </tr>
      </thead>

      <tbody *ngFor="let r of rows()">
        <!-- debtor total row -->
        <tr class="debtor">
          <td class="toggle">
            <button class="toggle-btn" (click)="toggle(r)" type="button">
              {{ r.expanded ? "−" : "+" }}
            </button>
          </td>
          <td>{{ r.debtorCode }}</td>
          <td>{{ r.debtorName }}</td>
          <td class="c">{{ r.currency }}</td>
          <td class="r">{{ r.totals.cur | number : "1.2-2" }}</td>
          <td class="r">{{ r.totals.m1 | number : "1.2-2" }}</td>
          <td class="r">{{ r.totals.m2 | number : "1.2-2" }}</td>
          <td class="r">{{ r.totals.m3 | number : "1.2-2" }}</td>
          <td class="r" *ngIf="colShown('m4')">
            {{ r.totals.m4 || 0 | number : "1.2-2" }}
          </td>
          <td class="r" *ngIf="colShown('over5')">
            {{ r.totals.over5 || 0 | number : "1.2-2" }}
          </td>
          <td class="r">{{ r.totals.totalOverDue | number : "1.2-2" }}</td>
          <td class="r">{{ r.totals.balance | number : "1.2-2" }}</td>
        </tr>

        <!-- details (hidden until expand) -->
        <!-- ====== NON-GROUPED ====== -->
        <tr class="detail-row" *ngIf="r.expanded">
          <td [attr.colspan]="fullColSpan()">
            <div class="detail-wrap full">
              <table class="grid detail-yellow">
                <thead>
                  <tr>
                    <th>Doc Date</th>
                    <th>Due Date</th>
                    <th>Doc Type</th>
                    <th>Is OverDue</th>
                    <th class="r">CURRENT</th>
                    <th class="r">1 MONTH</th>
                    <th class="r">2 MONTHS</th>
                    <th class="r">3 MONTHS</th>
                    <th class="r" *ngIf="colShown('m4')">4 MONTHS</th>
                    <th class="r" *ngIf="colShown('over5')">5 &amp; OVER</th>
                    <th class="r">Balance</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let t of r.txns">
                    <td>{{ t.docDate }}</td>
                    <td>{{ t.dueDate }}</td>
                    <td class="c">{{ t.docType }}</td>
                    <td class="c">
                      <input type="checkbox" [checked]="t.isOverDue" disabled />
                    </td>
                    <td class="r">
                      {{ t.buckets?.cur ?? 0 | number : "1.2-2" }}
                    </td>
                    <td class="r">
                      {{ t.buckets?.m1 ?? 0 | number : "1.2-2" }}
                    </td>
                    <td class="r">
                      {{ t.buckets?.m2 ?? 0 | number : "1.2-2" }}
                    </td>
                    <td class="r">
                      {{ t.buckets?.m3 ?? 0 | number : "1.2-2" }}
                    </td>
                    <td class="r" *ngIf="colShown('m4')">
                      {{ t.buckets?.m4 ?? 0 | number : "1.2-2" }}
                    </td>
                    <td class="r" *ngIf="colShown('over5')">
                      {{ t.buckets?.over5 ?? 0 | number : "1.2-2" }}
                    </td>
                    <td class="r">
                      {{ (t.runBalance ?? t.buckets?.balance ?? 0) | number : "1.2-2" }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </td>
        </tr>
      </tbody>
      <tfoot class="sum-row">
        <tr>
          <!-- 6 cột đầu tiên: toggle + Debtor Code + Company + Agent + Phone + Currency -->
          <td colspan="4" class="r black"><strong>Total</strong></td>

          <td class="r">{{ totalsAll.cur | number : "1.2-2" }}</td>
          <td class="r">{{ totalsAll.m1 | number : "1.2-2" }}</td>
          <td class="r">{{ totalsAll.m2 | number : "1.2-2" }}</td>
          <td class="r">{{ totalsAll.m3 | number : "1.2-2" }}</td>

          <!-- Chỉ hiện khi bạn đang bật cột 4M / 5+ -->
          <td class="r" *ngIf="colShown('m4')">
            {{ totalsAll.m4 | number : "1.2-2" }}
          </td>
          <td class="r" *ngIf="colShown('over5')">
            {{ totalsAll.over5 | number : "1.2-2" }}
          </td>

          <td class="r">{{ totalsAll.totalOverDue | number : "1.2-2" }}</td>
          <td class="r">{{ totalsAll.balance | number : "1.2-2" }}</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Grouped view -->
  <div class="gridwrap" *ngIf="showGrouped()">
    <table>
      <thead>
        <tr>
          <th></th>
          <th (click)="onHeaderSort('debtorCode')">
            Creditor Code
            <span class="arrow" *ngIf="sortKey() === 'debtorCode'">{{
              sortDir() === "asc" ? "▲" : "▼"
            }}</span>
          </th>
          <th (click)="onHeaderSort('debtorName')">
            Company Name
            <span class="arrow" *ngIf="sortKey() === 'debtorName'">{{
              sortDir() === "asc" ? "▲" : "▼"
            }}</span>
          </th>
          <th>Currency</th>
          <th class="r">CURRENT</th>
          <th class="r">1 MONTH</th>
          <th class="r">2 MONTHS</th>
          <th class="r">3 MONTHS</th>
          <th class="r" *ngIf="colShown('m4')">4 MONTHS</th>
          <th class="r" *ngIf="colShown('over5')">5 &amp; OVER</th>
          <th class="r">Total Over Due</th>
          <th class="r" (click)="onHeaderSort('balance')">
            Balance
            <span class="arrow" *ngIf="sortKey() === 'balance'">{{
              sortDir() === "asc" ? "▲" : "▼"
            }}</span>
          </th>
        </tr>
      </thead>

      <ng-container *ngFor="let g of groups()">
        <tbody class="group-head">
          <tr>
            <td colspan="13">
              <strong
                >{{
                  fg.value.groupBy === "agent"
                    ? "Agent"
                    : fg.value.groupBy === "area"
                    ? "Area"
                    : "Creditor Type"
                }}: {{ g.key }}</strong
              >
              &nbsp; — Total Creditor: {{ g.items.length }}
            </td>
          </tr>
        </tbody>

        <tbody *ngFor="let r of g.items">
          <tr class="debtor">
            <td class="toggle">
              <button class="toggle-btn" (click)="toggle(r)" type="button">
                {{ r.expanded ? "−" : "+" }}
              </button>
            </td>
            <td>{{ r.debtorCode }}</td>
            <td>{{ r.debtorName }}</td>
            <td class="c">{{ r.currency }}</td>
            <td class="r">{{ r.totals.cur | number : "1.2-2" }}</td>
            <td class="r">{{ r.totals.m1 | number : "1.2-2" }}</td>
            <td class="r">{{ r.totals.m2 | number : "1.2-2" }}</td>
            <td class="r">{{ r.totals.m3 | number : "1.2-2" }}</td>
            <td class="r" *ngIf="colShown('m4')">
              {{ r.totals.m4 || 0 | number : "1.2-2" }}
            </td>
            <td class="r" *ngIf="colShown('over5')">
              {{ r.totals.over5 || 0 | number : "1.2-2" }}
            </td>
            <td class="r">{{ r.totals.totalOverDue | number : "1.2-2" }}</td>
            <td class="r">{{ r.totals.balance | number : "1.2-2" }}</td>
          </tr>

          <!-- ====== GROUPED ====== -->
          <tr class="detail-row" *ngIf="r.expanded">
            <td [attr.colspan]="fullColSpan()">
              <div class="gridwrap">
                <table class="grid detail-yellow">
                  <thead>
                    <tr>
                      <th>Doc Date</th>
                      <th>Due Date</th>
                      <th>Doc Type</th>
                      <th>Is OverDue</th>
                      <th class="r">CURRENT</th>
                      <th class="r">1 MONTH</th>
                      <th class="r">2 MONTHS</th>
                      <th class="r">3 MONTHS</th>
                      <th class="r" *ngIf="colShown('m4')">4 MONTHS</th>
                      <th class="r" *ngIf="colShown('over5')">5 &amp; OVER</th>
                      <th class="r">Balance</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let t of r.txns">
                      <td>{{ t.docDate }}</td>
                      <td>{{ t.dueDate }}</td>
                      <td class="c">{{ t.docType }}</td>
                      <td class="c">
                        <input
                          type="checkbox"
                          [checked]="t.isOverDue"
                          disabled
                        />
                      </td>
                      <td class="r">
                        {{ t.buckets?.cur ?? 0 | number : "1.2-2" }}
                      </td>
                      <td class="r">
                        {{ t.buckets?.m1 ?? 0 | number : "1.2-2" }}
                      </td>
                      <td class="r">
                        {{ t.buckets?.m2 ?? 0 | number : "1.2-2" }}
                      </td>
                      <td class="r">
                        {{ t.buckets?.m3 ?? 0 | number : "1.2-2" }}
                      </td>
                      <td class="r" *ngIf="colShown('m4')">
                        {{ t.buckets?.m4 ?? 0 | number : "1.2-2" }}
                      </td>
                      <td class="r" *ngIf="colShown('over5')">
                        {{ t.buckets?.over5 ?? 0 | number : "1.2-2" }}
                      </td>
                      <td class="r">
                        {{ (t.runBalance ?? t.buckets?.balance ?? 0) | number : "1.2-2" }}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </td>
          </tr>
        </tbody>
      </ng-container>
      <tfoot class="sum-row">
        <tr>
          <td colspan="4" class="r black"><strong>Total</strong></td>
          <td class="r">{{ totalsAll.cur | number : "1.2-2" }}</td>
          <td class="r">{{ totalsAll.m1 | number : "1.2-2" }}</td>
          <td class="r">{{ totalsAll.m2 | number : "1.2-2" }}</td>
          <td class="r">{{ totalsAll.m3 | number : "1.2-2" }}</td>
          <td class="r" *ngIf="colShown('m4')">
            {{ totalsAll.m4 | number : "1.2-2" }}
          </td>
          <td class="r" *ngIf="colShown('over5')">
            {{ totalsAll.over5 | number : "1.2-2" }}
          </td>
          <td class="r">{{ totalsAll.totalOverDue | number : "1.2-2" }}</td>
          <td class="r">{{ totalsAll.balance | number : "1.2-2" }}</td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>
