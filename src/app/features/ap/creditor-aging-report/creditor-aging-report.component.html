<div class="page">

  <!-- Options -->
  <div class="options">
    <form [formGroup]="fg">
      <fieldset class="filters">
        <div class="f">
          <div class="lbl">Date</div>
          <div >
            <input type="date" formControlName="asOf" />
          </div>
        </div>

        <div class="f">
          <div class="lbl">Creditor</div>
          <div >
            <select formControlName="debtor">
              <option value="ALL">All</option>
              <option *ngFor="let d of debtors" [value]="d.code">
                {{ d.name }}
              </option>
            </select>
          </div>
        </div>

        <div class="f">
          <div class="lbl">Creditor Type</div>
          <div >
            <select formControlName="debtorType">
              <option value="ALL">All</option>
              <option *ngFor="let t of debtorTypes" [value]="t">
                {{ t }}
              </option>
            </select>
          </div>
        </div>

        <div class="f">
          <div class="lbl">Aging Months</div>
          <div >
            <select formControlName="agingMonths">
              <option [value]="4">4</option>
              <option [value]="6">6</option>
            </select>
          </div>
        </div>

        <div class="f">
          <div class="lbl">Group by</div>
          <div>
            <select formControlName="groupBy">
              <option value="none">None</option>
              <option value="debtorType">Creditor Type</option>
            </select>
          </div>
        </div>

        <!-- Inquiry (right aligned like Outstanding) -->
        <div class="f action">
          <div class="lbl">&nbsp;</div>
          <div>
            <button type="button" class="btn inquiry" (click)="inquiry()">
              Inquiry
            </button>
          </div>
        </div>
      </fieldset>
    </form>
  </div>

  <!-- Report Card -->
  <div class="report-card">
    <div class="report-head">
      <div class="rh-title">Creditor Aging Report</div>
            <div class="rh-company">{{ companyName }}</div>
      <div class="rh-period">As at {{ fg.value.asOf }}</div>
    </div>

    <!-- Table (no group) -->
    <div class="gridwrap" *ngIf="!showGrouped()">
      <table>
        <thead>
          <tr>
            <th class="toggle"></th>
            <th class="l" (click)="onHeaderSort('debtorCode')">
              Creditor No.
              <span class="arrow" *ngIf="sortKey() === 'debtorCode'">{{
                sortDir() === "asc" ? "▲" : "▼"
              }}</span>
            </th>
            <th class="l" (click)="onHeaderSort('debtorName')">
              Company Name
              <span class="arrow" *ngIf="sortKey() === 'debtorName'">{{
                sortDir() === "asc" ? "▲" : "▼"
              }}</span>
            </th>
            <th class="l">Currency</th>

            <th class="r">CURRENT</th>
            <th class="r">1 MONTH</th>
            <th class="r">2 MONTHS</th>
            <th class="r">3 MONTHS</th>
            <th class="r" *ngIf="colShown('m4')">4 MONTHS</th>
            <th class="r" *ngIf="colShown('over5')">5 &amp; OVER</th>
            <th class="r">Total Over Due</th>
            <th class="r" (click)="onHeaderSort('balance')">
              Balance
              <span class="arrow" *ngIf="sortKey() === 'balance'">{{
                sortDir() === "asc" ? "▲" : "▼"
              }}</span>
            </th>
          </tr>
        </thead>

        <tbody *ngFor="let r of rows()">
          <!-- creditor total row -->
          <tr class="debtor">
            <td class="toggle">
              <button class="toggle-btn" (click)="toggle(r)" type="button">
                {{ r.expanded ? "−" : "+" }}
              </button>
            </td>
            <td class="l">{{ r.debtorCode }}</td>
            <td>{{ r.debtorName }}</td>
            <td class="l">{{ r.currency }}</td>
            <td class="r">{{ r.totals.cur | number : "1.2-2" }}</td>
            <td class="r">{{ r.totals.m1 | number : "1.2-2" }}</td>
            <td class="r">{{ r.totals.m2 | number : "1.2-2" }}</td>
            <td class="r">{{ r.totals.m3 | number : "1.2-2" }}</td>
            <td class="r" *ngIf="colShown('m4')">
              {{ r.totals.m4 || 0 | number : "1.2-2" }}
            </td>
            <td class="r" *ngIf="colShown('over5')">
              {{ r.totals.over5 || 0 | number : "1.2-2" }}
            </td>
            <td class="r">{{ r.totals.totalOverDue | number : "1.2-2" }}</td>
            <td class="r">{{ r.totals.balance | number : "1.2-2" }}</td>
          </tr>

          <!-- details (hidden until expand) -->
          <tr class="detail-row" *ngIf="r.expanded">
            <td [attr.colspan]="fullColSpan()">
              <div class="detail-wrap">
                <table class="detail-grid">
                  <thead>
                    <tr>
                      <th class="l">Doc Date</th>
                      <th class="l">Due Date</th>
                      <th class="l">Doc Type</th>
                      <th class="c">Is OverDue</th>
                      <th class="r">CURRENT</th>
                      <th class="r">1 MONTH</th>
                      <th class="r">2 MONTHS</th>
                      <th class="r">3 MONTHS</th>
                      <th class="r" *ngIf="colShown('m4')">4 MONTHS</th>
                      <th class="r" *ngIf="colShown('over5')">5 &amp; OVER</th>
                      <th class="r">Balance</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let t of r.txns">
                      <td class="l">{{ t.docDate }}</td>
                      <td class="l">{{ t.dueDate }}</td>
                      <td class="l">{{ t.docType }}</td>
                      <td class="c">
                        <input type="checkbox" [checked]="t.isOverDue" disabled />
                      </td>
                      <td class="r">{{ t.buckets?.cur ?? 0 | number : "1.2-2" }}</td>
                      <td class="r">{{ t.buckets?.m1 ?? 0 | number : "1.2-2" }}</td>
                      <td class="r">{{ t.buckets?.m2 ?? 0 | number : "1.2-2" }}</td>
                      <td class="r">{{ t.buckets?.m3 ?? 0 | number : "1.2-2" }}</td>
                      <td class="r" *ngIf="colShown('m4')">{{ t.buckets?.m4 ?? 0 | number : "1.2-2" }}</td>
                      <td class="r" *ngIf="colShown('over5')">{{ t.buckets?.over5 ?? 0 | number : "1.2-2" }}</td>
                      <td class="r">{{ (t.runBalance ?? t.buckets?.balance ?? 0) | number : "1.2-2" }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </td>
          </tr>
        </tbody>

        <tfoot class="sum-row">
          <tr>
            <td colspan="4" class="r"><strong>Total</strong></td>
            <td class="r blue">{{ totalsAll.cur | number : "1.2-2" }}</td>
            <td class="r blue">{{ totalsAll.m1 | number : "1.2-2" }}</td>
            <td class="r blue">{{ totalsAll.m2 | number : "1.2-2" }}</td>
            <td class="r blue">{{ totalsAll.m3 | number : "1.2-2" }}</td>
            <td class="r blue" *ngIf="colShown('m4')">{{ totalsAll.m4 | number : "1.2-2" }}</td>
            <td class="r blue" *ngIf="colShown('over5')">{{ totalsAll.over5 | number : "1.2-2" }}</td>
            <td class="r blue">{{ totalsAll.totalOverDue | number : "1.2-2" }}</td>
            <td class="r blue">{{ totalsAll.balance | number : "1.2-2" }}</td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Grouped view -->
    <div class="gridwrap" *ngIf="showGrouped()">
      <table>
        <thead>
          <tr>
            <th></th>
            <th class="l" (click)="onHeaderSort('debtorCode')">
              Creditor Code
              <span class="arrow" *ngIf="sortKey() === 'debtorCode'">{{
                sortDir() === "asc" ? "▲" : "▼"
              }}</span>
            </th>
            <th class="l" (click)="onHeaderSort('debtorName')">
              Company Name
              <span class="arrow" *ngIf="sortKey() === 'debtorName'">{{
                sortDir() === "asc" ? "▲" : "▼"
              }}</span>
            </th>
            <th class="l">Currency</th>
            <th class="r">CURRENT</th>
            <th class="r">1 MONTH</th>
            <th class="r">2 MONTHS</th>
            <th class="r">3 MONTHS</th>
            <th class="r" *ngIf="colShown('m4')">4 MONTHS</th>
            <th class="r" *ngIf="colShown('over5')">5 &amp; OVER</th>
            <th class="r">Total Over Due</th>
            <th class="r" (click)="onHeaderSort('balance')">
              Balance
              <span class="arrow" *ngIf="sortKey() === 'balance'">{{
                sortDir() === "asc" ? "▲" : "▼"
              }}</span>
            </th>
          </tr>
        </thead>

        <ng-container *ngFor="let g of groups()">
          <tbody class="group-head">
            <tr>
              <td colspan="13">
                <strong>Creditor Type: {{ g.key }}</strong>
                &nbsp; — Total Creditor: {{ g.items.length }}
              </td>
            </tr>
          </tbody>

          <tbody *ngFor="let r of g.items">
            <tr class="debtor">
              <td class="toggle">
                <button class="toggle-btn" (click)="toggle(r)" type="button">
                  {{ r.expanded ? "−" : "+" }}
                </button>
              </td>
              <td class="l">{{ r.debtorCode }}</td>
              <td class="l">{{ r.debtorName }}</td>
              <td class="l">{{ r.currency }}</td>
              <td class="r">{{ r.totals.cur | number : "1.2-2" }}</td>
              <td class="r">{{ r.totals.m1 | number : "1.2-2" }}</td>
              <td class="r">{{ r.totals.m2 | number : "1.2-2" }}</td>
              <td class="r">{{ r.totals.m3 | number : "1.2-2" }}</td>
              <td class="r" *ngIf="colShown('m4')">{{ r.totals.m4 || 0 | number : "1.2-2" }}</td>
              <td class="r" *ngIf="colShown('over5')">{{ r.totals.over5 || 0 | number : "1.2-2" }}</td>
              <td class="r">{{ r.totals.totalOverDue | number : "1.2-2" }}</td>
              <td class="r">{{ r.totals.balance | number : "1.2-2" }}</td>
            </tr>

            <tr class="detail-row" *ngIf="r.expanded">
              <td [attr.colspan]="fullColSpan()">
                <div class="detail-wrap">
                  <table class="detail-grid">
                    <thead>
                      <tr>
                        <th class="l">Doc Date</th>
                        <th class="l">Due Date</th>
                        <th class="l">Doc Type</th>
                        <th>Is OverDue</th>
                        <th class="r">CURRENT</th>
                        <th class="r">1 MONTH</th>
                        <th class="r">2 MONTHS</th>
                        <th class="r">3 MONTHS</th>
                        <th class="r" *ngIf="colShown('m4')">4 MONTHS</th>
                        <th class="r" *ngIf="colShown('over5')">5 &amp; OVER</th>
                        <th class="r">Balance</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let t of r.txns">
                        <td class="l">{{ t.docDate }}</td>
                        <td class="l">{{ t.dueDate }}</td>
                        <td class="l">{{ t.docType }}</td>
                        <td class="c">
                          <input type="checkbox" [checked]="t.isOverDue" disabled />
                        </td>
                        <td class="r">{{ t.buckets?.cur ?? 0 | number : "1.2-2" }}</td>
                        <td class="r">{{ t.buckets?.m1 ?? 0 | number : "1.2-2" }}</td>
                        <td class="r">{{ t.buckets?.m2 ?? 0 | number : "1.2-2" }}</td>
                        <td class="r">{{ t.buckets?.m3 ?? 0 | number : "1.2-2" }}</td>
                        <td class="r" *ngIf="colShown('m4')">{{ t.buckets?.m4 ?? 0 | number : "1.2-2" }}</td>
                        <td class="r" *ngIf="colShown('over5')">{{ t.buckets?.over5 ?? 0 | number : "1.2-2" }}</td>
                        <td class="r">{{ (t.runBalance ?? t.buckets?.balance ?? 0) | number : "1.2-2" }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
          </tbody>
        </ng-container>

        <tfoot class="sum-row">
          <tr>
            <td colspan="4" class="r">Total</td>
            <td class="r">{{ totalsAll.cur | number : "1.2-2" }}</td>
            <td class="r">{{ totalsAll.m1 | number : "1.2-2" }}</td>
            <td class="r">{{ totalsAll.m2 | number : "1.2-2" }}</td>
            <td class="r">{{ totalsAll.m3 | number : "1.2-2" }}</td>
            <td class="r" *ngIf="colShown('m4')">{{ totalsAll.m4 | number : "1.2-2" }}</td>
            <td class="r" *ngIf="colShown('over5')">{{ totalsAll.over5 | number : "1.2-2" }}</td>
            <td class="r">{{ totalsAll.totalOverDue | number : "1.2-2" }}</td>
            <td class="r">{{ totalsAll.balance | number : "1.2-2" }}</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>

</div>
