<div class="page">
  <!-- Title + Toolbar -->
  <div class="titlebar">
    <h1>Creditor Maintenance</h1>
    <div class="toolbar" role="toolbar" aria-label="Debtor actions">
      <input
        class="search1"
        type="text"
        placeholder="Search code / company name ..."
        [(ngModel)]="q"
      />
      <button class="btn primary" (click)="newDebtor()">
        <span class="ico plus"></span> New
      </button>
      <button class="btn" [disabled]="!selected" (click)="editDebtor()">
        <span class="ico edit"></span> Edit
      </button>
      <button
        class="btn danger"
        [disabled]="!selected"
        (click)="onDeleteDebtor()"
      >
        <span class="ico trash"></span> Delete
      </button>
    </div>
  </div>

  <!-- Grid -->
  <div class="gridwrap">
    <table>
      <thead>
        <tr>
          <th (click)="setSort('code')">Code</th>
          <th (click)="setSort('name')">Company Name</th>
          <th (click)="setSort('type')">Creditor Type</th>
          <th>Phone 1</th>
          <th>Group Company</th>
          <th>Active</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let r of filteredRows(); let i = index"
          (click)="select(r)"
          [class.selected]="selected === r"
        >
          <td>{{ r.code }}</td>
          <td>{{ r.name }}</td>
          <td>{{ r.type }}</td>
          <td>
            {{ r.phone }}
          </td>
          <td>
            <input type="checkbox" [checked]="r.groupCompany" disabled />
          </td>
          <td>
            <input type="checkbox" [checked]="r.active" disabled />
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pager -->
  <div class="pager">
    <div class="nav">
      <button class="pg" (click)="first()">&laquo;</button>
      <button class="pg" (click)="prev()">&lsaquo;</button>
      <span class="pginfo">Page {{ page }} / {{ totalPages }}</span>
      <button class="pg" (click)="next()">&rsaquo;</button>
      <button class="pg" (click)="last()">&raquo;</button>
    </div>
  </div>

  <!-- =============== CREATE / EDIT / VIEW Creditor ============== -->
  <div class="dialog" *ngIf="showForm">
    <div class="dialog-panel" style="width: min(1100px, 96vw)">
      <div class="dialog-title">
        {{
          formMode === "new"
            ? "Create Creditor"
            : formMode === "edit"
            ? "Edit Creditor"
            : "View Creditor"
        }}
        <button class="x" (click)="showForm = false">✕</button>
      </div>

      <form [formGroup]="creditorForm" class="dialog-body">
        <div class="gbox">
          <div class="gbox-title">Profile</div>
          <div class="gbox-body grid3">
            <label
              >Control Account
              <select formControlName="controlAccount">
                <option *ngFor="let c of controlAccounts" [ngValue]="c.code">
                  {{ c.code }}
                </option>
              </select>
            </label>

            <label>
               Creditor Type
                <select formControlName="type" [disabled]="formMode === 'view'">
                  <option *ngFor="let t of creditorTypes" [ngValue]="t.code">
                    {{ t.name }}
                  </option>
                </select>
            </label>

            <label
              >Company Name
              <input formControlName="name" [readonly]="formMode === 'view'" />
            </label>

            <label
              >Registration No.
              <input
                formControlName="registrationNo"
                [readonly]="formMode === 'view'"
              />
            </label>

            <label
              > Creditor Account
              <div style="display: flex; gap: 6px;width: 100%;">
                <input   style="width: 100%;" formControlName="code" [readonly]="formMode !== 'new'" />
                <button
                  class="btn primary"
                  type="button"
                  (click)="autoGenerateCode()"
                  [disabled]="formMode !== 'new'"
                >
                  ＋
                </button>
              </div>
            </label>
              <label
                >Currency
                <select formControlName="currency">
                  <option *ngFor="let c of currencies" [ngValue]="c.code">
                    {{ c.code }}
                  </option>
                </select>
              </label>
            <div class="checks-inline">
              <label class="chk">
                <input
                  type="checkbox"
                  formControlName="groupCompany"
                  [disabled]="formMode === 'view'"
                />
                <span>Group Company</span>
              </label>

              <label class="chk">
                <input type="checkbox" formControlName="active" />
                <span>Active</span>
              </label>
            </div>
          </div>
        </div>
        <!-- GENERAL + OTHERS (merged; no tabs) -->
        <div class="form-section">
          <div class="gbox">
            <div class="gbox-title">Address & Contact</div>
            <!-- General -->
            <div class="gbox-body grid3">
              <label class="wide"
                >Billing Address
                <textarea
                  rows="1"
                  formControlName="billAddress"
                  [readonly]="formMode === 'view'"
                ></textarea>
              </label>

              <label
                >Phone<input
                  formControlName="phone"
                  [readonly]="formMode === 'view'"
              /></label>
              <label
                >Fax<input
                  formControlName="fax"
                  [readonly]="formMode === 'view'"
              /></label>
              <label
                >Post Code<input
                  formControlName="postCode"
                  [readonly]="formMode === 'view'"
              /></label>
              <label
                >Email Address<input
                  formControlName="email"
                  [readonly]="formMode === 'view'"
              /></label>

              <label
                >Website<input
                  formControlName="website"
                  [readonly]="formMode === 'view'"
              /></label>

            </div>
          </div>
          <!-- Statement / Aging / Credit -->
          <div class="gbox">
            <div class="gbox-title">Statement / Aging / Credit</div>
            <div class="gbox-body grid3 three-cols">
              <div class="col">
                <div class="lbl">Statement Type</div>
                <div class="radio-box">
                  <div class="radio-grid">
                    <label class="radio-inline"
                      ><input
                        type="radio"
                        formControlName="statementType"
                        value="OpenItem"
                      /><span>Open Item</span></label
                    >
                    <label class="radio-inline"
                      ><input
                        type="radio"
                        formControlName="statementType"
                        value="BalanceForward"
                      /><span>Balance Forward</span></label
                    >
                    <label class="radio-inline"
                      ><input
                        type="radio"
                        formControlName="statementType"
                        value="NoStatement"
                      /><span>No Statement</span></label
                    >
                  </div>
                </div>
              </div>

              <div class="col">
                <div class="lbl">Aging On</div>
                <div class="radio-box">
                  <div class="radio-grid">
                    <label class="radio-inline"
                      ><input
                        type="radio"
                        formControlName="agingOn"
                        value="InvoiceDate"
                      /><span>Invoice Date</span></label
                    >
                    <label class="radio-inline"
                      ><input
                        type="radio"
                        formControlName="agingOn"
                        value="DueDate"
                      /><span>Due Date</span></label
                    >
                  </div>
                </div>
              </div>

              <div class="col">
                <label
                  >Credit Term
                  <select formControlName="creditTerm">
                    <option *ngFor="let ct of creditTerms" [ngValue]="ct.code">
                      {{ ct.name }}
                    </option>
                  </select>
                </label>
                <button
                  class="btn primary"
                  type="button"
                  (click)="openCreditControl()"
                >
                  Credit Control
                </button>
              </div>
            </div>
          </div>
          <div class="gbox">
            <div class="gbox-title">Other</div>
            <div class="gbox-body">
              <div class="grid3">
                <label
                  >Sales Tax Exemption No.<input
                    formControlName="taxExemptionNo"
                    [readonly]="formMode === 'view'"
                /></label>
                <label
                  >Expired Date
                  <input
                    class="inp"
                    type="date"
                    formControlName="taxExemptionExpiry"
                    [disabled]="formMode === 'view'"
                  />
                </label>
                <label
                  >Discount Percent
                  <input
                    type="number"
                    step="0.01"
                    formControlName="discountPercent"
                    [readonly]="formMode === 'view'"
                  />
                </label>
                <label
                  >GST
                  <select formControlName="gstType">
                    <option *ngFor="let t of taxTypes" [ngValue]="t.code">
                      {{ t.name }}
                    </option>
                  </select>
                </label>
              </div>
            </div>
          </div>
        </div>
        <div class="dialog-actions">
          <button type="button" class="btn cancel" (click)="showForm = false">
            Cancel
          </button>
          <button
            *ngIf="formMode !== 'view'"
            type="button"
            class="btn primary"
            (click)="saveDebtor()"
          >
            Save
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- =================== CREDIT CONTROL POPUP =================== -->
  <div class="dialog" *ngIf="showCredit">
    <div
      class="dialog-panel-small"
      role="dialog"
      aria-modal="true"
      style="width: min(720px, 96vw)"
    >
      <div class="dialog-title">
        Creditor Credit Control
        <button class="x" (click)="showCredit = false" aria-label="Close">
          ×
        </button>
      </div>

      <div class="dialog-body">
        <!-- HÀNG 1: 3 Ô Credit Limit / Overdue Limit / Scope -->
        <form [formGroup]="creditForm" class="cc-grid">
          <label class="cell">
            Credit Limit
            <input
              type="text"
              appAmount
              [decimals]="2"
              formControlName="creditLimit"
            />
          </label>

          <label class="cell">
            Credit Term's Overdue Limit
            <input
              type="text"
              appAmount
              [decimals]="2"
              formControlName="overdueLimit"
            />
          </label>

          <label class="cell">
            Credit Control
            <select formControlName="scope">
              <option value="ALL">All Documents</option>
              <option value="BYDOC">By Document</option>
            </select>
          </label>
        </form>

        <!-- HÀNG 2: 3 RADIO – MỖI CÁI 1 DÒNG -->
        <div class="cc-modes" [formGroup]="creditForm">
          <!-- 1) All Disabled -->
          <label class="radio-inline">
            <input type="radio" formControlName="mode" value="DISABLED" />
            <span>All Disabled</span>
          </label>

          <!-- 2) Controlled by credit term -->
          <div
            class="mode-row"
            [class.dimmed]="creditForm.value.mode !== 'BY_TERM'"
          >
            <label class="radio-inline">
              <input type="radio" formControlName="mode" value="BY_TERM" />
              <span>Controlled by credit term</span>
            </label>

            <div class="mode-body grid2">
              <label>
                If exceed credit limit
                <select formControlName="exceedCreditAction">
                  <option value="ALLOW">No Block</option>
                  <option value="BLOCK">Block</option>
                  <option value="NEEDPWD">Need Password</option>
                </select>
              </label>
              <label>
                If exceed overdue limit
                <select formControlName="exceedOverdueAction">
                  <option value="ALLOW">No Block</option>
                  <option value="BLOCK">Block</option>
                  <option value="NEEDPWD">Need Password</option>
                </select>
              </label>
            </div>
          </div>

          <!-- 3) Suspend -->
          <div
            class="mode-row"
            [class.dimmed]="creditForm.value.mode !== 'SUSPEND'"
          >
            <label class="radio-inline">
              <input type="radio" formControlName="mode" value="SUSPEND" />
              <span>Suspend</span>
            </label>

            <div class="mode-body">
              <label
                >Suspend Reason
                <input formControlName="suspendReason" />
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="dialog-actions">
        <button class="btn cancel" (click)="showCredit = false">Cancel</button>
        <button class="btn primary" (click)="saveCreditControl()">OK</button>
      </div>
    </div>
  </div>
</div>
<!-- Confirm delete contact -->
<div class="dialog" *ngIf="showContactDeleteConfirm">
  <div class="dialog-panel-small" role="dialog" aria-modal="true">
    <div class="dialog-title">
      Delete Contact
      <button
        class="x"
        (click)="closeContactDeleteConfirm()"
        aria-label="Close"
      >
        ×
      </button>
    </div>

    <div class="dialog-body">
      <p>
        Are you sure you want to delete
        <b>{{ selectedContact?.name || "this contact" }}</b
        >?
      </p>
    </div>

    <div class="dialog-actions">
      <button class="btn cancel" (click)="closeContactDeleteConfirm()">Cancel</button>
      <button class="btn danger" (click)="confirmDeleteContact()">
        Delete
      </button>
    </div>
  </div>
</div>

<!-- Success popup -->
  <div class="ac-dialog-backdrop" *ngIf="showSuccess">
    <div
      class="ac-card-no-padding ac-dialog-panel-sm ac-dialog-success"
      role="dialog"
      aria-modal="true"
    >
      <div class="ac-dialog-header ac-dialog-success-header">
        <span>Success</span>
        <button
          class="ac-dialog-close"
          (click)="closeSuccess()"
          aria-label="Close"
        >
          ×
        </button>
      </div>
      <div class="ac-dialog-body">
        <p class="ac-dialog-success-text">
          {{ successMsg }}
        </p>
      </div>
      <div class="ac-dialog-footer">
        <button
          class="ac-btn ac-btn-primary"
          type="button"
          (click)="closeSuccess()"
        >
          OK
        </button>
      </div>
    </div>
  </div>
<!-- ===================== BRANCH EDITOR POPUP ===================== -->
<div class="dialog" *ngIf="showBranchEditor">
  <div class="dialog-panel-small" style="width: min(720px, 96vw)">
    <div class="dialog-title">
      {{ branchEditIndex === -1 ? "Add Branch" : "Edit Branch" }}
      <button class="x" (click)="closeBranchEditor()">×</button>
    </div>

    <form class="dialog-body" [formGroup]="branchForm">
      <div class="grid2">
        <label>Branch Code<input formControlName="code" /></label>
        <label>Branch Name<input formControlName="name" /></label>
      </div>

      <label class="wide"
        >Address
        <textarea rows="3" formControlName="address"></textarea>
      </label>

      <div class="grid3">
        <label>Post Code<input formControlName="postCode" /></label>
        <label>Attention<input formControlName="attention" /></label>
        <label>Email Address<input formControlName="email" /></label>

        <label>Phone 1<input formControlName="phone1" /></label>
        <label>Phone 2<input formControlName="phone2" /></label>
        <label>Fax 1<input formControlName="fax1" /></label>
        <label>Fax 2<input formControlName="fax2" /></label>
        <label
          >Area
          <select formControlName="area">
            <option *ngFor="let a of areas" [ngValue]="a.code">
              {{ a.name }}
            </option>
          </select>
        </label>
      </div>
    </form>

    <div class="dialog-actions">
      <button class="btn cancel" (click)="closeBranchEditor()">Cancel</button>
      <button
        class="btn primary"
        (click)="saveBranchEditor()"
        [disabled]="!branchForm.valid"
      >
        OK
      </button>
    </div>
  </div>
</div>

<!-- ===================== CONFIRM DELETE BRANCH ===================== -->
<div class="dialog" *ngIf="showBranchDeleteConfirm">
  <div class="dialog-panel-small" role="dialog" aria-modal="true">
    <div class="dialog-title">
      Delete Branch
      <button class="x" (click)="closeBranchDeleteConfirm()" aria-label="Close">
        ×
      </button>
    </div>

    <div class="dialog-body">
      <p>
        Are you sure you want to delete
        <b>{{ selectedBranch?.code || "this branch" }}</b
        >?
      </p>
    </div>

    <div class="dialog-actions">
      <button class="btn cancel" (click)="closeBranchDeleteConfirm()">Cancel</button>
      <button class="btn danger" (click)="confirmDeleteBranch()">Delete</button>
    </div>
  </div>
</div>
<div class="dialog" *ngIf="showDeleteDebtorConfirm">
  <div class="dialog-panel-small" role="dialog" aria-modal="true">
    <div class="dialog-title">
      Delete Creditor &nbsp;<button
        class="x"
        (click)="closeDeleteDebtorConfirm()"
        aria-label="Close"
      >
        ×
      </button>
    </div>

    <div class="dialog-body">
      <p>
        Are you sure you want to delete
        <b>{{ selected?.code }}</b>
        ?
      </p>
    </div>

    <div class="dialog-actions">
      <button class="btn cancel" (click)="closeDeleteDebtorConfirm()">Cancel</button>
      <button class="btn danger" (click)="deleteDebtor()">Delete</button>
    </div>
  </div>
</div>
