<div class="ac-page">
  <!-- Xero-like toolbar -->
  <div class="xero-toolbar">
    <div class="btnrow">
      <button type="button" class="ac-btn ac-btn-primary" (click)="openNewNormal()">+ Add Account</button>
      <button type="button" class="ac-btn" (click)="openBankCash()">+ Add Bank Account</button>

      <div class="menu" (click)="$event.stopPropagation()">
        <button type="button" class="ac-btn" (click)="toggleAddMenu($event)">More â–¾</button>
        <div class="menu-panel" *ngIf="ui.addMenuOpen" (click)="$event.stopPropagation()">
          <button type="button" (click)="openDebtorCtrl(); ui.addMenuOpen=false">Add Debtor Control</button>
          <button type="button" (click)="openCreditorCtrl(); ui.addMenuOpen=false">Add Creditor Control</button>
          <button type="button" (click)="openStock(); ui.addMenuOpen=false">Add Stock Control</button>
          <button type="button" (click)="openRetained(); ui.addMenuOpen=false">Add Retained Earning</button>
          <button type="button" (click)="openFixedAsset(); ui.addMenuOpen=false">Add Fixed Asset Account</button>
          <button type="button" (click)="openFixedLinks(); ui.addMenuOpen=false">Add Maintain Fixed Assets
            Links</button>
        </div>
      </div>
      <button type="button" class="ac-btn" (click)="print()">Print PDF</button>
      <button type="button" class="ac-btn" (click)="import()">Import</button>
      <button type="button" class="ac-btn" (click)="export()">Export</button>
    </div>

    <div class="tabrow" role="tablist">
      <button type="button" class="tab" [class.active]="selectedType === 'ALL'" (click)="selectType('ALL')">All
        Accounts</button>
      <button type="button" class="tab" *ngFor="let t of roots" [class.active]="selectedType === t.id"
        (click)="selectType(t.id)">
        {{ t.desc | titlecase }}
      </button>
    </div>

    <div class="subbar">
      <div class="upto">
      </div>

      <div class="search">
        <input type="text" [(ngModel)]="findText" placeholder="Search description/ acc no..."
          (keyup.enter)="doFind()" (ngModelChange)="activeFilter=$event" />
      </div>
    </div>
  </div>

  <div class="ac-card">

    <section class="gridwrap">
      <div class="tablebar">
        <button type="button" class="ac-btn ac-btn-danger" (click)="askBulkDelete()" [disabled]="!hasSelection">
          Delete
        </button>
        <span class="selhint">
          {{ hasSelection ? (selectedCount + ' accounts selected') : 'No accounts selected' }}
        </span>
      </div>
      <table class="ac-table ac-table-sm">
        <thead>
          <tr>
            <th class="c col-check">
              <input type="checkbox" [checked]="allSelectableChecked" (change)="toggleSelectAll($event)" />
            </th>
            <th class="l">Description</th>
            <th class="l">Type</th>
            <th class="l">Acc. No.</th>
            <th class="l" style="width: 200px">Special Account Type</th>
            <th class="l">Currency</th>
            <th class="bal r">YTD</th>
          </tr>
        </thead>
        <tbody>
          <tr class="row" *ngFor="let r of listRows" [attr.id]="'row-' + r.node.id"
            [class.row-selected]="isChecked(r.node) || selectedNodeId === r.node.id" (click)="selectNode(r.node)">
            <td class="c col-check" (click)="$event.stopPropagation()">
              <ng-container *ngIf="canDelete(r.node); else lockedCell">
                <input type="checkbox" [checked]="isChecked(r.node)"
                  (change)="toggleChecked(r.node, $any($event.target).checked)" />
              </ng-container>
              <ng-template #lockedCell>
                <span class="lock" title="Cannot delete">ðŸ”’</span>
              </ng-template>
            </td>
            <td class="l">
              <a class="link desc-link" href="#"
                (click)="$event.preventDefault(); $event.stopPropagation(); openEdit(r.node)">
                {{ r.node.desc }}
              </a>
            </td>
            <td class="l type">{{ r.typeDesc }}</td>
            <td class="l code" style="font-weight: 700;">
              {{ r.node.code }}
            </td>
            <td class="l">{{ r.node.specialCode || '' }}</td>
            <td class="l">{{ r.node.currency || '' }}</td>
            <td class="r" [ngClass]="amountClass(r.node.balance)">
              {{ (r.node.balance ?? 0) | number:'1.2-2' }}
            </td>
          </tr>
          <tr *ngIf="listRows.length === 0">
            <td colspan="7" class="muted" style="padding:12px;">No records</td>
          </tr>
        </tbody>
      </table>
    </section>
  </div>

  <!-- ======= MODALS (giá»¯ nguyÃªn) ======= -->

  <!-- New Normal Account (Xero-style modal) -->
  <div class="ac-dialog-backdrop" *ngIf="ui.newNormalOpen" (click)="ui.newNormalOpen=false">
    <div class="ac-card-no-padding ac-dialog-panel-lg" (click)="$event.stopPropagation()">
      <div class="ac-dialog-header">
        Add New Account
        <button type="button" class="ac-dialog-close" (click)="ui.newNormalOpen=false">Ã—</button>
      </div>

      <div class="ac-dialog-body">
        <div class="ac-dialog-form-grid-2">
          <label class="ac-form-field">
            <span class="ac-form-label">Account Type</span>
            <span class="ac-form-hint">Choose Account Type</span>
            <select [(ngModel)]="newNormal.parentId">
              <option *ngFor="let t of getTypesOnly()" [value]="t.id">{{ t.desc }}</option>
            </select>
          </label>
          <label class="ac-form-field">
            <span class="ac-form-label">Account No.</span>
            <span class="ac-form-hint">Format must be 3 digits, a dash, and 4 chars (e.g. 311-0110)</span>
            <input name="newNormalAccNo" [ngModel]="newNormal.code"
              (ngModelChange)="newNormal.code = normalizeAcc($event); validateNewNormalAccNo(newNormal.code)"
              #newNormalAccNo="ngModel" required [pattern]="accPattern" placeholder="" />
            <!-- <div class="err" *ngIf="newNormalAccNo.invalid || newNormalAccNoDup">
              <div *ngIf="newNormalAccNo.errors?.['required']">Account number is required.</div>
              <div *ngIf="newNormalAccNo.errors?.['pattern']">Account number must be 1â€“10 digits.</div>
              <div *ngIf="newNormalAccNoDup">Account number already exists.</div>
            </div> -->
          </label>

          <label class="ac-form-field">
            <span class="ac-form-label">Description</span>
            <span class="ac-form-hint">A description of how this account should be used</span>
            <input name="newNormalDesc" [(ngModel)]="newNormal.desc" #newNormalDesc="ngModel" required
              maxlength="100" />
            <!-- <div class="err" *ngIf="newNormalDesc.invalid">
              <div *ngIf="newNormalDesc.errors?.['required']">Description is required.</div>
            </div> -->
          </label>

          <label class="ac-form-field">
            <span class="ac-form-label">Currency</span>
            <span class="ac-form-hint">Currency for account</span>
            <select [(ngModel)]="newNormal.currency">
              <option value="MYR">MYR</option>
              <option value="USD">USD</option>
              <option value="SGD">SGD</option>
            </select>
          </label>

          <label class="ac-form-field">
            <span class="ac-form-label">Cash Flow Category</span>
            <span class="ac-form-hint">Classify accounts for cash flow reporting</span>
            <select [(ngModel)]="newNormal.cashflow">
              <option value="Operating Activities">Operating Activities</option>
              <option value="Investing Activities">Investing Activities</option>
              <option value="Financing Activities">Financing Activities</option>
            </select>
          </label>
        </div>
      </div>
      <br>
      <div class="ac-dialog-footer">
        <button type="button" class="ac-btn ac-btn-ghost" (click)="ui.newNormalOpen=false">Cancel</button>
        <button type="button" class="xbtn primary" (click)="saveNewNormal()"
          [disabled]="newNormalAccNo.invalid || newNormalAccNoDup || newNormalDesc.invalid || !newNormal.desc?.trim() || !newNormal.code?.trim()">
          Create
        </button>
      </div>
    </div>
  </div>

  <!-- Fixed Asset -->
  <div class="ac-dialog-backdrop" *ngIf="ui.fixedAssetOpen">
    <div class="ac-card-no-padding ac-dialog-panel-lg">
      <div class="ac-dialog-header">
        Add New Fixed Asset Account
        <button class="ac-dialog-close" (click)="ui.fixedAssetOpen = false">Ã—</button>
      </div>

      <div class="dialog-body section-stack">
        <!-- SECTION 1 -->
        <div class="section">
          <div class="section-title">
            <span class="badge">1</span> Fixed Asset Account
          </div>
          <div class="ac-dialog-form-grid-2">
            <label class="ac-form-field">
              <span class="ac-form-label">Parent Account/Type</span>
              <span class="ac-form-hint">Choose Account Type</span>
              <select [(ngModel)]="fixedAsset.parentIdAsset">
                <optgroup label="Account Types">
                  <option *ngFor="let p of getTypesOnly()" [value]="p.id">
                    {{ p.desc }}
                  </option>
                </optgroup>
                <optgroup label="Normal Accounts (can carry children)">
                  <option *ngFor="let p of getParents()" [value]="p.id">
                    {{ p.desc }} ({{ p.code || p.id }})
                  </option>
                </optgroup>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Currency Code</span>
              <span class="ac-form-hint">Currency for account</span>
              <select [(ngModel)]="fixedAsset.currency">
                <option *ngFor="let c of currencies" [value]="c">
                  {{ c }}
                </option>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">
                Account No.</span>
              <span class="ac-form-hint">
                Format must be 3 digits, a dash, and 4 chars (e.g. 311-0110)
              </span>
              <input name="faAssetAccNo" [ngModel]="fixedAsset.assetCode" (ngModelChange)="
                  fixedAsset.assetCode = normalizeAcc($event);
                  validateFaAssetAccNo(fixedAsset.assetCode)
                " [pattern]="accPattern" required #faAssetAccNo="ngModel" />
              <!-- <div class="field-errors" *ngIf="faAssetAccNo.invalid || faAssetAccNoDup">
                <small class="err" *ngIf="faAssetAccNo.errors?.['pattern']">
                  Format must be 3 digits, a dash, and 4 chars (e.g. 220-0000).
                </small>
                <small class="err" *ngIf="faAssetAccNoDup">
                  This Account No. already exists under the selected parent.
                </small>
              </div> -->
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Cash Flow Category</span>
              <span class="ac-form-hint">Classify accounts for cash flow reporting</span>
              <select [(ngModel)]="fixedAsset.cashflow">
                <option>Investing Activities</option>
                <option>Operating Activities</option>
                <option>Financing Activities</option>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Description</span>
              <span class="ac-form-hint">A description of how this account should be used</span>
              <input [(ngModel)]="fixedAsset.assetDesc" required (ngModelChange)="onFixedAssetNameChange($event)" />
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">2nd Description</span>
              <span class="ac-form-hint">A description of how this account should be used</span>
              <input [(ngModel)]="fixedAsset.assetDesc2" />
            </label>
          </div>
        </div>

        <!-- SECTION 2 -->
        <div class="section">
          <div class="section-title">
            <span class="badge">2</span> Accumulated Depreciation Account
          </div>
          <div class="ac-dialog-form-grid-2">
            <label class="ac-form-field">
              <span class="ac-form-label">Parent Account/Type</span>
              <span class="ac-form-hint">Choose Account Type</span>
              <select [(ngModel)]="fixedAsset.parentIdDepr">
                <optgroup label="Account Types">
                  <option *ngFor="let p of getTypesOnly()" [value]="p.id">
                    {{ p.desc }}
                  </option>
                </optgroup>
                <optgroup label="Normal Accounts (can carry children)">
                  <option *ngFor="let p of getParents()" [value]="p.id">
                    {{ p.desc }} ({{ p.code || p.id }})
                  </option>
                </optgroup>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Currency Code</span>
              <span class="ac-form-hint">Currency for account</span>
              <select [(ngModel)]="fixedAsset.currency">
                <option *ngFor="let c of currencies" [value]="c">
                  {{ c }}
                </option>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">
                Account No.</span>
              <span class="ac-form-hint">
                Format must be 3 digits, a dash, and 4 chars (e.g. 311-0110)
              </span>
              <input name="faDeprAccNo" [ngModel]="fixedAsset.deprCode" (ngModelChange)="
                  fixedAsset.deprCode = normalizeAcc($event);
                  validateFaDeprAccNo(fixedAsset.deprCode)
                " required [pattern]="accPattern" #faDeprAccNo="ngModel" />
              <!-- <div class="field-errors" *ngIf="faDeprAccNo.invalid || faDeprAccNoDup">
                <small class="err" *ngIf="faDeprAccNo.errors?.['pattern']">
                  Format must be 3 digits, a dash, and 4 chars (e.g. 220-1005).
                </small>
                <small class="err" *ngIf="faDeprAccNoDup">
                  This Account No. already exists under the selected parent.
                </small>
              </div> -->
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Cash Flow Category</span>
              <span class="ac-form-hint">Classify accounts for cash flow reporting</span>
              <select [(ngModel)]="fixedAsset.cashflow">
                <option>Investing Activities</option>
                <option>Operating Activities</option>
                <option>Financing Activities</option>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Description</span>
              <span class="ac-form-hint">A description of how this account should be used</span>
              <input [(ngModel)]="fixedAsset.deprDesc" required />
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">2nd Description</span>
              <span class="ac-form-hint">A description of how this account should be used</span>
              <input [(ngModel)]="fixedAsset.deprDesc2" />
            </label>
          </div>
        </div>
      </div>

      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-ghost" (click)="ui.fixedAssetOpen = false">
          Cancel
        </button>
        <button class="ac-btn ac-btn-primary" (click)="saveFixedAsset()" [disabled]="
            faAssetAccNo?.invalid ||
            faDeprAccNo?.invalid ||
            faAssetAccNoDup ||
            faDeprAccNoDup ||
            !fixedAsset.assetCode ||
            !fixedAsset.deprCode || !fixedAsset.assetDesc?.trim() || !fixedAsset.deprDesc?.trim()
          ">
          Create
        </button>
      </div>
    </div>
  </div>

  <!-- Fixed Asset Links -->
  <div class="ac-dialog-backdrop" *ngIf="ui.fixedLinksOpen">
    <div class="ac-card-no-padding ac-dialog-panel-xl">
      <div class="ac-dialog-header">
        Add New Maintain Fixed Assets Links
        <button class="ac-dialog-close" (click)="ui.fixedLinksOpen = false">Ã—</button>
      </div>

      <div class="ac-dialog-body">
        <table class="grid list">
          <thead>
            <tr>
              <th>Asset A/C No.</th>
              <th>Asset A/C Description</th>
              <th>Asset Deprn. A/C No.</th>
              <th>Asset Deprn. A/C Description</th>
              <th class="c" style="width: 50px"></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of fixedLinks">
              <td>{{ row.assetCode }}</td>
              <td>{{ row.assetDesc }}</td>
              <td>{{ row.deprCode }}</td>
              <td>{{ row.deprDesc }}</td>
              <td class="c">
                <button type="button" class="ac-btn ac-btn-icon-danger" (click)="askDeleteFixed(row)">
                  ðŸ—‘
                </button>

              </td>
            </tr>
            <tr *ngIf="!fixedLinks.length">
              <td colspan="5" class="muted">
                No links yet. Add a Fixed Asset to create a pair.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-ghost" (click)="ui.fixedLinksOpen = false">
          Cancel
        </button>
        <button class="ac-btn ac-btn-primary" (click)="addFixedFromLinks()">Add</button>
      </div>
    </div>
  </div>

  <!-- Bank / Cash / Deposit -->
  <div class="dialog" *ngIf="ui.bankCashOpen">
    <div class="dialog-panel-xl">
      <div class="ac-dialog-header">
        Add New Cash or Bank or Deposit Account
        <button class="ac-dialog-close" (click)="ui.bankCashOpen = false">Ã—</button>
      </div>

      <div class="dialog-body section-stack">
        <div class="section">
          <div class="section-title"><span class="badge">1</span> Account</div>
          <div class="ac-dialog-form-grid-3">
            <label class="ac-form-field">
              <span class="ac-form-label">Parent Account/Type</span>
              <span class="ac-form-hint">Choose Account Type</span>
              <select [(ngModel)]="bankCash.parentId">
                <optgroup label="Account Types">
                  <option *ngFor="let p of getTypesOnly()" [value]="p.id">
                    {{ p.desc }}
                  </option>
                </optgroup>
                <optgroup label="Normal Accounts (can carry children)">
                  <option *ngFor="let p of getParents()" [value]="p.id">
                    {{ p.desc }} ({{ p.code || p.id }})
                  </option>
                </optgroup>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Account Mode</span>
              <span class="ac-form-hint">Bank = bank funds, Cash = physical cash, Deposit = fixed deposits</span>
              <select [(ngModel)]="bankCash.mode">
                <option>Bank</option>
                <option>Cash</option>
                <option>Deposit</option>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Under Account Type ofâ€¦</span>
              <span class="ac-form-hint">Defines whether the account is an asset or a liability</span>
              <select [(ngModel)]="bankCash.underType" [disabled]="bankCash.underTypeLocked">
                <option>Current Assets</option>
                <option>Current Liabilities</option>
              </select>
              <small *ngIf="bankCash.underTypeLocked" class="muted">locked by parent selection</small>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Currency</span>
              <span class="ac-form-hint">Currency for account</span>
              <select [(ngModel)]="bankCash.currency">
                <option *ngFor="let c of currencies" [value]="c">
                  {{ c }}
                </option>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Account No.</span>
              <span class="ac-form-hint">Format must be 3 digits, a dash, and 4 chars (e.g. 311-0110)</span>
              <input name="bankAccNo" [ngModel]="bankCash.code" (ngModelChange)="
                  bankCash.code = normalizeAcc($event);
                  validateBankAccNo(bankCash.code)
                " required [pattern]="accPattern" #bankAccNo="ngModel" />
              <!-- <div class="field-errors" *ngIf="bankAccNo.invalid || bankAccNoDup">
                <small class="err" *ngIf="bankAccNo.errors?.['pattern']">
                  Format must be 3 digits, a dash, and 4 chars (e.g. 311-0110).
                </small>
                <small class="err" *ngIf="bankAccNoDup">
                  This Account No. already exists under the selected parent.
                </small>
              </div> -->
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Description</span>
              <span class="ac-form-hint">A description of how this account should be used</span>
              <input [ngModel]="bankCash.desc" (ngModelChange)="onBankDescInput($event)" required />
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Cash Flow Category</span>
              <span class="ac-form-hint">Classify accounts for cash flow reporting</span>
              <select [(ngModel)]="bankCash.cashflow">
                <option>Operating Activities</option>
                <option>Investing Activities</option>
                <option>Financing Activities</option>
              </select>
            </label>
          </div>
        </div>
        <div class="section">
          <div class="section-title">
            <span class="badge">2</span> Payment Method
          </div>

          <div class="toolbar">
            <button class="ac-btn ac-btn-primary" (click)="addPaymentMethod()">
              Add Payment Method
            </button>
          </div>

          <table class="grid list dense">
            <thead>
              <tr>
                <th>Payment Method</th>
                <th style="width: 150px">Journal Type</th>
                <th>Bank Charge A/C</th>
                <th class="r">Bank Charge %</th>
                <th style="width: 50px"></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let m of bankCash.methods; let i = index" (click)="selectMethod(i)"
                [class.selected]="bankCash.selectedMethodIndex === i">
                <td>
                  <input [(ngModel)]="m.name" placeholder="Unique name" />
                </td>
                <td>
                  <select [(ngModel)]="m.journalType" style="width: 120px">
                    <option>BANK</option>
                    <option>CASH</option>
                    <option>DEPOSIT</option>
                  </select>
                </td>
                <td>
                  <input [(ngModel)]="m.bankChargeAcc" placeholder="e.g. 6xx-CHARGE" />
                </td>
                <td class="r">
                  <input type="number" step="0.01" [(ngModel)]="m.bankChargeRate" />
                </td>
                <td class="c">
                  <button type="button" class="ac-btn ac-btn-icon-danger"
                    (click)="askRemoveMethod(i); $event.stopPropagation()">
                    ðŸ—‘
                  </button>
                </td>
              </tr>
              <tr *ngIf="!bankCash.methods.length">
                <td colspan="5" class="muted">
                  No payment methods. Add one above.
                </td>
              </tr>
            </tbody>
          </table>
          <br />
          <div class="section" *ngIf="selectedMethod() as s; else selectPM">
            <div class="ac-dialog-form-grid-3">
              <label class="mfield">
                <span class="ac-form-label">Payment By</span>
                <input [(ngModel)]="s.paymentBy" placeholder="e.g. CHEQUE" /></label>
              <label class="mfield">
                <span class="ac-form-label">Over Draft Limit</span>
                <input type="number" [(ngModel)]="bankCash.odLimit" /></label>
              <label class="mfield">
                <span class="ac-form-label">Payment Type</span>
                <select [(ngModel)]="s.paymentType">
                  <option>Cash</option>
                  <option>Credit Card</option>
                  <option>Multi</option>
                  <option>Other</option>
                </select>
              </label>
            </div>
            <br />
            <div class="row flags">
              <label class="inline">
                <input type="checkbox" [(ngModel)]="s.mergeBankCharge" />
                Merge Bank Charges in Bank Reconciliation Transaction
              </label>
            </div>
            <div class="row flags">
              <label class="inline">
                <input type="checkbox" [(ngModel)]="s.requireExtraInfo" />
                Need to specify additional information such as cheque number or
                credit card number
              </label>
            </div>
            <br />
            <div class="section">
              <div class="section-title">Document Numbering Format</div>
              <div class="ac-dialog-form-grid-2">
                <label class="mfield">
                  <span class="ac-form-label">Payment Document Numbering Format</span>
                  <select [(ngModel)]="s.pvFormat">
                    <option *ngFor="let o of docPvOptions" [ngValue]="o">
                      {{ o }}
                    </option>
                  </select>
                </label>
                <label class="mfield">
                  <span class="ac-form-label">Receipt Document Numbering Format</span>
                  <select [(ngModel)]="s.orFormat">
                    <option *ngFor="let o of docOrOptions" [ngValue]="o">
                      {{ o }}
                    </option>
                  </select>
                </label>
              </div>
            </div>
          </div>
          <ng-template #selectPM>
            <div class="muted" style="margin-top: 8px">
              Select a payment method row to edit details below.
            </div>
          </ng-template>
        </div>
      </div>

      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-ghost" (click)="ui.bankCashOpen = false">
          Cancel
        </button>
        <button class="ac-btn ac-btn-primary" (click)="saveBankCash()"
          [disabled]="bankAccNo?.invalid || bankAccNoDup || !bankCash.code || !bankCash.desc?.trim()">
          <!-- NEW: !bankCash.code -->
          Create
        </button>
      </div>
    </div>
  </div>
  <!-- Debtor Control -->
  <div class="ac-dialog-backdrop" *ngIf="ui.debtorCtrlOpen">
    <div class="dialog-panel ac-card-no-padding ac-dialog-panel-lg">
      <div class="ac-dialog-header">
        Add Debtor Control Account
        <button class="ac-dialog-close" (click)="ui.debtorCtrlOpen = false">Ã—</button>
      </div>

      <div class="ac-dialog-body">
        <!-- HÃ ng 1 -->
        <div class="ac-dialog-form-grid-2">
          <label class="ac-form-field">
            <span class="ac-form-label">Parent Account (&lt;&lt; CURRENT ASSETS &gt;&gt;)</span>
            <span class="ac-form-hint">Choose Account Type</span>
            <select [(ngModel)]="debtorCtrl.parentId">
              <option *ngFor="let p of getTypesOnly()" [value]="p.id">
                {{ p.desc }}
              </option>
            </select>
          </label>

          <label class="ac-form-field">
            <span class="ac-form-label">Account No.</span>
            <span class="ac-form-hint">Format must be 3 digits, a dash, and 4 chars (e.g. 311-0110)</span>
            <input name="debtorAccNo" [(ngModel)]="debtorCtrl.code" #debtorAccNo="ngModel" required
              pattern="^\d{3}-\d{4}$" (ngModelChange)="validateDebtorAccNo($event)" />
            <!-- <div class="field-errors" *ngIf="debtorAccNo.invalid || debtorAccNoDup">
              <small class="err" *ngIf="debtorAccNo.errors?.['required']">
                Account No. is required.
              </small>
              <small class="err" *ngIf="debtorAccNo.errors?.['pattern']">
                Format must be 3 digits, a dash, and 4 digits (e.g. 333-0000).
              </small>
              <small class="err" *ngIf="debtorAccNoDup">
                This Account No. already exists under the selected parent.
              </small>
            </div> -->
          </label>

          <label class="ac-form-field">
            <span class="ac-form-label">Currency Code</span>
            <span class="ac-form-hint">Currency for account</span>
            <select [(ngModel)]="debtorCtrl.currency">
              <option *ngFor="let c of currencies" [value]="c">{{ c }}</option>
            </select>
          </label>

          <label class="ac-form-field">
            <span class="ac-form-label">Cash Flow Category</span>
            <span class="ac-form-hint">Classify accounts for cash flow reporting</span>
            <select [(ngModel)]="debtorCtrl.cashflow">
              <option>Operating Activities</option>
              <option>Investing Activities</option>
              <option>Financing Activities</option>
            </select>
          </label>

          <label class="ac-form-field">
            <span class="ac-form-label">Description</span>
            <span class="ac-form-hint">A description of how this account should be used</span>
            <input [(ngModel)]="debtorCtrl.desc" required placeholder="" />
          </label>

          <label class="ac-form-field">
            <span class="ac-form-label">2nd Description</span>
            <span class="ac-form-hint">A description of how this account should be used</span>
            <input [(ngModel)]="debtorCtrl.desc2" />
          </label>
        </div>
      </div>
      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-ghost" (click)="ui.debtorCtrlOpen = false">
          Cancel
        </button>
        <button class="ac-btn ac-btn-primary" (click)="saveDebtorCtrl()" [disabled]="
            !debtorCtrl.code || debtorAccNo?.invalid || debtorAccNoDup || !debtorCtrl.desc?.trim()
          ">
          Create
        </button>
      </div>

    </div>
  </div>

  <!-- Creditor Control -->
  <div class="ac-dialog-backdrop" *ngIf="ui.creditorCtrlOpen">
    <div class="dialog-panel ac-card-no-padding ac-dialog-panel-lg">
      <div class="ac-dialog-header">
        Add Creditor Control Account
        <button class="ac-dialog-close" (click)="ui.creditorCtrlOpen = false">Ã—</button>
      </div>

      <div class="ac-dialog-body">
        <!-- HÃ ng 1 -->
        <div class="ac-dialog-form-grid-2">
          <label class="ac-form-field">
            <span class="ac-form-label">
              Parent Account (&lt;&lt; CURRENT LIABILITIES &gt;&gt;)</span>
            <span class="ac-form-hint">Choose Account Type</span>
            <select [(ngModel)]="creditorCtrl.parentId">
              <option *ngFor="let p of getTypesOnly()" [value]="p.id">
                {{ p.desc }}
              </option>
            </select>
          </label>

          <label class="ac-form-field">
            <span class="ac-form-label">
              Account No.</span>
            <span class="ac-form-hint">Format must be 3 digits, a dash, and 4 chars (e.g. 311-0110)</span>
            <input name="creditorAccNo" [(ngModel)]="creditorCtrl.code" #creditorAccNo="ngModel" required
              pattern="^\d{3}-\d{4}$" (ngModelChange)="validateCreditorAccNo($event)" />
            <!-- <div class="field-errors" *ngIf="creditorAccNo.invalid || creditorAccNoDup">
              <small class="err" *ngIf="creditorAccNo.errors?.['required']">
                Account No. is required.
              </small>
              <small class="err" *ngIf="creditorAccNo.errors?.['pattern']">
                Format must be 3 digits, a dash, and 4 digits (e.g. 440-0000).
              </small>
              <small class="err" *ngIf="creditorAccNoDup">
                This Account No. already exists under the selected parent.
              </small>
            </div> -->
          </label>

          <label class="ac-form-field">
            <span class="ac-form-label">
              Currency Code</span>
            <span class="ac-form-hint">Currency for account</span>
            <select [(ngModel)]="creditorCtrl.currency">
              <option *ngFor="let c of currencies" [value]="c">{{ c }}</option>
            </select>
          </label>


          <!-- HÃ ng 2 -->

          <label class="ac-form-field">
            <span class="ac-form-label">
              Cash Flow Category</span>
            <span class="ac-form-hint">Classify accounts for cash flow reporting</span>
            <select [(ngModel)]="creditorCtrl.cashflow">
              <option>Operating Activities</option>
              <option>Investing Activities</option>
              <option>Financing Activities</option>
            </select>
          </label>

          <label class="ac-form-field">
            <span class="ac-form-label">
              Description</span>
            <span class="ac-form-hint">A description of how this account should be used</span>
            <input [(ngModel)]="creditorCtrl.desc" required placeholder="" />
          </label>

          <label class="ac-form-field">
            <span class="ac-form-label">
              2nd Description</span>
            <span class="ac-form-hint">A description of how this account should be used</span>
            <input [(ngModel)]="creditorCtrl.desc2" />
          </label>
        </div>
      </div>

      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-ghost" (click)="ui.creditorCtrlOpen = false">
          Cancel
        </button>
        <button class="ac-btn ac-btn-primary" (click)="saveCreditorCtrl()" [disabled]="
            !creditorCtrl.code || creditorAccNo?.invalid || creditorAccNoDup || !creditorCtrl.desc?.trim()
          ">
          Create
        </button>
      </div>
    </div>
  </div>

  <!-- Stock accounts -->
  <div class="ac-dialog-backdrop" *ngIf="ui.stockOpen">
    <div class="ddialog-panel ac-card-no-padding ac-dialog-panel-lg">
      <div class="ac-dialog-header">
        Add New Stock Accounts
        <button class="ac-dialog-close" (click)="ui.stockOpen = false">Ã—</button>
      </div>

      <div class="dialog-body section-stack">
        <!-- 1. Open Stock Account -->
        <div class="section">
          <div class="section-title">
            <span class="badge">1</span> Open Stock Account
          </div>
          <div class="ac-dialog-form-grid-2">
            <label class="ac-form-field">
              <span class="ac-form-label">Parent Account</span>
              <span class="ac-form-hint">Choose Account Type</span>
              <select [(ngModel)]="stock.open.parentId">
                <optgroup label="Account Types">
                  <option *ngFor="let p of getTypesOnly()" [value]="p.id">
                    {{ p.desc }}
                  </option>
                </optgroup>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Currency Code</span>
              <span class="ac-form-hint">Currency for account</span>
              <select [(ngModel)]="stock.open.currency">
                <option *ngFor="let c of currencies" [value]="c">
                  {{ c }}
                </option>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Cash Flow Category</span>
              <span class="ac-form-hint">Classify accounts for cash flow reporting</span>
              <select [(ngModel)]="stock.open.cashflow">
                <option>Operating Activities</option>
                <option>Investing Activities</option>
                <option>Financing Activities</option>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Account No.</span>
              <span class="ac-form-hint">Format must be 3 digits, a dash, and 4 chars (e.g. 311-0110)</span>
              <input [ngModel]="stock.open.code" (ngModelChange)="stock.open.code = normalizeAcc($event)"
                placeholder="" />
            </label>
            <!-- <div class="form-error" *ngIf="accError(stock.open.code) as e">
              {{ e }}
            </div> -->

            <label class="ac-form-field">
              <span class="ac-form-label">Description</span>
              <span class="ac-form-hint">A description of how this account should be used</span>
              <input [(ngModel)]="stock.open.desc" placeholder="" required />
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">2nd Description</span>
              <span class="ac-form-hint">A description of how this account should be used</span>
              <input [(ngModel)]="stock.open.desc2" />
            </label>
          </div>
        </div>

        <!-- 2. Close Stock Account -->
        <div class="section">
          <div class="section-title">
            <span class="badge">2</span> Close Stock Account
          </div>
          <div class="ac-dialog-form-grid-2">
            <label class="ac-form-field">
              <span class="ac-form-label">Parent Account</span>
              <span class="ac-form-hint">Choose Account Type</span>
              <select [(ngModel)]="stock.close.parentId">
                <optgroup label="Account Types">
                  <option *ngFor="let p of getTypesOnly()" [value]="p.id">
                    {{ p.desc }}
                  </option>
                </optgroup>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Currency Code</span>
              <span class="ac-form-hint">ACurrency for account</span>
              <select [(ngModel)]="stock.close.currency">
                <option *ngFor="let c of currencies" [value]="c">
                  {{ c }}
                </option>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Cash Flow Category</span>
              <span class="ac-form-hint">Classify accounts for cash flow reporting</span>
              <select [(ngModel)]="stock.close.cashflow">
                <option>Operating Activities</option>
                <option>Investing Activities</option>
                <option>Financing Activities</option>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Account No.</span>
              <span class="ac-form-hint">Format must be 3 digits, a dash, and 4 chars (e.g. 311-0110)</span>
              <input [ngModel]="stock.close.code" (ngModelChange)="stock.close.code = normalizeAcc($event)" />
            </label>
            <!-- <div class="form-error" *ngIf="accError(stock.close.code) as e">
              {{ e }}
            </div> -->

            <label class="ac-form-field">
              <span class="ac-form-label">Description</span>
              <span class="ac-form-hint">A description of how this account should be used</span>
              <input [(ngModel)]="stock.close.desc" required />
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">2nd Description</span>
              <span class="ac-form-hint">A description of how this account should be used</span>
              <input [(ngModel)]="stock.close.desc2" />
            </label>
          </div>
        </div>

        <!-- 3. Balance Stock Account -->
        <div class="section">
          <div class="section-title">
            <span class="badge">3</span> Balance Stock Account
          </div>
          <div class="ac-dialog-form-grid-2">
            <label class="ac-form-field">
              <span class="ac-form-label">Parent Account</span>
              <span class="ac-form-hint">Choose Account Type</span>
              <select [(ngModel)]="stock.balance.parentId">
                <optgroup label="Account Types">
                  <option *ngFor="let p of getTypesOnly()" [value]="p.id">
                    {{ p.desc }}
                  </option>
                </optgroup>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Currency Code</span>
              <span class="ac-form-hint">Currency for account</span>
              <select [(ngModel)]="stock.balance.currency">
                <option *ngFor="let c of currencies" [value]="c">
                  {{ c }}
                </option>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Cash Flow Category</span>
              <span class="ac-form-hint">Classify accounts for cash flow reporting</span>
              <select [(ngModel)]="stock.balance.cashflow">
                <option>Operating Activities</option>
                <option>Investing Activities</option>
                <option>Financing Activities</option>
              </select>
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">Account No.</span>
              <span class="ac-form-hint">Format must be 3 digits, a dash, and 4 chars (e.g. 311-0110)</span>
              <input [ngModel]="stock.balance.code" (ngModelChange)="stock.balance.code = normalizeAcc($event)"
                placeholder="" />
            </label>
            <!-- <div class="form-error" *ngIf="accError(stock.balance.code) as e">
              {{ e }}
            </div> -->

            <label class="ac-form-field">
              <span class="ac-form-label">Description</span>
              <span class="ac-form-hint">A description of how this account should be used</span>
              <input [(ngModel)]="stock.balance.desc" required />
            </label>

            <label class="ac-form-field">
              <span class="ac-form-label">2nd Description</span>
              <span class="ac-form-hint">A description of how this account should be used</span>
              <input [(ngModel)]="stock.balance.desc2" />
            </label>
          </div>
        </div>
      </div>

      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-ghost" (click)="ui.stockOpen = false">
          Cancel
        </button>
        <button class="ac-btn ac-btn-primary" (click)="saveStock()" [disabled]="
            accError(stock.open.code) ||
            accError(stock.close.code) ||
            accError(stock.balance.code)
            || !stock.open.desc?.trim() || !stock.close.desc?.trim() || !stock.balance.desc?.trim()">
          Create
        </button>
      </div>
    </div>
  </div>
  <!-- Retained Earning -->
  <div class="ac-dialog-backdrop" *ngIf="ui.retainedOpen">
    <div class="dialog-panel ac-card-no-padding ac-dialog-panel-lg">
      <div class="ac-dialog-header">
        Add New Retained Earning Account
        <button class="ac-dialog-close" (click)="ui.retainedOpen = false">Ã—</button>
      </div>

      <div class="ac-dialog-body">
        <div class="ac-dialog-form-grid-2">
          <!-- Parent Account -->
          <label class="ac-form-field">
            <span class="ac-form-label">
              Parent Account (&lt;&lt; RETAINED EARNING &gt;&gt;)</span>
            <span class="ac-form-hint">A description of how this account should be used</span>
            <select [(ngModel)]="retained.parentId">
              <option *ngFor="let p of getTypesOnly()" [value]="p.id">
                {{ p.desc }}
              </option>
            </select>
          </label>

          <!-- Account No. + validate -->
          <label class="ac-form-field">
            <span class="ac-form-label">
              Account No.</span>
            <span class="ac-form-hint">Format must be 3 digits, a dash, and 4 chars (e.g. 311-0110)</span>
            <input name="retainedAccNo" [ngModel]="retained.code" (ngModelChange)="
                retained.code = normalizeAcc($event);
                validateRetainedAccNo(retained.code)
              " required [pattern]="accPattern" #retainedAccNo="ngModel" />
            <!-- <div class="field-errors" *ngIf="retainedAccNo.invalid || retainedAccNoDup">
              <small class="err" *ngIf="retainedAccNo.errors?.['pattern']">
                Format must be 3 digits, a dash, and 4 digits (e.g. 150-0000).
              </small>
              <small class="err" *ngIf="retainedAccNoDup">
                This Account No. already exists under the selected parent.
              </small>
            </div> -->
          </label>

          <!-- Currency Code -->
          <label class="ac-form-field">
            <span class="ac-form-label">
              Currency Code</span>
            <span class="ac-form-hint">Currency for account</span>
            <select [(ngModel)]="retained.currency">
              <option *ngFor="let c of currencies" [value]="c">{{ c }}</option>
            </select>
          </label>

          <!-- Cash Flow Category -->
          <label class="ac-form-field">
            <span class="ac-form-label">
              Cash Flow Category</span>
            <span class="ac-form-hint">Classify accounts for cash flow reporting</span>
            <select [(ngModel)]="retained.cashflow">
              <option>Operating Activities</option>
              <option>Investing Activities</option>
              <option>Financing Activities</option>
            </select>
          </label>

          <!-- Description -->
          <label class="ac-form-field">
            <span class="ac-form-label">
              Description</span>
            <span class="ac-form-hint">A description of how this account should be used</span>
            <input [(ngModel)]="retained.desc" required placeholder="" />
          </label>

          <!-- 2nd Description -->
          <label class="ac-form-field">
            <span class="ac-form-label">
              2nd Description</span>
            <span class="ac-form-hint">A description of how this account should be used</span>
            <input [(ngModel)]="retained.desc2" />
          </label>
        </div>
      </div>

      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-ghost" (click)="ui.retainedOpen = false">
          Cancel
        </button>
        <button class="ac-btn ac-btn-primary" (click)="saveRetained()" [disabled]="
            !retained.code || retainedAccNo?.invalid || retainedAccNoDup || !retained.desc?.trim()
          ">
          Create
        </button>
      </div>
    </div>
  </div>

  <!-- Edit -->
  <div class="ac-dialog-backdrop" *ngIf="ui.editOpen">
    <div class="dialog-panel ac-card-no-padding ac-dialog-panel-lg">
      <div class="ac-dialog-header">
        Edit Account
        <button class="ac-dialog-close" (click)="ui.editOpen = false">âœ•</button>
      </div>
      <div class="ac-dialog-body">
        <div class="ac-dialog-form-grid-2">
          <label class="ac-form-field">
            <span class="ac-form-label">Parent Account/Type</span>
            <select [(ngModel)]="edit.parentId" [disabled]="editLockParent" [title]="editLockReason">
              <optgroup label="Account Types">
                <option *ngFor="let p of getTypesOnly()" [value]="p.id">
                  {{ p.desc }}
                </option>
              </optgroup>
              <optgroup label="Normal Accounts (can carry children)">
                <option *ngFor="let p of getParents()" [value]="p.id">
                  {{ p.desc }} ({{ p.code || p.id }})
                </option>
              </optgroup>
            </select>
          </label>
          <label class="ac-form-field">
            <span class="ac-form-label">Account No.</span> <input [disabled]="true" [(ngModel)]="edit.code" /></label>
          <label class="ac-form-field">
            <span class="ac-form-label">Description</span> <input [(ngModel)]="edit.desc" required /></label>
          <label class="ac-form-field">
            <span class="ac-form-label">Currency</span>
            <select [(ngModel)]="edit.currency" [disabled]="true">
              <option *ngFor="let c of currencies" [value]="c">{{ c }}</option>
            </select>
          </label>
        </div>
      </div>
      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-ghost" (click)="ui.editOpen = false">Cancel</button>
        <button class="ac-btn ac-btn-primary" [disabled]="!edit.desc?.trim()" (click)="saveEdit()">Save</button>
      </div>
    </div>
  </div>

  <!-- Confirm Delete -->
  <div class="ac-dialog-backdrop" *ngIf="ui.confirmDeleteOpen">
    <div class="ac-card-no-padding ac-dialog-panel-sm" role="dialog" aria-modal="true">
      <div class="ac-dialog-header">
        Delete Account
        <button class="ac-dialog-close" (click)="closeConfirm()" aria-label="Close">Ã—</button>
      </div>
      <div class="ac-dialog-body">
        <p>
          Are you sure you want to delete <b>{{ confirmNode?.desc }}</b>
          <span *ngIf="confirmNode?.code">({{ confirmNode?.code }})</span> ?
        </p>
        <div *ngIf="!confirmCanDelete" class="warn" style="margin-top: 8px">
          {{ confirmReason }}
        </div>
      </div>
      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-ghost" (click)="closeConfirm()">Cancel</button>
        <button class="ac-btn ac-btn-danger" [disabled]="!confirmCanDelete" (click)="confirmDelete()">
          Delete
        </button>
      </div>
    </div>
  </div>

  <!-- Confirm Delete Fixed Link -->
  <div class="ac-dialog-backdrop" *ngIf="ui.confirmFixedLinkOpen">
    <div class="ac-card-no-padding ac-dialog-panel-sm" role="dialog" aria-modal="true">
      <div class="ac-dialog-header">Confirm delete
        <button class="ac-dialog-close" (click)="closeConfirmFixed()" aria-label="Close">Ã—</button>
      </div>
      <div class="ac-dialog-body">
        <p>Are you sure you want to delete this fixed asset link?</p>
        <div class="muted" *ngIf="pendingFixedLink">
          <div>
            <strong>Asset:</strong> {{ pendingFixedLink.assetCode }}
            {{ pendingFixedLink.assetDesc }}
          </div>
          <div>
            <strong>Depr:</strong> {{ pendingFixedLink.deprCode }}
            {{ pendingFixedLink.deprDesc }}
          </div>
        </div>
      </div>
      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-ghost" (click)="closeConfirmFixed()">Cancel</button>
        <button class="ac-btn ac-btn-danger" (click)="confirmDeleteFixed()">
          Delete
        </button>
      </div>
    </div>
  </div>
  <!-- Confirm Remove Payment Method -->
  <div class="ac-dialog-backdrop" *ngIf="ui.confirmBulkDeleteOpen">
    <div class="ac-card-no-padding ac-dialog-panel-sm">
      <div class="ac-dialog-header">Confirm delete
        <button class="ac-dialog-close" (click)="cancelBulkDelete()" aria-label="Close">Ã—</button>
      </div>

      <div class="ac-dialog-body">
        <p>Are you sure you want to delete <strong>{{ bulkDeleteNodes.length }}</strong> account(s)?</p>
        <ul class="bulkul">
          <li *ngFor="let n of bulkDeleteNodes">{{ n.code }} â€” {{ n.desc }}</li>
        </ul>

      </div>

      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-ghost" (click)="cancelBulkDelete()">Cancel</button>
        <button class="ac-btn ac-btn-danger" (click)="confirmBulkDelete()">Delete</button>
      </div>
    </div>
  </div>
  <div class="ac-dialog-backdrop" *ngIf="ui.confirmRemoveMethodOpen">
    <div class="ac-card-no-padding ac-dialog-panel-sm">
      <div class="ac-dialog-header">Confirm delete
        <button class="ac-dialog-close" (click)="closeConfirmRemoveMethod()" aria-label="Close">Ã—</button>
      </div>

      <div class="ac-dialog-body">
        <p>Are you sure you want to remove this payment method?</p>

        <ng-container *ngIf="pendingMethodIndex !== null">
          <div class="muted">
            <div>
              <strong>Name:</strong>
              {{ bankCash.methods[pendingMethodIndex]?.name || '(unnamed)' }}
            </div>
            <div>
              <strong>Journal Type:</strong>
              {{ bankCash.methods[pendingMethodIndex]?.journalType }}
            </div>
            <div>
              <strong>PV Format:</strong>
              {{ bankCash.methods[pendingMethodIndex]?.pvFormat }}
            </div>
            <div>
              <strong>OR Format:</strong>
              {{ bankCash.methods[pendingMethodIndex]?.orFormat }}
            </div>
          </div>
        </ng-container>
      </div>

      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-ghost" (click)="closeConfirmRemoveMethod()">Cancel</button>
        <button class="ac-btn ac-btn-danger" (click)="confirmRemoveMethod()">Remove</button>
      </div>
    </div>
  </div>
  <div class="ac-dialog-backdrop" *ngIf="showSuccess">
    <div class="ac-card-no-padding ac-dialog-panel-sm ac-dialog-success" role="dialog" aria-modal="true">
      <div class="ac-dialog-header ac-dialog-success-header">
        <span>Success</span>
        <button class="ac-dialog-close" (click)="closeSuccess()" aria-label="Close">
          Ã—
        </button>
      </div>
      <div class="ac-dialog-body">
        <p class="ac-dialog-success-text">
          {{ successMsg }}
        </p>
      </div>
      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-primary" type="button" (click)="closeSuccess()">
          OK
        </button>
      </div>
    </div>
  </div>
</div>