<!-- Cash Book Entry - Listing -->
<div class="ac-page">
  <ng-container *ngIf="!choiceOpen && !voucherOpen">
    <div class="ac-card">
      <div class="ac-page-header">
        <div>
          <div class="ac-page-title">Cash Book Entry</div>
          <div class="ac-page-subtitle">
            Record cash transaction entries.
          </div>
        </div>
        <div class="ac-page-toolbar">
          <select class="filter" style="width: 120px;" [(ngModel)]="typeFilter">
            <option>All</option>
            <option>Receipt</option>
            <option>Payment</option>
          </select>
          <input class="ac-form-control" style="width: 200px;" [(ngModel)]="q" placeholder="Search type / doc no ..." />
          <button class="ac-btn ac-btn-primary" (click)="openVoucher('Receipt')">
            New Receipt Voucher
          </button>
          <button class="ac-btn ac-btn-primary" (click)="openVoucher('Payment')">
            New Payment Voucher
          </button>
          <button class="ac-btn" [disabled]="!selected" (click)="openEdit(selected!)">
            <span class="ico edit"></span>Edit
          </button>
          <button class="ac-btn ac-btn-danger" [disabled]="!selected" (click)="askDelete()">
            <span class="ico trash"></span>Delete
          </button>
        </div>
      </div>

      <div class="list-shell">
        <div class="ac-card-inv ac-card-no-padding">
          <div class="ac-tablewrap">
            <table class="ac-table">
              <thead>
                <tr>
                  <th class="l" style="width: 140px">Doc No.</th>
                  <th class="l" style="width: 120px">Doc Date</th>
                  <th class="l" style="width: 100px">Type</th>
                  <th class="l">Payer / Payee</th>
                  <th class="l">Description</th>
                  <th class="r" style="width: 140px">Net Total</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let r of filtered(); trackBy: trackById" (click)="pick(r)" [class.selected]="r === selected"
                  [class.active]="isPicked(r)">
                  <td class="l">{{ r.docNo }}</td>
                  <td class="l">{{ r.docDate }}</td>
                  <td>
                    {{
                    r.type }}
                  </td>
                  <td class="l">{{ r.payerPayee }}</td>
                  <td class="cut l">{{ r.description }}</td>
                  <td class="r">
                    {{ r.localAmount | number : "1.2-2" }}
                  </td>
                </tr>
              </tbody>
              <!-- <tfoot>
                <tr>
                  <td colspan="5" class="text-end"><b>Total</b></td>
                  <td class="blue">
                    <b>{{ totalLocal() | number : "1.2-2" }}</b>
                  </td>
                </tr>
              </tfoot> -->
            </table>
          </div>
        </div>
        <div class="account-type-footer-inv">
          <div class="account-type-rec">
            Total Records: 3
          </div>

          <div class="account-type-pager">
            <button class="ac-btn ac-btn-ghost account-type-pg-btn" [disabled]="page === 1" (click)="page = 1">
              &laquo;
            </button>
            <button class="ac-btn ac-btn-ghost account-type-pg-btn" [disabled]="page === 1" (click)="page = page - 1">
              &lsaquo;
            </button>

            <span class="account-type-pg-label">
              Page {{ page }} / {{ 1 }}
            </span>

            <button class="ac-btn ac-btn-ghost account-type-pg-btn" [disabled]="page === 1" (click)="page = page + 1">
              &rsaquo;
            </button>
            <button class="ac-btn ac-btn-ghost account-type-pg-btn" [disabled]="page === 1" (click)="page = 1">
              &raquo;
            </button>
          </div>
        </div>
      </div>
    </div>
  </ng-container>
  <ng-container *ngIf="choiceOpen || voucherOpen">
    <div class="inv-form">
      <div class="inv-header">
        <div class="inv-title">
          {{ voucher.type === "Receipt" ? (!isEditMode ? "New Receipt Voucher" : "Edit Receipt Voucher") : (!isEditMode
          ? "New Payment Voucher" : "Edit Payment Voucher") }}
          <ng-container *ngIf="isEditMode && voucher.docNo"> â€” {{ voucher.docNo }}</ng-container>
        </div>
        <div class="inv-subtitle">
          {{ voucher.type === "Receipt" ? "Record all cash receipts (sales, debt collection, other receipts...)." :
          "Record all cash disbursements (purchases, expenses, debt repayments...)." }}
        </div>
      </div>

      <div class="inv-body">
        <div class="inv-body-inner">
          <div class="inv-header-grid">
            <label class="inv-field">
              <span class="inv-label">{{ voucher.type === "Receipt" ? "Receive From" : "Pay To" }}</span>
              <div class="inv-contact-input ac-input-prefix-group">
                <span class="ac-input-prefix-icon">
                  <lucide-icon name="user" [size]="15" color="#111827"></lucide-icon>
                </span>
                <input class="ac-form-control" [(ngModel)]="voucher.payerPayee" placeholder="Name / Company"
                  [class.invalid]="errors.payerPayee" [attr.aria-invalid]="!!errors.payerPayee" required />
                <div class="field-errors" *ngIf="errors.payerPayee">
                  <span class="req">{{ voucher.type === "Receipt" ? "Receive From" : "Pay To" }} is required</span>
                </div>
              </div>
            </label>
            <label class="inv-field">
              <span class="inv-label">Voucher No.</span>
              <div class="inv-contact-input ac-input-prefix-group">
                <span class="ac-input-prefix-icon">
                  <lucide-icon name="hash" [size]="13" color="#111827"></lucide-icon>
                </span>

                <input class="ac-form-control" [(ngModel)]="voucher.docNo" />
              </div>
            </label>
            <label class="inv-field">
              <span class="inv-label">2nd Voucher No.</span>
              <div class="inv-contact-input ac-input-prefix-group">
                <span class="ac-input-prefix-icon">
                  <lucide-icon name="hash" [size]="13" color="#111827"></lucide-icon>
                </span>

                <input class="ac-form-control" [(ngModel)]="voucher.secondDocNo" />
              </div>
            </label>
            <label class="inv-field">
              <span class="inv-label">Date</span>
              <div class="inv-contact-input ac-input-prefix-group">
                <span class="ac-input-prefix-icon">
                  <lucide-icon name="calendar" [size]="15" color="#111827"></lucide-icon>
                </span>

                <input type="date" class="ac-form-control" [(ngModel)]="voucher.docDate" />
              </div>
            </label>
            <!-- <label>Cash/Bank Account</label>
        <select class="inp" [(ngModel)]="voucher.cashBook">
          <option *ngFor="let c of cashBooks" [value]="c">{{ c }}</option>
        </select>

        <label>Currency</label>
        <select class="inp" [(ngModel)]="voucher.currency" (change)="onCurChange()">
          <option value="MYR">MYR</option>
          <option value="USD">USD</option>
        </select>

        <label>Rate</label>
        <input class="inp" type="number" step="0.0001" [(ngModel)]="voucher.rate" (input)="recalcTotals()" />

        <label>Remark</label>
        <input class="inp" [(ngModel)]="voucher.remark" placeholder="Optional" /> -->
          </div>
          <div>
            <!-- Payment Methods -->
            <div class="inv-lines-tablewrap">
              <table class="ac-table-addnew inv-lines-table">
                <thead>
                  <tr>
                    <th class="l" style="width: 160px">Payment Method</th>
                    <th class="l" style="width: 150px">Cheque No.</th>
                    <th class="text-end" style="width: 140px">Payment Amount</th>
                    <th class="text-end" style="width: 120px">Bank Charge</th>
                    <th class="l" style="width: 170px">Payment By</th>
                    <th style="width: 90px">Is RCHQ</th>
                    <th class="l" style="width: 160px">RCHQ Date</th>
                    <th style="width: 40px"></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let m of voucher.methods; let i = index">
                    <td>
                      <select class="inp" [(ngModel)]="m.method" (ngModelChange)="onPaymentMethodChange(i)">
                        <option *ngFor="let p of paymentMethods" [value]="p">
                          {{ p }}
                        </option>
                      </select>
                    </td>
                    <td><input class="inp" [(ngModel)]="m.chequeNo" /></td>
                    <td>
                      <input class="inp text-end" type="number" step="0.01" [(ngModel)]="m.amount"
                        (input)="recalcTotals()" appAmount />
                    </td>
                    <td>
                      <input class="inp text-end" type="number" step="0.01" [(ngModel)]="m.bankCharge"
                        (input)="recalcTotals()" appAmount />
                    </td>
                    <td>
                      <input class="inp" [(ngModel)]="m.paymentBy" readonly />
                    </td>
                    <td class="text-center">
                      <input type="checkbox" [(ngModel)]="m.isRchq" [disabled]="!isEditMode"
                        (ngModelChange)="onRchqChanged(i)" />
                    </td>
                    <td>
                      <input class="inp" type="date" [(ngModel)]="m.rchqDate" [disabled]="!isEditMode || !m.isRchq" />
                    </td>
                    <td class="text-center">
                      <button type="button" class="ac-btn ac-btn-icon-danger" (click)="askRemoveMethod(i)">
                        ðŸ—‘
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="inv-lines-bottom">
              <div class="inv-addrow-wrapper">
                <div class="inv-addrow-split" [class.open]="showAddMethodMenu">
                  <!-- nÃºt chÃ­nh: thÃªm 1 dÃ²ng -->
                  <button type="button" class="ac-btn ac-btn-primary inv-addrow-main" (click)="addMethods(1)">
                    Add Method
                  </button>

                  <!-- nÃºt caret má»Ÿ menu -->
                  <button type="button" class="ac-btn ac-btn-primary inv-addrow-caret" (click)="toggleAddMethodMenu()">
                    â–¾
                  </button>

                  <!-- menu chá»n sá»‘ dÃ²ng -->
                  <div class="inv-addrow-menu" *ngIf="showAddMethodMenu">
                    <button type="button" class="inv-addrow-menu-item" (click)="addMethods(5); closeAddMethodMenu()">
                      Add 5 rows
                    </button>
                    <button type="button" class="inv-addrow-menu-item" (click)="addMethods(10); closeAddMethodMenu()">
                      Add 10 rows
                    </button>
                    <button type="button" class="inv-addrow-menu-item" (click)="addMethods(20); closeAddMethodMenu()">
                      Add 20 rows
                    </button>
                  </div>
                </div>
              </div>
              <div class="inv-totals">
                <div class="row total">
                  <div class="label">Total Payment:</div>
                  <div class="value">
                    {{ voucherTotal() | number : "1.2-2" }}
                  </div>
                </div>
              </div>
            </div>
          </div>
          <br>
          <div>
            <!-- G/L Details -->
            <div class="inv-lines-tablewrap">
              <table class="ac-table-addnew inv-lines-table">
                <thead>
                  <tr>
                    <th class="l" style="width: 140px">Acc. No.</th>
                    <th class="l">Account Desc.</th>
                    <th class="l">Description</th>
                    <th class="r" style="width: 140px">Amount</th>
                    <th style="width: 40px"></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let d of voucher.details; let i = index">
                    <td class="l">
                      <input class="inp monospace" [(ngModel)]="d.accNo" (blur)="fillAccDesc(d)"
                        placeholder="e.g. 561-1000" />
                    </td>
                    <td class="l">
                      <input class="inp" [(ngModel)]="d.accDesc" placeholder="Auto when Acc. No selected" />
                    </td>
                    <td class="l"><input class="inp" [(ngModel)]="d.description" /></td>
                    <td class="r">
                      <input class="inp text-end" type="number" step="0.01" [(ngModel)]="d.amount"
                        (input)="recalcTotals()" appAmount />
                    </td>
                    <td class="text-center">
                      <button type="button" class="ac-btn ac-btn-icon-danger" (click)="askRemoveDetail(i)">
                        ðŸ—‘
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="inv-lines-bottom">
              <div class="inv-addrow-wrapper">
                <div class="inv-addrow-split" [class.open]="showAddRowMenu">
                  <!-- nÃºt chÃ­nh: thÃªm 1 dÃ²ng -->
                  <button type="button" class="ac-btn ac-btn-primary inv-addrow-main" (click)="addRows(1)">
                    Add row
                  </button>

                  <!-- nÃºt caret má»Ÿ menu -->
                  <button type="button" class="ac-btn ac-btn-primary inv-addrow-caret" (click)="toggleAddRowMenu()">
                    â–¾
                  </button>

                  <!-- menu chá»n sá»‘ dÃ²ng -->
                  <div class="inv-addrow-menu" *ngIf="showAddRowMenu">
                    <button type="button" class="inv-addrow-menu-item" (click)="addRows(5); closeAddRowMenu()">
                      Add 5 rows
                    </button>
                    <button type="button" class="inv-addrow-menu-item" (click)="addRows(10); closeAddRowMenu()">
                      Add 10 rows
                    </button>
                    <button type="button" class="inv-addrow-menu-item" (click)="addRows(20); closeAddRowMenu()">
                      Add 20 rows
                    </button>
                  </div>
                </div>
              </div>
              <div class="inv-totals">
                <div class="row total">
                  <div class="label">Net Total:</div>
                  <div class="value">
                    {{ detailsTotal() | number : "1.2-2" }}
                  </div>
                </div>
              </div>
            </div>
            <div style="font-size:smaller;color: dimgray;">* Note: Total Payment must equal Net Total.
            </div>
            <br>
            <label class="chk"><input type="checkbox" [(ngModel)]="voucher.postDetailToGL" /> Post
              Detail Description to G/L</label>
          </div>
          <!-- <div class="sumline">
        <div><b>Total Payment</b>: {{ voucherTotal() | number:'1.2-2' }}</div>
        <div><b>Rate</b>: {{ voucher.rate | number:'1.2-4' }}</div>
        <div><b>Local Amount</b>: {{ localTotal() | number:'1.2-2' }}</div>
      </div> -->
        </div>
      </div>
      <div class="inv-footer">
        <label class="chk" *ngIf="!isEditMode">
          <input type="checkbox" [(ngModel)]="voucher.continueNew" />
          <span>After save, proceed with new voucher entry</span>
        </label>
        <button class="ac-btn ac-btn-ghost" (click)="closeVoucher()">Cancel</button>
        <button class="ac-btn ac-btn-primary" [disabled]="!canSaveVoucher()" (click)="confirmSave()">
          {{
          !isEditMode
          ? 'Create'
          : 'Save'
          }}
        </button>
      </div>
    </div>
  </ng-container>
  <!-- Confirm delete (list) -->
  <div class="ac-dialog-backdrop" *ngIf="confirmListOpen">
    <div class="ac-card-no-padding ac-dialog-panel-sm">
      <div class="ac-dialog-header">
        Confirm delete
        <button class="ac-dialog-close" (click)="confirmListOpen = false" aria-label="Close">
          x
        </button>
      </div>
      <div class="ac-dialog-body">
        Are you sure you want to delete <b>{{ selected?.docNo }}</b>?
      </div>
      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-ghost" (click)="confirmListOpen = false">
          Cancel
        </button>
        <button class="ac-btn ac-btn-danger" (click)="doDelete()">Delete</button>
      </div>
    </div>
  </div>
  <div class="ac-dialog-backdrop" *ngIf="confirmListAddnewOpen">
    <div class="ac-card-no-padding ac-dialog-panel-sm">
      <div class="ac-dialog-header">
        Confirm Save
        <button class="ac-dialog-close" (click)="confirmListOpen = false" aria-label="Close">
          x
        </button>
      </div>
      <div class="ac-dialog-body">
        {{
        !isEditMode
        ? 'Are you sure you want to create this Cash Book Entry'
        : 'Are you sure you want to update this Cash Book Entry'
        }}
      </div>
      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-ghost" (click)="confirmListAddnewOpen = false">
          Cancel
        </button>
        <button class="ac-btn ac-btn-danger" (click)="saveVoucher()">Save</button>
      </div>
    </div>
  </div>
  <!-- Confirm delete (method/detail) -->
  <div class="ac-dialog-backdrop" *ngIf="confirmRowOpen">
    <div class="ac-card-no-padding ac-dialog-panel-sm">
      <div class="ac-dialog-header">
        Confirm delete
        <button class="ac-dialog-close" (click)="confirmRowOpen = false" aria-label="Close">
          x
        </button>
      </div>
      <div class="ac-dialog-body">
        <p>
          {{
          confirmRowCtx?.kind === "method"
          ? "Remove payment method?"
          : "Remove G/L row?"
          }}
          This action cannot be undone.
        </p>
      </div>
      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-ghost" (click)="confirmRowOpen = false">
          Cancel
        </button>
        <button class="ac-btn ac-btn-danger" (click)="doRemoveRow()">Remove</button>
      </div>
    </div>
  </div>
  <div class="ac-dialog-backdrop" *ngIf="showSuccess">
    <div class="ac-card-no-padding ac-dialog-panel-sm ac-dialog-success" role="dialog" aria-modal="true">
      <div class="ac-dialog-header ac-dialog-success-header">
        <span>Success</span>
        <button class="ac-dialog-close" (click)="closeSuccess()" aria-label="Close">
          Ã—
        </button>
      </div>
      <div class="ac-dialog-body">
        <p class="ac-dialog-success-text">
          {{ successMsg }}
        </p>
      </div>
      <div class="ac-dialog-footer">
        <button class="ac-btn ac-btn-primary" type="button" (click)="closeSuccess()">
          OK
        </button>
      </div>
    </div>
  </div>
</div>
